<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo MentorOps | Supabase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }

        :root {
            --tempo-blue: #2563EB;
            --tempo-dark: #111827;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://mifbpckstfwphkwtqksa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZmJwY2tzdGZ3cGhrd3Rxa3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzcyMDksImV4cCI6MjA4NjUxMzIwOX0.PDZwE9hII9kPOjrBeJAI8T28oetruK-ogFtKOICMlOQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Icons ---
        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const LayoutDashboard = (props) => <Icon {...props} path={<><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></>} />;
        const AlertCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />;
        const CreditCard = (props) => <Icon {...props} path={<><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></>} />;
        const Footprints = (props) => <Icon {...props} path={<><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.25-.79 4.33-2 6"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.25.79 4.33 2 6"/><path d="M16 17h4"/><path d="M4 13h4"/></>} />;
        const Gift = (props) => <Icon {...props} path={<><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></>} />;
        const UserCheck = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} />;
        const Search = (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />;
        const CheckCircle2 = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const Filter = (props) => <Icon {...props} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const ClipboardList = (props) => <Icon {...props} path={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>} />;
        const MessageCircle = (props) => <Icon {...props} path={<><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const Edit = (props) => <Icon {...props} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></>} />;
        const Dice = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></>} />;
        const Plus = (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />;

        // --- Static Data ---
        const mentorList = [ "Noha Radwan", "Rashad Mohamed", "Emad Mohamed", "Mohamed Mounir" ];
        const associateList = [ "Ariath Piol", "Job James", "Lina Hesham", "Mohab Magdy", "Marwa Ahmed", "Ramadan Philip", "Aida Clement", "Hassan Khallaf", "Nada Ashraf", "Ruben Joseph", "Esraa Tarek Eroq", "Ahmed Abdelghany", "Nour Ayman", "Ashraf Essam", "Hala Ayman", "Rania Mohamed", "Salma Ahmed", "Marwan Hassan", "Osama M. Adam", "Marwan Zakaria", "Shahd Emad", "Ahmed Nasser abdelhakim" ];
        
        const auditAttributes = [
            { id: 'responsiveness', label: 'Responsiveness', weight: 10, desc: 'Measures how promptly and effectively the mentor responds to queries, guidance requests, or escalations.' },
            { id: 'professionalism', label: 'Professionalism', weight: 10, desc: 'Evaluates the mentor’s conduct, tone, and ability to maintain respectful, constructive, and supportive interactions.' },
            { id: 'clarity', label: 'Clarity', weight: 20, desc: 'Assesses the mentor’s ability to explain concepts, instructions, or feedback in a clear, concise, and understandable manner.' },
            { id: 'workflow', label: 'Workflow', weight: 20, desc: 'Reviews how well the mentor follows the correct workflow.' },
            { id: 'documentation', label: 'Documentation', weight: 10, desc: 'Examines the quality and consistency of documentation provided by the mentor, including notes, guides, or process updates.' },
            { id: 'resolution', label: 'Resolution', weight: 30, desc: 'Evaluates the mentor’s ability to help resolve issues, provide effective solutions, and close feedback loops efficiently.' }
        ];

        const quizModules = [
            { id: 'productExpert', title: 'Product Expert', desc: 'Is the associate able to demonstrate product expertise when queried by the customer?' },
            { id: 'processAwareness', title: 'Process Awareness', desc: 'Comprehending the process, rather than just adhering to its procedures.' },
            { id: 'communication', title: 'Communication', desc: 'Did the associate reflect effectiveness in communicating with the customer?' },
            { id: 'customerConcern', title: 'Able to identify customer Concern', desc: 'Did the associate comprehend all of the customer\'s concerns effectively?' },
            { id: 'fcr', title: 'FCR', desc: 'Was the associate able to anticipate all the customer questions?' }
        ];

        const HIP_HIERARCHY = {
            "Move": {
                "Order Modifications": ["Change Color", "Change Address", "Upgrade", "Downgrade", "Core Modification", "Order Receipt", "Mispick"],
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Missing Items", "Damaged Unit", "DOA"],
                "Billing & Membership": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute"],
                "Payments & Offers": ["HSA/FSA", "Invoice Request", "Bundled Inquiry", "Bundled Code Applied", "Personal Training"],
                "Account Management": ["Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login", "Current Promotions"],
                "Content": ["Challenges", "Workout History", "Feedback", "Training Plan Inquiry", "Baseline Issue"],
                "Prospective": ["Purchasing Info", "Membership Requirements", "HSA/FSA Inquiry", "Referral Program", "Holiday Promotion", "Current Offers"]
            },
            "Core": {
                "Product Support": ["Android Support", "Connection Unstable", "Hardware Connection Issue", "Start Class Error", "Incomplete Class"],
                "Hardware Support": ["Physical Damage", "Standalone Availability", "Standalone Delivery Delay"],
                "Shipping": ["Missing Items", "Delayed Accessories"]
            },
            "Studio": {
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Missing Items", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Damaged Unit", "DOA"],
                "Order Mods": ["Change Address", "Order Receipt", "Mispick"],
                "Billing": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Refund Inquiry"]
            },
            "Accessory": {
                "Purchasing": ["Cabinet Info", "Core Standalone Availability", "Kettlebell Availability"],
                "Delivery": ["Core Standalone Delay", "Plates Delivery Delay", "Barbell Delivery Delay", "Apparel Missing Item"],
                "Quality & Damage": ["Collar Damage", "Quick Lock Damage", "Competition Plates Damage", "Barbell Damage", "Workout Mat Damage"],
                "Setup & Specs": ["Kettlebell Setup", "Folding Rack Setup", "Folding Rack Lock Issue", "Collar Specs", "HRM Replacement", "HRM Charger Replacement"]
            },
            "Membership": {
                "Account Management": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute", "Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login"]
            }
        };

        const categories = {
            disputes: { label: 'Disputes', icon: AlertCircle, color: 'red', fields: ['customerName', 'customerEmail', 'disputeAmount', 'disputeDate', 'disputeReason', 'disputedProduct', 'disputeLink', 'resolution'] },
            pending_subs: { label: 'Pending Subs', icon: CreditCard, color: 'blue', fields: ['customerName', 'customerEmail', 'pendingReason', 'resolution'] },
            floorwalker: { label: 'FloorWalker', icon: Footprints, color: 'amber', fields: ['associateName', 'ticketLink', 'reasonForSupport', 'requestType', 'validRequest', 'invalidReason', 'slackLink', 'comment'] },
            hip_request: { label: 'HIP Request', icon: MessageCircle, color: 'teal', fields: ['associateName', 'ticketLink', 'slackLink', 'validHip', 'invalidReason', 'hipProduct', 'hipCategory', 'hipRequestType'] },
            weekly_quiz: { label: 'Weekly Quiz', icon: ClipboardList, color: 'cyan', fields: ['associateName', 'associateEmail', 'date', 'correctionModule'] },
            duplicate_iap: { label: 'Duplicate IAP', icon: FileText, color: 'indigo', fields: ['customerEmail', 'emailSent', 'subscriptionStatus'] },
            surprise_delight: { label: 'Surprise & Delight', icon: Gift, color: 'purple', fields: ['associateName', 'team', 'customerName', 'customerEmail', 'productType', 'ticketUrl', 'surpriseAndDelightReason', 'surpriseAndDelightType', 'amount', 'date', 'notes'] },
            mentor_audit: { label: 'Mentor Audit', icon: UserCheck, color: 'emerald', fields: ['mentorName', 'hipLogReference', 'auditModule'] },
        };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>{children}</div>;
        const Badge = ({ children, color = "slate" }) => {
            const colors = { slate: "bg-slate-100 text-slate-700", red: "bg-rose-100 text-rose-700", blue: "bg-blue-100 text-blue-700", green: "bg-emerald-100 text-emerald-700", amber: "bg-amber-100 text-amber-700", teal: "bg-teal-100 text-teal-700", cyan: "bg-cyan-100 text-cyan-700", purple: "bg-purple-100 text-purple-700", emerald: "bg-emerald-100 text-emerald-700" };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[color] || colors.slate}`}>{children}</span>;
        };

        function MentorOpsCenter() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [newTaskType, setNewTaskType] = useState('disputes');
            const [formData, setFormData] = useState({});
            
            // Flexible Lists State
            const [customOptions, setCustomOptions] = useState({
                pendingReason: ["Not delivered", "Delivered but not updated.", "Returned or canceled order"],
                disputeReason: ["Subscription claim", "Unauthorized purchase", "Defective product", "Credit not processed"],
                reasonForSupport: ["SOP Guidance", "Process education", "System Navigation"],
                requestType: ["Membership", "Billing", "Account Access", "Technical Support", "Order Support"],
                invalidReason: ["Already documented in SOP", "Training issue", "Incomplete info", "Duplicate request", "Not an Ops matter"],
                team: ["T1", "Social Media", "Mentor", "Order Support", "Product Support"],
                productType: ["Studio", "Move", "Core", "Accessories", "Membership"],
                surpriseAndDelightReason: [
                    "Delivery ETA (Within the lead time)", "Customer Ordered Wrong color by mistake", 
                    "Technical issues that was resolved by the normal TS", "Bundle Accessory Delay", 
                    "SRLimited access after cancelation", "Missing a discount/promo", 
                    "Complains about compatibility", "Form Feedback/Weight Recommendations", 
                    "Android Health compatibility", "Lack of features", "Lack of new content", 
                    "Accessory Support", "Leaderboard"
                ],
                surpriseAndDelightType: [
                    "Water Bottle", "Tempo Sweat Towel", "Yoga Block", "Yoga Strap", "Recovery Roller", 
                    "Gift Box", "axis-performance-hat-black", "axis-performance-hat-slate-grey", 
                    "tempo-workout-gloves", "motive-training-tee-black", "motive-training-tee-1", 
                    "Pinnacle Knit Beanie"
                ]
            });

            // Logs Filters State
            const [showLogFilters, setShowLogFilters] = useState(false);
            const [logFilters, setLogFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });

            // Pagination & Reports
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;
            const [reportFilters, setReportFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });
            const [generatedReport, setGeneratedReport] = useState(null);

            const [customInputTarget, setCustomInputTarget] = useState(null);

            const fetchTasks = async () => {
                setConnectionStatus('connecting');
                const { data, error } = await supabase.from('tasks').select('*').order('date', { ascending: false });
                if (!error) { setTasks(data || []); setConnectionStatus('online'); }
                else { setConnectionStatus('offline'); }
            };

            useEffect(() => {
                fetchTasks();
                const channel = supabase.channel('tasks-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, fetchTasks).subscribe();
                return () => supabase.removeChannel(channel);
            }, []);

            const handleAddTask = async (e) => {
                e.preventDefault();

                // --- GLOBAL MANDATORY FIELD VALIDATION ---
                const requiredFields = categories[newTaskType].fields;
                const missingFields = [];

                requiredFields.forEach(field => {
                    if (field === 'correctionModule') {
                        const scores = formData.quizScores || {};
                        quizModules.forEach(m => { if (!scores[m.id]) missingFields.push(`Quiz Rating: ${m.title}`); });
                        return;
                    }
                    if (field === 'auditModule') {
                        const scores = formData.auditScores || {};
                        auditAttributes.forEach(a => { if (!scores[a.id]) missingFields.push(`Audit Attribute: ${a.label}`); });
                        return;
                    }
                    if (field === 'invalidReason') {
                        const isFwInvalid = newTaskType === 'floorwalker' && formData.validRequest === 'No';
                        const isHipInvalid = newTaskType === 'hip_request' && formData.validHip === 'No';
                        if ((isFwInvalid || isHipInvalid) && !formData[field]) missingFields.push("Reason for Invalid Request");
                        return;
                    }
                    if (newTaskType === 'hip_request' && ['hipProduct', 'hipCategory', 'hipRequestType'].includes(field) && !formData[field]) {
                        missingFields.push(field.replace('hip', 'HIP ').replace(/([A-Z])/g, ' $1'));
                        return;
                    }
                    if (['hipProduct', 'hipCategory', 'hipRequestType', 'correctionModule', 'auditModule', 'invalidReason'].includes(field)) return;
                    if (!formData[field] || formData[field].toString().trim() === '') missingFields.push(field.replace(/([A-Z])/g, ' $1').trim());
                });

                if (missingFields.length > 0) {
                    alert(`To save record, all entries must be filled:\n\n- ${missingFields.join('\n- ')}`);
                    return;
                }

                let status = formData.status || 'Pending';
                if (!editingTaskId) {
                    if (newTaskType === 'disputes' && (formData.resolution === 'Won' || formData.resolution === 'Lost')) status = 'Resolved';
                    else if (newTaskType === 'pending_subs' && (formData.resolution === 'Activated' || formData.resolution === 'Cancelled')) status = 'Resolved';
                    else if (['weekly_quiz', 'hip_request', 'duplicate_iap', 'mentor_audit'].includes(newTaskType)) status = 'Resolved';
                }

                const details = { ...formData };
                delete details.status;

                if (!editingTaskId) {
                    if (newTaskType === 'floorwalker') details.mentorName = currentUser;
                }

                const taskData = {
                    type: newTaskType,
                    title: `${categories[newTaskType].label} Log`,
                    agent: currentUser,
                    status: status,
                    details: details
                };

                if (!editingTaskId) { taskData.date = new Date().toISOString(); }

                const { error } = editingTaskId 
                    ? await supabase.from('tasks').update(taskData).eq('id', editingTaskId)
                    : await supabase.from('tasks').insert([taskData]);

                if (error) alert("Error: " + error.message);
                else { setIsFormOpen(false); setFormData({}); setEditingTaskId(null); }
            };

            const handleEditTask = (task) => {
                setNewTaskType(task.type);
                setFormData({ ...(task.details || {}), status: task.status });
                setEditingTaskId(task.id);
                setIsFormOpen(true);
            };

            const handleInputChange = (field, value) => {
                if (value === 'ADD_NEW_CUSTOM') setCustomInputTarget(field);
                else { setFormData(prev => ({ ...prev, [field]: value })); setCustomInputTarget(null); }
            };

            const handleAddCustomValue = (field, newValue) => {
                if (!newValue.trim()) return;
                setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), newValue] }));
                handleInputChange(field, newValue);
            };

            const handleAuditScore = (attrId, achieved) => {
                const scores = { ...(formData.auditScores || {}) };
                scores[attrId] = achieved;
                let total = 0;
                auditAttributes.forEach(attr => { if (scores[attr.id] === 'Yes') total += attr.weight; });
                setFormData(prev => ({ ...prev, auditScores: scores, overallAuditScore: total }));
            };

            const handleQuizScore = (moduleId, score) => {
                const scores = { ...(formData.quizScores || {}), [moduleId]: parseInt(score) };
                const values = Object.values(scores);
                const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '0.0';
                setFormData(prev => ({ ...prev, quizScores: scores, overallScore: avg }));
            };

            const pickRandomHIP = () => {
                const hipLogs = tasks.filter(t => t.type === 'hip_request');
                if (hipLogs.length === 0) { alert("No HIP logs available to audit yet."); return; }
                const random = hipLogs[Math.floor(Math.random() * hipLogs.length)];
                setFormData(prev => ({ ...prev, hipLogReference: random.id, auditedTicket: random.details.ticketLink, mentorName: random.agent }));
            };

            const stats = useMemo(() => ({
                total: tasks.length,
                pending: tasks.filter(t => t.status === 'Pending').length,
                resolved: tasks.filter(t => ['Resolved', 'Activated', 'Won'].includes(t.status)).length,
                byType: Object.keys(categories).reduce((acc, key) => { acc[key] = tasks.filter(t => t.type === key).length; return acc; }, {})
            }), [tasks]);

            const filteredLogs = tasks.filter(t => {
                const matchesSearch = (categories[t.type]?.label || '').toLowerCase().includes(searchTerm.toLowerCase()) || (t.agent || '').toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = logFilters.category === 'all' || t.type === logFilters.category;
                const matchesAgent = logFilters.agent === 'all' || t.agent === logFilters.agent;
                let matchesDate = true;
                if (logFilters.startDate) matchesDate = matchesDate && new Date(t.date) >= new Date(logFilters.startDate);
                if (logFilters.endDate) { const end = new Date(logFilters.endDate); end.setHours(23, 59, 59); matchesDate = matchesDate && new Date(t.date) <= end; }
                return matchesSearch && matchesCategory && matchesAgent && matchesDate;
            });

            const paginatedLogs = filteredLogs.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const handleGenerateReport = () => {
                let filtered = tasks;
                if (reportFilters.category !== 'all') filtered = filtered.filter(t => t.type === reportFilters.category);
                if (reportFilters.agent !== 'all') filtered = filtered.filter(t => t.agent === reportFilters.agent);
                if (reportFilters.startDate) filtered = filtered.filter(t => new Date(t.date) >= new Date(reportFilters.startDate));
                if (reportFilters.endDate) { const end = new Date(reportFilters.endDate); end.setHours(23,59,59); filtered = filtered.filter(t => new Date(t.date) <= end); }
                setGeneratedReport(filtered);
            };

            const downloadCSV = () => {
                if (!generatedReport) return;
                const headers = ['ID', 'Type', 'Owner', 'Status', 'Date', 'Details'];
                const csv = [headers.join(','), ...generatedReport.map(t => [t.id, t.type, t.agent, t.status, new Date(t.date).toLocaleDateString(), JSON.stringify(t.details).replace(/,/g, ';')].join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'mentor_ops_report.csv'; a.click();
            };

            if (!currentUser) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
                        <Card className="p-8 max-w-md w-full text-center">
                            <div className="h-16 w-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                <User className="h-8 w-8" />
                            </div>
                            <h2 className="text-2xl font-bold mb-2">MentorOps Center</h2>
                            <p className="text-slate-500 mb-8">Select your identity to continue</p>
                            <select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" onChange={(e) => setCurrentUser(e.target.value)} defaultValue="">
                                <option value="" disabled>Select User...</option>
                                {mentorList.map(name => <option key={name} value={name}>{name}</option>)}
                            </select>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
                            <div className="flex items-center gap-3">
                                <h1 className="text-xl font-bold tracking-[0.2em] text-slate-900">TEMPO</h1>
                                <span className="h-6 w-px bg-slate-200" />
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Mentor Ops</span>
                            </div>
                            <nav className="flex gap-1">
                                {['dashboard', 'logs', 'reports'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${activeTab === tab ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        {tab.toUpperCase()}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-4">
                                <div className={`h-2 w-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500' : 'bg-rose-500 animate-pulse'}`} />
                                <div className="text-right hidden md:block">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase">Logged In</p>
                                    <p className="text-sm font-bold leading-none">{currentUser}</p>
                                </div>
                                <button onClick={() => setCurrentUser(null)} className="p-2 text-slate-400 hover:text-rose-500"><LogOut className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card className="p-6 bg-slate-900 text-white border-none shadow-xl">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Total Records</p>
                                        <h3 className="text-4xl font-bold">{stats.total}</h3>
                                    </Card>
                                    <Card className="p-6 border-l-4 border-l-rose-500">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Pending Follow-ups</p>
                                        <h3 className="text-4xl font-bold text-rose-600">{stats.pending}</h3>
                                    </Card>
                                    <Card className="p-6 border-l-4 border-l-emerald-500">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Resolved Today</p>
                                        <h3 className="text-4xl font-bold text-emerald-600">{stats.resolved}</h3>
                                    </Card>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                                    {Object.entries(categories).map(([key, cfg]) => (
                                        <button key={key} onClick={() => { setNewTaskType(key); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="p-4 bg-white border border-slate-200 rounded-xl text-center hover:shadow-md transition-all group">
                                            <div className={`h-10 w-10 mx-auto rounded-lg flex items-center justify-center mb-2 bg-${cfg.color}-100`}>
                                                {React.createElement(cfg.icon, { className: `h-5 w-5 text-${cfg.color}-600` })}
                                            </div>
                                            <p className="text-[10px] font-bold text-slate-500 uppercase">{cfg.label}</p>
                                            <p className="text-xl font-bold">{stats.byType[key]}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex flex-col md:flex-row gap-4 justify-between bg-white p-4 rounded-xl border border-slate-200">
                                    <div className="relative flex-1 max-w-md">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                                        <input type="text" placeholder="Search logs..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowLogFilters(!showLogFilters)} className={`flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium transition-colors ${showLogFilters ? 'bg-slate-100 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-50'}`}>
                                            <Filter className="h-4 w-4" /> Filters
                                        </button>
                                        <button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-100 hover:bg-blue-700">
                                            <Plus className="h-4 w-4" /> New Entry
                                        </button>
                                    </div>
                                </div>

                                {showLogFilters && (
                                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 animate-fade-in">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Category</label>
                                            <select className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.category} onChange={e => setLogFilters(f => ({...f, category: e.target.value}))}>
                                                <option value="all">All Types</option>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Owner</label>
                                            <select className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.agent} onChange={e => setLogFilters(f => ({...f, agent: e.target.value}))}>
                                                <option value="all">All Mentors</option>
                                                {mentorList.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Start Date</label>
                                            <input type="date" className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.startDate} onChange={e => setLogFilters(f => ({...f, startDate: e.target.value}))} />
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">End Date</label>
                                            <input type="date" className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.endDate} onChange={e => setLogFilters(f => ({...f, endDate: e.target.value}))} />
                                        </div>
                                    </div>
                                )}

                                <Card className="overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="px-6 py-4">Category</th>
                                                <th className="px-6 py-4">Agent</th>
                                                <th className="px-6 py-4">Status</th>
                                                <th className="px-6 py-4">Date</th>
                                                <th className="px-6 py-4 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {paginatedLogs.map(task => (
                                                <tr key={task.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`h-8 w-8 rounded-lg flex items-center justify-center bg-${categories[task.type]?.color}-100`}>
                                                                {React.createElement(categories[task.type]?.icon || AlertCircle, { className: `h-4 w-4 text-${categories[task.type]?.color}-600` })}
                                                            </div>
                                                            <span className="font-medium text-slate-700">{categories[task.type]?.label}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 text-slate-600">{task.agent}</td>
                                                    <td className="px-6 py-4">
                                                        <Badge color={task.status === 'Pending' ? 'amber' : (['Resolved', 'Won', 'Activated'].includes(task.status) ? 'green' : 'slate')}>
                                                            {task.status}
                                                        </Badge>
                                                    </td>
                                                    <td className="px-6 py-4 text-slate-400">{new Date(task.date).toLocaleDateString()}</td>
                                                    <td className="px-6 py-4 text-right">
                                                        <button onClick={() => handleEditTask(task)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"><Edit className="h-4 w-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="p-4 bg-slate-50 flex justify-between items-center text-xs font-bold text-slate-500">
                                        <span>Showing {(currentPage-1)*itemsPerPage+1} to {Math.min(currentPage*itemsPerPage, filteredLogs.length)} of {filteredLogs.length}</span>
                                        <div className="flex gap-2">
                                            <button disabled={currentPage === 1} onClick={() => setCurrentPage(p => p - 1)} className="px-3 py-1 bg-white border rounded hover:bg-slate-100 disabled:opacity-50">Prev</button>
                                            <button disabled={currentPage * itemsPerPage >= filteredLogs.length} onClick={() => setCurrentPage(p => p + 1)} className="px-3 py-1 bg-white border rounded hover:bg-slate-100 disabled:opacity-50">Next</button>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className="space-y-6 animate-fade-in">
                                <Card className="p-6 space-y-4">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="h-8 w-8 bg-blue-100 rounded-lg flex items-center justify-center"><Filter className="h-5 w-5 text-blue-600" /></div>
                                        <h2 className="text-lg font-bold">Report Generator</h2>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Category</label>
                                            <select className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm outline-none" value={reportFilters.category} onChange={e => setReportFilters(f => ({ ...f, category: e.target.value }))}>
                                                <option value="all">All Types</option>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Mentor</label>
                                            <select className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm outline-none" value={reportFilters.agent} onChange={e => setReportFilters(f => ({ ...f, agent: e.target.value }))}>
                                                <option value="all">All Mentors</option>
                                                {mentorList.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Start Date</label>
                                            <input type="date" className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm outline-none" value={reportFilters.startDate} onChange={e => setReportFilters(f => ({ ...f, startDate: e.target.value }))} />
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">End Date</label>
                                            <input type="date" className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm outline-none" value={reportFilters.endDate} onChange={e => setReportFilters(f => ({ ...f, endDate: e.target.value }))} />
                                        </div>
                                    </div>
                                    <div className="flex justify-end pt-2">
                                        <button onClick={handleGenerateReport} className="px-6 py-2.5 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 shadow-lg">GENERATE REPORT</button>
                                    </div>
                                </Card>
                                {generatedReport && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-bold text-lg">Results ({generatedReport.length})</h3>
                                            <button onClick={downloadCSV} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 font-bold rounded-lg text-sm hover:bg-slate-50">
                                                <Download className="h-4 w-4" /> Export CSV
                                            </button>
                                        </div>
                                        <Card className="overflow-x-auto">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="px-6 py-3">Type</th>
                                                        <th className="px-6 py-3">Agent</th>
                                                        <th className="px-6 py-3">Date</th>
                                                        <th className="px-6 py-3 text-right">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {generatedReport.map(r => (
                                                        <tr key={r.id} className="hover:bg-slate-50">
                                                            <td className="px-6 py-4 font-medium">{categories[r.type]?.label}</td>
                                                            <td className="px-6 py-4">{r.agent}</td>
                                                            <td className="px-6 py-4 text-slate-400">{new Date(r.date).toLocaleDateString()}</td>
                                                            <td className="px-6 py-4 text-right"><Badge color={r.status === 'Pending' ? 'amber' : 'green'}>{r.status}</Badge></td>
                                                        </tr>
                                                    ))}
                                                    {generatedReport.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No records found matching filters.</td></tr>}
                                                </tbody>
                                            </table>
                                        </Card>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {isFormOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={() => setIsFormOpen(false)} />
                            <div className="relative w-full max-w-md bg-white h-full shadow-2xl p-8 overflow-y-auto animate-slide-in-right">
                                <div className="flex justify-between items-center mb-8">
                                    <div className="flex items-center gap-3">
                                        <div className={`p-2 rounded-lg bg-${categories[newTaskType].color}-100`}>
                                            {React.createElement(categories[newTaskType].icon, { className: `h-6 w-6 text-${categories[newTaskType].color}-600` })}
                                        </div>
                                        <h2 className="text-2xl font-black italic">{editingTaskId ? 'EDIT' : 'NEW'} {categories[newTaskType].label.toUpperCase()}</h2>
                                    </div>
                                    <button onClick={() => setIsFormOpen(false)} className="text-slate-400 hover:text-slate-600 uppercase text-[10px] font-black">Close</button>
                                </div>
                                <form onSubmit={handleAddTask} className="space-y-6">
                                    {!editingTaskId && (
                                        <div><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Change Category</label>
                                            <select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold" value={newTaskType} onChange={e => { setNewTaskType(e.target.value); setFormData({}); }}>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                    )}

                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                                        {categories[newTaskType].fields.map(field => {
                                            const isValidNo = (newTaskType === 'floorwalker' && formData.validRequest === 'No') || 
                                                              (newTaskType === 'hip_request' && formData.validHip === 'No');
                                            
                                            if (field === 'invalidReason' && !isValidNo) return null;

                                            // Audit Module Logic
                                            if (field === 'auditModule') return (
                                                <div key={field} className="space-y-4 pt-2">
                                                    <div className="flex justify-between items-center"><h3 className="text-[10px] font-black text-slate-400 uppercase">Scoring Criteria</h3><Badge color="green">Score: {formData.overallAuditScore || '0'}%</Badge></div>
                                                    {auditAttributes.map(attr => (
                                                        <div key={attr.id} className="bg-white p-4 rounded-xl border border-slate-200">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div>
                                                                    <p className="font-bold text-sm">{attr.label} ({attr.weight}%)</p>
                                                                    <p className="text-[10px] text-slate-400">{attr.desc}</p>
                                                                </div>
                                                                <div className="flex gap-1">
                                                                    <button type="button" onClick={() => handleAuditScore(attr.id, 'Yes')} className={`px-3 py-1 rounded-md text-[10px] font-bold border ${formData.auditScores?.[attr.id] === 'Yes' ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-200 text-slate-400'}`}>YES</button>
                                                                    <button type="button" onClick={() => handleAuditScore(attr.id, 'No')} className={`px-3 py-1 rounded-md text-[10px] font-bold border ${formData.auditScores?.[attr.id] === 'No' ? 'bg-rose-500 border-rose-500 text-white' : 'bg-white border-slate-200 text-slate-400'}`}>NO</button>
                                                                </div>
                                                            </div>
                                                            <input type="text" placeholder="Comment..." className="w-full p-2 bg-slate-50 border-b text-[11px] outline-none" onChange={e => setFormData(prev => ({...prev, auditComments: {...(prev.auditComments || {}), [attr.id]: e.target.value}}))} value={formData.auditComments?.[attr.id] || ''} />
                                                        </div>
                                                    ))}
                                                </div>
                                            );

                                            // Correction Module Logic
                                            if (field === 'correctionModule') return (
                                                <div key={field} className="space-y-6 pt-2">
                                                    <div className="flex justify-between items-center"><h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Correction Module</h3><Badge color="cyan">AVG: {formData.overallScore || '0.0'}</Badge></div>
                                                    {quizModules.map(m => (
                                                        <div key={m.id} className="bg-white p-4 rounded-xl border border-slate-200">
                                                            <p className="font-bold text-sm mb-1">{m.title}</p>
                                                            <p className="text-[10px] text-slate-400 mb-4">{m.desc}</p>
                                                            <div className="flex justify-between items-center mb-4">
                                                                <span className="text-[10px] font-bold text-slate-300">1</span>
                                                                <div className="flex gap-2">
                                                                    {[1, 2, 3, 4, 5].map(s => (
                                                                        <button key={s} type="button" onClick={() => handleQuizScore(m.id, s)} className={`w-8 h-8 rounded-full border-2 text-xs font-bold transition-all ${formData.quizScores?.[m.id] === s ? 'bg-cyan-500 border-cyan-500 text-white shadow-lg shadow-cyan-100' : 'bg-white border-slate-200 text-slate-400'}`}>{s}</button>
                                                                    ))}
                                                                </div>
                                                                <span className="text-[10px] font-bold text-slate-300">5</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            );

                                            if (field === 'hipLogReference' && newTaskType === 'mentor_audit') return (
                                                <div key={field} className="pt-2">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Audit Target (Randomly Selected)</label>
                                                    <div className="flex gap-2">
                                                        <div className="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-sm font-medium">
                                                            {formData.auditedTicket ? `Ticket: ${formData.auditedTicket}` : 'No Log Picked'}
                                                        </div>
                                                        <button type="button" onClick={pickRandomHIP} className="p-3 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-200"><Dice className="h-5 w-5" /></button>
                                                    </div>
                                                </div>
                                            );

                                            // HIP dependent dropdown logic (3 Levels)
                                            if (newTaskType === 'hip_request' && field === 'hipProduct') {
                                                return (
                                                    <div key={field}>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Product</label>
                                                        <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" value={formData.hipProduct || ''} onChange={e => setFormData(prev => ({ ...prev, hipProduct: e.target.value, hipCategory: '', hipRequestType: '' }))}>
                                                            <option value="">Select Product...</option>
                                                            {Object.keys(HIP_HIERARCHY).map(k => <option key={k} value={k}>{k}</option>)}
                                                        </select>
                                                    </div>
                                                );
                                            }

                                            if (newTaskType === 'hip_request' && field === 'hipCategory') {
                                                const catOptions = formData.hipProduct ? Object.keys(HIP_HIERARCHY[formData.hipProduct] || {}) : [];
                                                return (
                                                    <div key={field}>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Category</label>
                                                        <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" disabled={!formData.hipProduct} value={formData.hipCategory || ''} onChange={e => setFormData(prev => ({ ...prev, hipCategory: e.target.value, hipRequestType: '' }))}>
                                                            <option value="">Select Category...</option>
                                                            {catOptions.map(c => <option key={c} value={c}>{c}</option>)}
                                                        </select>
                                                    </div>
                                                );
                                            }

                                            if (newTaskType === 'hip_request' && field === 'hipRequestType') {
                                                const options = (formData.hipProduct && formData.hipCategory) ? HIP_HIERARCHY[formData.hipProduct][formData.hipCategory] : [];
                                                return (
                                                    <div key={field}>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Request Type</label>
                                                        <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" disabled={!formData.hipCategory} value={formData.hipRequestType || ''} onChange={e => handleInputChange(field, e.target.value)}>
                                                            <option value="">Select Request Type...</option>
                                                            {options.map(o => <option key={o} value={o}>{o}</option>)}
                                                        </select>
                                                    </div>
                                                );
                                            }

                                            const isDropdown = ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'requestType', 'validHip', 'validRequest', 'subscriptionStatus', 'emailSent', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason'].includes(field);
                                            
                                            return (
                                                <div key={field}>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">{field.replace(/([A-Z])/g, ' $1')}</label>
                                                    {isDropdown ? (
                                                        <div className="space-y-2">
                                                            <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)}>
                                                                <option value="">Select...</option>
                                                                {(field === 'associateName' || field === 'associateEmail') && associateList.map(a => <option key={a} value={a}>{a}</option>)}
                                                                {field === 'mentorName' && ["Noha Radwan", "Rashad Mohamed", "Emad Mohamed"].map(a => <option key={a} value={a}>{a}</option>)}
                                                                {customOptions[field]?.map(o => <option key={o} value={o}>{o}</option>)}
                                                                <option value="ADD_NEW_CUSTOM" className="text-blue-600 font-bold">+ Add New Item...</option>
                                                            </select>
                                                            {customInputTarget === field && (
                                                                <div className="flex gap-2 animate-fade-in">
                                                                    <input type="text" id={`custom-${field}`} placeholder={`Enter new ${field}...`} className="flex-1 p-2 text-xs border rounded-lg outline-none" />
                                                                    <button type="button" onClick={() => handleAddCustomValue(field, document.getElementById(`custom-${field}`).value)} className="px-4 py-2 bg-blue-600 text-white text-[10px] font-bold rounded-lg uppercase">Add</button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <input type={field.toLowerCase().includes('date') ? 'date' : 'text'} className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {!['weekly_quiz', 'hip_request', 'duplicate_iap', 'mentor_audit'].includes(newTaskType) && (
                                        <div><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Record Status</label>
                                            <select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold" value={formData.status || 'Pending'} onChange={e => handleInputChange('status', e.target.value)}>
                                                <option value="Pending">Pending</option>
                                                <option value="Resolved">Resolved</option>
                                                <option value="In Progress">In Progress</option>
                                            </select>
                                        </div>
                                    )}

                                    <button type="submit" className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all uppercase tracking-widest">
                                        {editingTaskId ? 'Update Log' : 'Save Record'}
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MentorOpsCenter />);
    </script>
</body>
</html>
