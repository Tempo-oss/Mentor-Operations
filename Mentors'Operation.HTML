<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo MentorOps | Supabase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }

        :root {
            --tempo-blue: #2563EB;
            --tempo-dark: #111827;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        canvas {
            max-width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://mifbpckstfwphkwtqksa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZmJwY2tzdGZ3cGhrd3Rxa3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzcyMDksImV4cCI6MjA4NjUxMzIwOX0.PDZwE9hII9kPOjrBeJAI8T28oetruK-ogFtKOICMlOQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Icon Components ---
        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const LayoutDashboard = (props) => <Icon {...props} path={<React.Fragment><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></React.Fragment>} />;
        const AlertCircle = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>} />;
        const CreditCard = (props) => <Icon {...props} path={<React.Fragment><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></React.Fragment>} />;
        const Footprints = (props) => <Icon {...props} path={<React.Fragment><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.25-.79 4.33-2 6"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.25.79 4.33 2 6"/><path d="M16 17h4"/><path d="M4 13h4"/></React.Fragment>} />;
        const Gift = (props) => <Icon {...props} path={<React.Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></React.Fragment>} />;
        const UserCheck = (props) => <Icon {...props} path={<React.Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></React.Fragment>} />;
        const FileText = (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></React.Fragment>} />;
        const Search = (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>} />;
        const Edit = (props) => <Icon {...props} path={<React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></React.Fragment>} />;
        const Dice = (props) => <Icon {...props} path={<React.Fragment><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></React.Fragment>} />;
        const Plus = (props) => <Icon {...props} path={<React.Fragment><path d="M5 12h14"/><path d="M12 5v14"/></React.Fragment>} />;
        const BarChart3 = (props) => <Icon {...props} path={<React.Fragment><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></React.Fragment>} />;
        const MessageCircle = (props) => <Icon {...props} path={<React.Fragment><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></React.Fragment>} />;
        const Clock = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>} />;
        const CheckCircle2 = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></React.Fragment>} />;
        const Filter = (props) => <Icon {...props} path={<React.Fragment><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></React.Fragment>} />;
        const LogOut = (props) => <Icon {...props} path={<React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></React.Fragment>} />;
        const Download = (props) => <Icon {...props} path={<React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></React.Fragment>} />;
        const ClipboardList = (props) => <Icon {...props} path={<React.Fragment><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></React.Fragment>} />;
        const User = (props) => <Icon {...props} path={<React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>} />;

        // --- Common Components ---
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>{children}</div>;
        const Badge = ({ children, color = "slate" }) => {
            const colors = { 
                slate: "bg-slate-100 text-slate-700", red: "bg-rose-100 text-rose-700", blue: "bg-blue-100 text-blue-700", green: "bg-emerald-100 text-emerald-700", 
                amber: "bg-amber-100 text-amber-700", teal: "bg-teal-100 text-teal-700", cyan: "bg-cyan-100 text-cyan-700", purple: "bg-purple-100 text-purple-700", 
                emerald: "bg-emerald-100 text-emerald-700" 
            };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[color] || colors.slate}`}>{children}</span>;
        };

        // --- Static Data ---
        const mentorList = [ "Noha Radwan", "Rashad Mohamed", "Emad Mohamed", "Mohamed Mounir" ];
        const associateList = [ "Ariath Piol", "Job James", "Lina Hesham", "Mohab Magdy", "Marwa Ahmed", "Ramadan Philip", "Aida Clement", "Hassan Khallaf", "Nada Ashraf", "Ruben Joseph", "Esraa Tarek Eroq", "Ahmed Abdelghany", "Nour Ayman", "Ashraf Essam", "Hala Ayman", "Rania Mohamed", "Salma Ahmed", "Marwan Hassan", "Osama M. Adam", "Marwan Zakaria", "Shahd Emad", "Ahmed Nasser abdelhakim" ];
        
        const auditAttributes = [
            { id: 'responsiveness', label: 'Responsiveness', weight: 10, desc: 'Measures promptly mentor responds.' },
            { id: 'professionalism', label: 'Professionalism', weight: 10, desc: 'Mentor conduct and supportive interactions.' },
            { id: 'clarity', label: 'Clarity', weight: 20, desc: 'Assess ability to explain concepts/instructions clearly.' },
            { id: 'workflow', label: 'Workflow', weight: 20, desc: 'Reviews correct workflow usage.' },
            { id: 'documentation', label: 'Documentation', weight: 10, desc: 'Quality and consistency of notes.' },
            { id: 'resolution', label: 'Resolution', weight: 30, desc: 'Effective solutions and efficient closure.' }
        ];

        const quizModules = [
            { id: 'productExpert', title: 'Product Expert', desc: 'demonstrate product expertise when queried?' },
            { id: 'processAwareness', title: 'Process Awareness', desc: 'Comprehending process vs adhering to procedures.' },
            { id: 'communication', title: 'Communication', desc: 'Reflect effectiveness in communicating.' },
            { id: 'customerConcern', title: 'Identify customer Concern', desc: 'Comprehend all concerns effectively?' },
            { id: 'fcr', title: 'FCR', desc: 'Was the associate able to anticipate all questions?' }
        ];

        const HIP_HIERARCHY = {
            "Move": {
                "Order Modifications": ["Change Color", "Change Address", "Upgrade", "Downgrade", "Core Modification", "Order Receipt", "Mispick"],
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Missing Items", "Damaged Unit", "DOA"],
                "Billing & Membership": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute"],
                "Payments & Offers": ["HSA/FSA", "Invoice Request", "Bundled Inquiry", "Bundled Code Applied", "Personal Training"],
                "Account Management": ["Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login", "Current Promotions"],
                "Content": ["Challenges", "Workout History", "Feedback", "Training Plan Inquiry", "Baseline Issue"],
                "Prospective": ["Purchasing Info", "Membership Requirements", "HSA/FSA Inquiry", "Referral Program", "Holiday Promotion", "Current Offers"]
            },
            "Core": {
                "Product Support": ["Android Support", "Connection Unstable", "Hardware Connection Issue", "Start Class Error", "Incomplete Class"],
                "Hardware Support": ["Physical Damage", "Standalone Availability", "Standalone Delivery Delay"],
                "Shipping": ["Missing Items", "Delayed Accessories"]
            },
            "Studio": {
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Missing Items", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Damaged Unit", "DOA"],
                "Order Mods": ["Change Address", "Order Receipt", "Mispick"],
                "Billing": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Refund Inquiry"]
            },
            "Accessory": {
                "Purchasing": ["Cabinet Info", "Core Standalone Availability", "Kettlebell Availability"],
                "Delivery": ["Core Standalone Delay", "Plates Delivery Delay", "Barbell Delivery Delay", "Apparel Missing Item"],
                "Quality & Damage": ["Collar Damage", "Quick Lock Damage", "Competition Plates Damage", "Barbell Damage", "Workout Mat Damage"],
                "Setup & Specs": ["Kettlebell Setup", "Folding Rack Setup", "Folding Rack Lock Issue", "Collar Specs", "HRM Replacement", "HRM Charger Replacement"]
            },
            "Membership": {
                "Account Management": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute", "Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login"]
            }
        };

        const categories = {
            disputes: { label: 'Disputes', icon: AlertCircle, color: 'red', fields: ['customerName', 'customerEmail', 'disputeAmount', 'disputeDate', 'disputeReason', 'disputedProduct', 'disputeLink', 'resolution'] },
            pending_subs: { label: 'Pending Subs', icon: CreditCard, color: 'blue', fields: ['customerName', 'customerEmail', 'pendingReason', 'resolution'] },
            floorwalker: { label: 'FloorWalker', icon: Footprints, color: 'amber', fields: ['associateName', 'ticketLink', 'reasonForSupport', 'requestType', 'validRequest', 'invalidReason', 'slackLink', 'comment'] },
            hip_request: { label: 'HIP Request', icon: MessageCircle, color: 'teal', fields: ['associateName', 'ticketLink', 'slackLink', 'validHip', 'invalidReason', 'hipProduct', 'hipCategory', 'hipRequestType'] },
            weekly_quiz: { label: 'Weekly Quiz', icon: ClipboardList, color: 'cyan', fields: ['associateName', 'associateEmail', 'date', 'correctionModule'] },
            duplicate_iap: { label: 'Duplicate IAP', icon: FileText, color: 'indigo', fields: ['customerEmail', 'emailSent', 'subscriptionStatus'] },
            surprise_delight: { label: 'Surprise & Delight', icon: Gift, color: 'purple', fields: ['associateName', 'team', 'customerName', 'customerEmail', 'productType', 'ticketUrl', 'surpriseAndDelightReason', 'surpriseAndDelightType', 'amount', 'date', 'notes'] },
            mentor_audit: { label: 'Mentor Audit', icon: UserCheck, color: 'emerald', fields: ['mentorName', 'hipLogReference', 'auditModule'] },
        };

        function MentorOpsCenter() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [newTaskType, setNewTaskType] = useState('disputes');
            const [formData, setFormData] = useState({});
            
            // Flexible Lists State with Discovery
            const [customOptions, setCustomOptions] = useState({
                pendingReason: ["Not delivered", "Delivered but not updated.", "Returned or canceled order"],
                disputeReason: ["Subscription claim", "Unauthorized purchase", "Defective product", "Credit not processed", "Fraud", "Subscription Cancelled", "Product Unacceptable"],
                reasonForSupport: ["SOP Guidance", "Process education", "System Navigation"],
                requestType: ["Membership", "Billing", "Account Access", "Technical Support", "Order Support"],
                invalidReason: ["Already documented in SOP", "Training issue", "Incomplete info", "Duplicate request", "Not an Ops matter"],
                team: ["T1", "Social Media", "Mentor", "Order Support", "Product Support"],
                productType: ["Studio", "Move", "Core", "Accessories", "Membership"],
                disputedProduct: ["Move", "Core", "Membership", "Accessories"],
                surpriseAndDelightReason: [
                    "Delivery ETA (Within the lead time)", "Customer Ordered Wrong color by mistake", 
                    "Technical issues that was resolved by the normal TS", "Bundle Accessory Delay", 
                    "SRLimited access after cancelation", "Missing a discount/promo", 
                    "Complains about compatibility", "Form Feedback/Weight Recommendations", 
                    "Android Health compatibility", "Lack of features", "Lack of new content", 
                    "Accessory Support", "Leaderboard"
                ],
                surpriseAndDelightType: [
                    "Water Bottle", "Tempo Sweat Towel", "Yoga Block", "Yoga Strap", "Recovery Roller", 
                    "Gift Box", "axis-performance-hat-black", "axis-performance-hat-slate-grey", 
                    "tempo-workout-gloves", "motive-training-tee-black", "motive-training-tee-1", 
                    "Pinnacle Knit Beanie"
                ],
                validRequest: ["Yes", "No"],
                validHip: ["Yes", "No"],
                emailSent: ["Yes", "No"],
                subscriptionStatus: ["Active", "Cancelled"]
            });

            // Pagination State
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            // Analytics State
            const [analyticsCategory, setAnalyticsCategory] = useState('disputes');
            const [analyticsField, setAnalyticsField] = useState('status');
            const [analyticsDateRange, setAnalyticsDateRange] = useState({ start: '', end: '' });
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Reports state
            const [reportFilters, setReportFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });
            const [generatedReport, setGeneratedReport] = useState(null);
            const [selectedReportColumns, setSelectedReportColumns] = useState(['type', 'agent', 'status', 'date']);
            const [showLogFilters, setShowLogFilters] = useState(false);
            const [logFilters, setLogFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });

            const [customInputTarget, setCustomInputTarget] = useState(null);

            const fetchTasks = async () => {
                setConnectionStatus('connecting');
                const { data, error } = await supabase.from('tasks').select('*').order('date', { ascending: false });
                if (!error) { 
                    setTasks(data || []); 
                    setConnectionStatus('online'); 
                    discoverCustomOptions(data || []);
                }
                else { setConnectionStatus('offline'); }
            };

            const discoverCustomOptions = (allTasks) => {
                setCustomOptions(prev => {
                    const newDiscovery = { ...prev };
                    allTasks.forEach(t => {
                        Object.keys(newDiscovery).forEach(key => {
                            const val = t.details?.[key];
                            if (val && !newDiscovery[key].includes(val)) {
                                newDiscovery[key].push(val);
                            }
                        });
                    });
                    return newDiscovery;
                });
            };

            useEffect(() => {
                fetchTasks();
                const channel = supabase.channel('tasks-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, fetchTasks).subscribe();
                return () => supabase.removeChannel(channel);
            }, []);

            useEffect(() => {
                if (activeTab === 'analytics' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();

                    let filteredData = tasks.filter(t => t.type === analyticsCategory);
                    if (analyticsDateRange.start) filteredData = filteredData.filter(t => new Date(t.date) >= new Date(analyticsDateRange.start));
                    if (analyticsDateRange.end) {
                        const end = new Date(analyticsDateRange.end); end.setHours(23,59,59);
                        filteredData = filteredData.filter(t => new Date(t.date) <= end);
                    }

                    const counts = {};
                    filteredData.forEach(t => {
                        let value = 'N/A';
                        if (['status', 'agent', 'type'].includes(analyticsField)) { value = t[analyticsField] || 'N/A'; }
                        else { value = t.details?.[analyticsField] || 'N/A'; }
                        counts[value] = (counts[value] || 0) + 1;
                    });

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{ data: Object.values(counts), backgroundColor: 'rgba(37, 99, 235, 0.7)', borderRadius: 6 }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                        }
                    });
                }
            }, [activeTab, analyticsCategory, analyticsField, analyticsDateRange, tasks]);

            const handleAddTask = async (e) => {
                e.preventDefault();
                const requiredFields = categories[newTaskType].fields;
                const missingFields = [];

                requiredFields.forEach(field => {
                    if (field === 'correctionModule') {
                        const scores = formData.quizScores || {};
                        quizModules.forEach(m => { if (!scores[m.id]) missingFields.push(`Quiz Rating: ${m.title}`); });
                        return;
                    }
                    if (field === 'auditModule') {
                        const scores = formData.auditScores || {};
                        auditAttributes.forEach(a => { if (!scores[a.id]) missingFields.push(`Audit Attribute: ${a.label}`); });
                        return;
                    }
                    if (field === 'invalidReason') {
                        const isFwInvalid = newTaskType === 'floorwalker' && formData.validRequest === 'No';
                        const isHipInvalid = newTaskType === 'hip_request' && formData.validHip === 'No';
                        if ((isFwInvalid || isHipInvalid) && !formData[field]) missingFields.push("Reason for Invalid Request");
                        return;
                    }
                    if (newTaskType === 'hip_request' && ['hipProduct', 'hipCategory', 'hipRequestType'].includes(field) && !formData[field]) {
                        missingFields.push(field.replace('hip', 'HIP ').replace(/([A-Z])/g, ' $1'));
                        return;
                    }
                    if (['hipProduct', 'hipCategory', 'hipRequestType', 'correctionModule', 'auditModule', 'invalidReason'].includes(field)) return;
                    if (!formData[field] || formData[field].toString().trim() === '') missingFields.push(field.replace(/([A-Z])/g, ' $1').trim());
                });

                if (missingFields.length > 0) {
                    alert(`To save record, all entries must be filled:\n\n- ${missingFields.join('\n- ')}`);
                    return;
                }

                let status = formData.status || 'Pending';
                if (!editingTaskId) {
                    if (newTaskType === 'disputes' && (formData.resolution === 'Won' || formData.resolution === 'Lost')) status = 'Resolved';
                    else if (newTaskType === 'pending_subs' && (formData.resolution === 'Activated' || formData.resolution === 'Cancelled')) status = 'Resolved';
                    else if (['weekly_quiz', 'hip_request', 'duplicate_iap', 'mentor_audit'].includes(newTaskType)) status = 'Resolved';
                }

                const details = { ...formData };
                delete details.status;

                if (!editingTaskId && newTaskType === 'floorwalker') details.mentorName = currentUser;

                const taskData = {
                    type: newTaskType,
                    title: `${categories[newTaskType].label} Log`,
                    agent: currentUser,
                    status: status,
                    details: details
                };

                if (!editingTaskId) { taskData.date = new Date().toISOString(); }

                const { error } = editingTaskId 
                    ? await supabase.from('tasks').update(taskData).eq('id', editingTaskId)
                    : await supabase.from('tasks').insert([taskData]);

                if (error) alert("Error: " + error.message);
                else { setIsFormOpen(false); setFormData({}); setEditingTaskId(null); }
            };

            const handleEditTask = (task) => {
                setNewTaskType(task.type);
                setFormData({ ...(task.details || {}), status: task.status });
                setEditingTaskId(task.id);
                setIsFormOpen(true);
            };

            const handleInputChange = (field, value) => {
                if (value === 'ADD_NEW_CUSTOM') setCustomInputTarget(field);
                else { setFormData(prev => ({ ...prev, [field]: value })); setCustomInputTarget(null); }
            };

            const handleAddCustomValue = (field, newValue) => {
                if (!newValue.trim()) return;
                setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), newValue] }));
                handleInputChange(field, newValue);
            };

            const handleAuditScore = (attrId, achieved) => {
                const scores = { ...(formData.auditScores || {}) };
                scores[attrId] = achieved;
                let total = 0;
                auditAttributes.forEach(attr => { if (scores[attr.id] === 'Yes') total += attr.weight; });
                setFormData(prev => ({ ...prev, auditScores: scores, overallAuditScore: total }));
            };

            const handleQuizScore = (moduleId, score) => {
                const scores = { ...(formData.quizScores || {}), [moduleId]: parseInt(score) };
                const values = Object.values(scores);
                const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '0.0';
                setFormData(prev => ({ ...prev, quizScores: scores, overallScore: avg }));
            };

            const pickRandomHIP = () => {
                const hipLogs = tasks.filter(t => t.type === 'hip_request');
                if (hipLogs.length === 0) { alert("No HIP logs available."); return; }
                const random = hipLogs[Math.floor(Math.random() * hipLogs.length)];
                setFormData(prev => ({ ...prev, hipLogReference: random.id, auditedTicket: random.details.ticketLink, mentorName: random.agent }));
            };

            const filteredLogs = tasks.filter(t => {
                const matchesSearch = (categories[t.type]?.label || '').toLowerCase().includes(searchTerm.toLowerCase()) || (t.agent || '').toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = logFilters.category === 'all' || t.type === logFilters.category;
                const matchesAgent = logFilters.agent === 'all' || t.agent === logFilters.agent;
                let matchesDate = true;
                if (logFilters.startDate) matchesDate = matchesDate && new Date(t.date) >= new Date(logFilters.startDate);
                if (logFilters.endDate) { const end = new Date(logFilters.endDate); end.setHours(23, 59, 59); matchesDate = matchesDate && new Date(t.date) <= end; }
                return matchesSearch && matchesCategory && matchesAgent && matchesDate;
            });

            const paginatedLogs = filteredLogs.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const handleGenerateReport = () => {
                let filtered = tasks;
                if (reportFilters.category !== 'all') filtered = filtered.filter(t => t.type === reportFilters.category);
                if (reportFilters.agent !== 'all') filtered = filtered.filter(t => t.agent === reportFilters.agent);
                if (reportFilters.startDate) filtered = filtered.filter(t => new Date(t.date) >= new Date(reportFilters.startDate));
                if (reportFilters.endDate) { const end = new Date(reportFilters.endDate); end.setHours(23,59,59); filtered = filtered.filter(t => new Date(t.date) <= end); }
                setGeneratedReport(filtered);
            };

            const downloadCSV = () => {
                if (!generatedReport) return;
                const headers = selectedReportColumns;
                const csv = [headers.join(','), ...generatedReport.map(t => {
                    return headers.map(h => {
                        const val = ['id', 'type', 'agent', 'status', 'date'].includes(h) ? (h === 'date' ? new Date(t[h]).toLocaleDateString() : r[h]) : (t.details?.[h] || 'N/A');
                        return `"${val.toString().replace(/"/g, '""')}"`;
                    }).join(',');
                })].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'mentor_ops_report.csv'; a.click();
            };

            const toggleReportColumn = (col) => {
                setSelectedReportColumns(prev => prev.includes(col) ? prev.filter(c => c !== col) : [...prev, col]);
            };

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
                            <div className="flex items-center gap-3">
                                <h1 className="text-xl font-bold tracking-widest text-slate-900 uppercase">Tempo</h1>
                                <span className="h-6 w-px bg-slate-200" />
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Mentor Ops</span>
                            </div>
                            <nav className="flex gap-1">
                                {['dashboard', 'logs', 'analytics', 'reports'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-sm font-bold rounded-lg transition-colors ${activeTab === tab ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        {tab.toUpperCase()}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-4">
                                <div className={`h-2 w-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500' : 'bg-rose-500 animate-pulse'}`} />
                                <div className="text-right hidden md:block">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase">Logged In</p>
                                    <p className="text-sm font-bold leading-none">{currentUser}</p>
                                </div>
                                <button onClick={() => setCurrentUser(null)} className="p-2 text-slate-400 hover:text-rose-500 transition-colors"><LogOut className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card className="p-6 bg-slate-900 text-white shadow-xl">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Total Logs</p>
                                        <h3 className="text-4xl font-bold">{tasks.length}</h3>
                                    </Card>
                                    <Card className="p-6 border-l-4 border-l-rose-500">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Pending Follow-ups</p>
                                        <h3 className="text-4xl font-bold text-rose-600">{tasks.filter(t => t.status === 'Pending').length}</h3>
                                    </Card>
                                    <Card className="p-6 border-l-4 border-l-emerald-500">
                                        <p className="text-slate-400 text-xs font-bold uppercase mb-1">Resolved Today</p>
                                        <h3 className="text-4xl font-bold text-emerald-600">{tasks.filter(t => t.status !== 'Pending' && new Date(t.date).toDateString() === new Date().toDateString()).length}</h3>
                                    </Card>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                                    {Object.entries(categories).map(([key, cfg]) => (
                                        <button key={key} onClick={() => { setNewTaskType(key); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="p-4 bg-white border border-slate-200 rounded-xl text-center hover:shadow-md transition-all group">
                                            <div className={`h-10 w-10 mx-auto rounded-lg flex items-center justify-center mb-2 bg-${cfg.color}-100`}>
                                                {React.createElement(cfg.icon, { className: `h-5 w-5 text-${cfg.color}-600` })}
                                            </div>
                                            <p className="text-[10px] font-bold text-slate-500 uppercase">{cfg.label}</p>
                                            <p className="text-xl font-bold">{tasks.filter(t => t.type === key).length}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex flex-col md:flex-row gap-4 justify-between bg-white p-4 rounded-xl border">
                                    <div className="relative flex-1 max-w-md">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                                        <input type="text" placeholder="Search logs..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowLogFilters(!showLogFilters)} className={`flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium transition-colors ${showLogFilters ? 'bg-slate-100 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-50'}`}>
                                            <Filter className="h-4 w-4" /> Filters
                                        </button>
                                        <button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-100 hover:bg-blue-700">
                                            <Plus className="h-4 w-4" /> New Entry
                                        </button>
                                    </div>
                                </div>

                                {showLogFilters && (
                                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 animate-fade-in">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Category</label>
                                            <select className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.category} onChange={e => setLogFilters(f => ({...f, category: e.target.value}))}>
                                                <option value="all">All Types</option>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Owner</label>
                                            <select className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.agent} onChange={e => setLogFilters(f => ({...f, agent: e.target.value}))}>
                                                <option value="all">All Mentors</option>
                                                {mentorList.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Start Date</label>
                                            <input type="date" className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.startDate} onChange={e => setLogFilters(f => ({...f, startDate: e.target.value}))} />
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">End Date</label>
                                            <input type="date" className="w-full p-2 bg-slate-50 border rounded-lg text-xs" value={logFilters.endDate} onChange={e => setLogFilters(f => ({...f, endDate: e.target.value}))} />
                                        </div>
                                    </div>
                                )}

                                <Card className="overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="px-6 py-4">Category</th>
                                                <th className="px-6 py-4">Agent</th>
                                                <th className="px-6 py-4">Status</th>
                                                <th className="px-6 py-4 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {paginatedLogs.map(task => (
                                                <tr key={task.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`h-8 w-8 rounded-lg flex items-center justify-center bg-${categories[task.type]?.color}-100`}>
                                                                {React.createElement(categories[task.type]?.icon || AlertCircle, { className: `h-4 w-4 text-${categories[task.type]?.color}-600` })}
                                                            </div>
                                                            <span className="font-medium text-slate-700">{categories[task.type]?.label}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 text-slate-600">{task.agent}</td>
                                                    <td className="px-6 py-4">
                                                        <Badge color={task.status === 'Pending' ? 'amber' : (['Resolved', 'Won', 'Activated'].includes(task.status) ? 'green' : 'slate')}>
                                                            {task.status}
                                                        </Badge>
                                                    </td>
                                                    <td className="px-6 py-4 text-right">
                                                        <button onClick={() => handleEditTask(task)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"><Edit className="h-4 w-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="p-4 bg-slate-50 flex justify-between items-center text-xs font-bold text-slate-500">
                                        <span>Showing {(currentPage-1)*itemsPerPage+1} to {Math.min(currentPage*itemsPerPage, filteredLogs.length)} of {filteredLogs.length}</span>
                                        <div className="flex gap-2">
                                            <button disabled={currentPage === 1} onClick={() => setCurrentPage(p => p - 1)} className="px-3 py-1 bg-white border rounded hover:bg-slate-100 disabled:opacity-50">Prev</button>
                                            <button disabled={currentPage * itemsPerPage >= filteredLogs.length} onClick={() => setCurrentPage(p => p + 1)} className="px-3 py-1 bg-white border rounded hover:bg-slate-100 disabled:opacity-50">Next</button>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6 animate-fade-in">
                                <Card className="p-6">
                                    <div className="flex items-center gap-3 mb-6"><BarChart3 className="h-6 w-6 text-blue-600" /><h2 className="text-xl font-bold">Analytics</h2></div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Category</label>
                                            <select className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" value={analyticsCategory} onChange={e => setAnalyticsCategory(e.target.value)}>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Metric</label>
                                            <select className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" value={analyticsField} onChange={e => setAnalyticsField(e.target.value)}>
                                                <option value="status">Status</option><option value="agent">Agent</option>
                                                {categories[analyticsCategory]?.fields.filter(f => !f.includes('Module')).map(f => <option key={f} value={f}>{f.replace(/([A-Z])/g, ' $1')}</option>)}
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">From</label>
                                            <input type="date" className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" value={analyticsDateRange.start} onChange={e => setAnalyticsDateRange(p => ({...p, start: e.target.value}))} />
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">To</label>
                                            <input type="date" className="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" value={analyticsDateRange.end} onChange={e => setAnalyticsDateRange(p => ({...p, end: e.target.value}))} />
                                        </div>
                                    </div>
                                    <div className="h-[400px] flex items-center justify-center p-4 bg-slate-50 rounded-xl"><canvas ref={chartRef}></canvas></div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className="space-y-6 animate-fade-in">
                                <Card className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <select className="w-full p-2.5 border rounded-lg text-sm" value={reportFilters.category} onChange={e => setReportFilters(f => ({ ...f, category: e.target.value }))}><option value="all">All Types</option>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="w-full p-2.5 border rounded-lg text-sm" value={reportFilters.agent} onChange={e => setReportFilters(f => ({ ...f, agent: e.target.value }))}><option value="all">All Mentors</option>{mentorList.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <input type="date" className="w-full p-2.5 border rounded-lg text-sm" value={reportFilters.startDate} onChange={e => setReportFilters(f => ({ ...f, startDate: e.target.value }))} />
                                        <input type="date" className="w-full p-2.5 border rounded-lg text-sm" value={reportFilters.endDate} onChange={e => setReportFilters(f => ({ ...f, endDate: e.target.value }))} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 pt-2 border-t border-slate-100">
                                        {['agent', 'status', 'date', ...(reportFilters.category !== 'all' ? categories[reportFilters.category].fields : [])].filter(col => !col.includes('Module')).map(col => (
                                            <button key={col} onClick={() => toggleReportColumn(col)} className={`px-3 py-1.5 rounded-full text-[10px] font-bold border ${selectedReportColumns.includes(col) ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-200 text-slate-500'}`}>
                                                {col.replace(/([A-Z])/g, ' $1').toUpperCase()}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex justify-end pt-2"><button onClick={handleGenerateReport} className="px-6 py-2.5 bg-slate-900 text-white font-bold rounded-lg shadow-lg">GENERATE REPORT</button></div>
                                </Card>

                                {generatedReport && (
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center"><h3 className="font-bold">Results ({generatedReport.length})</h3><button onClick={downloadCSV} className="flex items-center gap-2 px-4 py-2 bg-white border rounded-lg text-sm font-bold"><Download className="h-4 w-4" /> Export CSV</button></div>
                                        <Card className="overflow-x-auto">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        {selectedReportColumns.map(c => <th key={c} className="px-6 py-3 uppercase text-[10px] font-black">{c.replace(/([A-Z])/g, ' $1')}</th>)}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {generatedReport.map(r => (
                                                        <tr key={r.id} className="hover:bg-slate-50">
                                                            {selectedReportColumns.map(c => (
                                                                <td key={c} className="px-6 py-4 max-w-xs truncate">
                                                                    {['type','agent','status','date'].includes(c) ? (c === 'date' ? new Date(r[c]).toLocaleDateString() : r[c]) : (r.details?.[c] || 'N/A')}
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </Card>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {isFormOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={() => setIsFormOpen(false)} />
                            <div className="relative w-full max-w-md bg-white h-full shadow-2xl p-8 overflow-y-auto animate-slide-in-right">
                                <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-black italic uppercase">{editingTaskId ? 'EDIT' : 'NEW'} {categories[newTaskType].label}</h2><button onClick={() => setIsFormOpen(false)} className="text-slate-400 uppercase text-[10px] font-black">Close</button></div>
                                <form onSubmit={handleAddTask} className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-2xl border space-y-4">
                                        {categories[newTaskType].fields.map(field => {
                                            const isValidNo = (newTaskType === 'floorwalker' && formData.validRequest === 'No') || (newTaskType === 'hip_request' && formData.validHip === 'No');
                                            if (field === 'invalidReason' && !isValidNo) return null;

                                            if (field === 'auditModule' || field === 'correctionModule') {
                                                const items = field === 'auditModule' ? auditAttributes : quizModules;
                                                return (
                                                    <div key={field} className="space-y-6 pt-2">
                                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{field.replace('Module','')} Scoring</h3>
                                                        {items.map(m => (
                                                            <div key={m.id} className="bg-white p-4 rounded-xl border border-slate-200">
                                                                <p className="font-bold text-sm mb-1">{m.title || m.label}</p>
                                                                <p className="text-[10px] text-slate-400 mb-4">{m.desc}</p>
                                                                <div className="flex justify-center gap-2 mb-4">
                                                                    {field === 'auditModule' ? ['Yes', 'No'].map(s => (
                                                                        <button key={s} type="button" onClick={() => handleAuditScore(m.id, s)} className={`px-4 py-1.5 rounded-lg border-2 text-[10px] font-black transition-all ${formData.auditScores?.[m.id] === s ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-200 text-slate-400'}`}>{s.toUpperCase()}</button>
                                                                    )) : [1, 2, 3, 4, 5].map(s => (
                                                                        <button key={s} type="button" onClick={() => handleQuizScore(m.id, s)} className={`w-8 h-8 rounded-full border-2 text-xs font-bold transition-all ${formData.quizScores?.[m.id] === s ? 'bg-cyan-500 border-cyan-500 text-white shadow-lg shadow-cyan-100' : 'bg-white border-slate-200 text-slate-400'}`}>{s}</button>
                                                                    ))}
                                                                </div>
                                                                <input type="text" placeholder="Comment for this attribute..." className="w-full p-2 bg-slate-50 border-b text-[10px] outline-none" onChange={e => setFormData(p => ({...p, quizComments: {...(p.quizComments || {}), [m.id]: e.target.value}}))} value={formData.quizComments?.[m.id] || ''} />
                                                            </div>
                                                        ))}
                                                    </div>
                                                );
                                            }

                                            if (field === 'hipLogReference' && newTaskType === 'mentor_audit') return (
                                                <div key={field} className="pt-2">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Audit Target</label>
                                                    <div className="flex gap-2"><div className="flex-1 p-3 bg-white border rounded-xl text-sm font-medium">{formData.auditedTicket || 'No Log Picked'}</div>
                                                    <button type="button" onClick={pickRandomHIP} className="p-3 bg-blue-100 text-blue-600 rounded-xl"><Dice className="h-5 w-5" /></button></div>
                                                </div>
                                            );

                                            if (newTaskType === 'hip_request' && field === 'hipProduct') return (
                                                <div key={field}><label className="text-[10px] font-black text-slate-400 uppercase block mb-1.5">Product</label>
                                                <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm" value={formData.hipProduct || ''} onChange={e => setFormData(p => ({ ...p, hipProduct: e.target.value, hipCategory: '', hipRequestType: '' }))}>
                                                <option value="">Select Product...</option>{Object.keys(HIP_HIERARCHY).map(k => <option key={k} value={k}>{k}</option>)}</select></div>
                                            );
                                            if (newTaskType === 'hip_request' && field === 'hipCategory') return (
                                                <div key={field}><label className="text-[10px] font-black text-slate-400 uppercase block mb-1.5">Category</label>
                                                <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm" disabled={!formData.hipProduct} value={formData.hipCategory || ''} onChange={e => setFormData(p => ({ ...p, hipCategory: e.target.value, hipRequestType: '' }))}>
                                                <option value="">Select Category...</option>{formData.hipProduct && Object.keys(HIP_HIERARCHY[formData.hipProduct] || {}).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                            );
                                            if (newTaskType === 'hip_request' && field === 'hipRequestType') return (
                                                <div key={field}><label className="text-[10px] font-black text-slate-400 uppercase block mb-1.5">Request Type</label>
                                                <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm" disabled={!formData.hipCategory} value={formData.hipRequestType || ''} onChange={e => handleInputChange(field, e.target.value)}>
                                                <option value="">Select Request Type...</option>{(formData.hipProduct && formData.hipCategory) && HIP_HIERARCHY[formData.hipProduct][formData.hipCategory].map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                                            );

                                            const isDropdown = ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'requestType', 'validHip', 'validRequest', 'subscriptionStatus', 'emailSent', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason'].includes(field);
                                            
                                            return (
                                                <div key={field}>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">{field.replace(/([A-Z])/g, ' $1')}</label>
                                                    {isDropdown ? (
                                                        <div className="space-y-2">
                                                            <select className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)}>
                                                                <option value="">Select...</option>
                                                                {(field === 'associateName' || field === 'associateEmail') && associateList.map(a => <option key={a} value={a}>{a}</option>)}
                                                                {field === 'mentorName' && mentorList.map(a => <option key={a} value={a}>{a}</option>)}
                                                                {field === 'resolution' && (newTaskType === 'pending_subs' ? ['Activated', 'Cancelled'] : newTaskType === 'disputes' ? ['Pending', 'Lost', 'Won'] : ['Pending', 'Resolved']).map(o => <option key={o} value={o}>{o}</option>)}
                                                                {field !== 'resolution' && customOptions[field]?.map(o => <option key={o} value={o}>{o}</option>)}
                                                                <option value="ADD_NEW_CUSTOM" className="text-blue-600 font-bold">+ Add New Item...</option>
                                                            </select>
                                                            {customInputTarget === field && (
                                                                <div className="flex gap-2 animate-fade-in"><input type="text" id={`custom-${field}`} placeholder={`New ${field}...`} className="flex-1 p-2 text-xs border rounded-lg outline-none" /><button type="button" onClick={() => handleAddCustomValue(field, document.getElementById(`custom-${field}`).value)} className="px-4 py-2 bg-blue-600 text-white text-[10px] font-bold rounded-lg uppercase">Add</button></div>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <input type={field.toLowerCase().includes('date') ? 'date' : 'text'} className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {!['weekly_quiz', 'hip_request', 'duplicate_iap', 'mentor_audit'].includes(newTaskType) && (
                                        <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1.5">Record Status</label>
                                            <select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold" value={formData.status || 'Pending'} onChange={e => handleInputChange('status', e.target.value)}><option value="Pending">Pending</option><option value="Resolved">Resolved</option><option value="In Progress">In Progress</option></select>
                                        </div>
                                    )}
                                    <button type="submit" className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest">{editingTaskId ? 'Update Log' : 'Save Record'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MentorOpsCenter />);
    </script>
</body>
</html>
