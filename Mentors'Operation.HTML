<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo MentorOps | Integrated System</title>
    <link rel="icon" href="https://tempo.fit/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tempo: {
                            blue: '#2563EB',
                            dark: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        canvas {
            max-width: 100% !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://mifbpckstfwphkwtqksa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZmJwY2tzdGZ3cGhrd3Rxa3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzcyMDksImV4cCI6MjA4NjUxMzIwOX0.PDZwE9hII9kPOjrBeJAI8T28oetruK-ogFtKOICMlOQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Google Script Config ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/a/macros/tempo.fit/s/AKfycbz2ngPXazyFO1WvRVBVaidZpUVql83HomMP4XPlKkqO7mnbKYYGZgu348O5_xq0XoKM/exec"; 

        // --- Core UI Components ---
        function Card({ children, className = "", onClick }) {
            return (
                <div onClick={onClick} className={`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm ${className}`}>
                    {children}
                </div>
            );
        }

        function Badge({ children, color = "slate" }) {
            const colors = { 
                slate: "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300", 
                red: "bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400", 
                blue: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400", 
                green: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", 
                amber: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400", 
                teal: "bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400", 
                cyan: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400", 
                purple: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400", 
                emerald: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
                indigo: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400"
            };
            const selectedColor = colors[color] || colors.slate;
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold ${selectedColor}`}>
                    {children}
                </span>
            );
        }

        // --- Icon Components ---
        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const LayoutDashboard = (props) => <Icon {...props} path={<React.Fragment><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></React.Fragment>} />;
        const AlertCircle = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>} />;
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />;
        const CreditCard = (props) => <Icon {...props} path={<React.Fragment><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></React.Fragment>} />;
        const Footprints = (props) => <Icon {...props} path={<React.Fragment><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.25-.79 4.33-2 6"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.25.79 4.33 2 6"/><path d="M16 17h4"/><path d="M4 13h4"/></React.Fragment>} />;
        const Gift = (props) => <Icon {...props} path={<React.Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></React.Fragment>} />;
        const UserCheck = (props) => <Icon {...props} path={<React.Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></React.Fragment>} />;
        const FileText = (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></React.Fragment>} />;
        const Search = (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>} />;
        const Edit = (props) => <Icon {...props} path={<React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></React.Fragment>} />;
        const Dice = (props) => <Icon {...props} path={<React.Fragment><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></React.Fragment>} />;
        const Plus = (props) => <Icon {...props} path={<React.Fragment><path d="M5 12h14"/><path d="M12 5v14"/></React.Fragment>} />;
        const BarChart3 = (props) => <Icon {...props} path={<React.Fragment><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></React.Fragment>} />;
        const MessageCircle = (props) => <Icon {...props} path={<React.Fragment><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></React.Fragment>} />;
        const LogOut = (props) => <Icon {...props} path={<React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></React.Fragment>} />;
        const Shield = (props) => <Icon {...props} path={<React.Fragment><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></React.Fragment>} />;
        const Trash = (props) => <Icon {...props} path={<React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></React.Fragment>} />;
        const Download = (props) => <Icon {...props} path={<React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></React.Fragment>} />;
        const DatabaseIcon = (props) => <Icon {...props} path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></>} />;
        const Moon = (props) => <Icon {...props} path={<><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></>} />;
        const Sun = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />;
        const SettingsIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />;
        const ClipboardList = (props) => <Icon {...props} path={<React.Fragment><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></React.Fragment>} />;
        const ChevronDown = (props) => <Icon {...props} path={<polyline points="6 9 12 15 18 9"/>} />;
        const ChevronUp = (props) => <Icon {...props} path={<polyline points="18 15 12 9 6 15"/>} />;
        const TrendingUp = (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />;
        const Target = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />;
        const Calendar = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;

        // --- Maps ---
        const associateEmailMap = {
            "Ariath Piol": "ariath.piol@tempo.fit",
            "Job James": "job.james@tempo.fit",
            "Lina Hesham": "linahesham@tempo.fit",
            "Mohab Magdy": "mohab.magdy@tempo.fit",
            "Marwa Ahmed": "marwa.ahmed@tempo.fit",
            "Ramadan Philip": "ramadan.philip@tempo.fit",
            "Aida Clement": "aida.clement@tempo.fit",
            "Hassan Khallaf": "hassan@tempo.fit",
            "Nada Ashraf": "nada.ashraf@tempo.fit",
            "Ruben Joseph": "ruben.joseph@tempo.fit",
            "Esraa Tarek Eroq": "esraa.tarek@tempo.fit",
            "Ahmed Abdelghany": "ahmed.abdelghany@tempo.fit",
            "Nour Ayman": "nour.ayman@tempo.fit",
            "Ashraf Essam": "ashraf.essam@tempo.fit",
            "Hala Ayman": "hala.ayman@tempo.fit",
            "Rania Mohamed": "rania.mohamed@tempo.fit",
            "Salma Ahmed": "salma.ahmed@tempo.fit",
            "Marwan Hassan": "marwan.hassan@tempo.fit",
            "Osama M. Adam": "osama.adam@tempo.fit",
            "Marwan Zakaria": "marwan.zakaria@tempo.fit",
            "Shahd Emad": "shahd.emad@tempo.fit",
            "Ahmed Nasser abdelhakim": "ahmed.abdelhakim@tempo.fit",
            "Mohamed Kheer": "mohamed.kheer@tempo.fit",
            "Rima Khaled Hassan Zaki": "rima.khaled@tempo.fit",
            "Santos Nyikang": "santos.nyikang@tempo.fit",
            "Youkabed Farid": "youkabed.farid@tempo.fit"
        };

        const mentorEmailMap = {
            "Noha Radwan": "noha.radwan@tempo.fit",
            "Rashad Mohamed": "rashad.mohamed@tempo.fit",
            "Emad Mohamed": "emad.mohamed@tempo.fit",
            "Mohamed Mounir": "mohamed.mounir@tempo.fit"
        };

        // --- Data Defaults ---
        const initialAssociateList = Object.keys(associateEmailMap);
        const initialMentorList = Object.keys(mentorEmailMap);
        const defaultTabs = ['dashboard', 'logs', 'analytics', 'reports'];
        
        const auditAttributes = [
            { id: 'responsiveness', label: 'Responsiveness', weight: 10, desc: 'Mentor responsiveness metrics.' },
            { id: 'professionalism', label: 'Professionalism', weight: 10, desc: 'Mentor conduct.' },
            { id: 'clarity', label: 'Clarity', weight: 20, desc: 'Assess ability to explain clearly.' },
            { id: 'workflow', label: 'Workflow', weight: 20, desc: 'Reviews correct workflow usage.' },
            { id: 'documentation', label: 'Documentation', weight: 10, desc: 'Consistency of mentor notes.' },
            { id: 'resolution', label: 'Resolution', weight: 30, desc: 'Efficient issue resolution.' }
        ];

        const quizModules = [
            { id: 'productExpert', title: 'Product Expert', desc: 'Associate expertise demo.' },
            { id: 'processAwareness', title: 'Process Awareness', desc: 'Comprehending process vs procedures.' },
            { id: 'communication', title: 'Communication', desc: 'Reflect effectiveness in communication.' },
            { id: 'customerConcern', title: 'Identify customer Concern', desc: 'Comprehend concerns effectively.' },
            { id: 'fcr', title: 'FCR', desc: 'Was the associate able to anticipate all questions?' }
        ];

        const categories = {
            disputes: { label: 'Disputes', icon: AlertCircle, color: 'red', fields: ['customerName', 'customerEmail', 'disputeAmount', 'disputeDate', 'disputeReason', 'disputedProduct', 'disputeLink', 'resolution'] },
            pending_subs: { label: 'Pending Subs', icon: CreditCard, color: 'blue', fields: ['customerName', 'customerEmail', 'pendingReason', 'resolution'] },
            floorwalker: { label: 'FloorWalker', icon: Footprints, color: 'amber', fields: ['associateName', 'validRequest', 'invalidReason', 'ticketLink', 'reasonForSupport', 'slackLink', 'comment', 'status'] },
            hip_request: { label: 'HIP Request', icon: MessageCircle, color: 'teal', fields: ['associateName', 'ticketLink', 'slackLink', 'validHip', 'invalidReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail'] },
            weekly_quiz: { label: 'Weekly Quiz', icon: ClipboardList, color: 'cyan', fields: ['associateName', 'associateEmail', 'date', 'correctionModule'] },
            duplicate_iap: { label: 'Duplicate IAP', icon: FileText, color: 'indigo', fields: ['customerEmail', 'emailSent', 'subscriptionStatus'] },
            surprise_delight: { label: 'Surprise & Delight', icon: Gift, color: 'purple', fields: ['associateName', 'team', 'customerName', 'customerEmail', 'productType', 'ticketUrl', 'surpriseAndDelightReason', 'surpriseAndDelightType', 'amount', 'date', 'notes'] },
            mentor_audit: { label: 'Mentor Audit', icon: UserCheck, color: 'emerald', fields: ['mentorName', 'mentorEmail', 'hipLogReference', 'auditModule'] },
        };

        const adminValidationCategories = {
            ...categories,
            warnings: { label: 'Warnings', fields: ['warningReason'] }
        };

        const initialHIPHierarchy = {
            "Move": {
                "Order Modifications": ["Change Color", "Change Address", "Upgrade", "Downgrade", "Core Modification", "Order Receipt", "Mispick"],
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Missing Items", "Damaged Unit", "DOA"],
                "Billing & Membership": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute"],
                "Payments & Offers": ["HSA/FSA", "Invoice Request", "Bundled Inquiry", "Bundled Code Applied", "Personal Training"],
                "Account Management": ["Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login", "Current Promotions"],
                "Content": ["Challenges", "Workout History", "Feedback", "Training Plan Inquiry", "Baseline Issue"],
                "Prospective": ["Purchasing Info", "Membership Requirements", "HSA/FSA Inquiry", "Referral Program", "Holiday Promotion", "Current Offers"]
            },
            "Core": {
                "Product Support": ["Android Support", "Connection Unstable", "Hardware Connection Issue", "Start Class Error", "Incomplete Class"],
                "Hardware Support": ["Physical Damage", "Standalone Availability", "Standalone Delivery Delay"],
                "Shipping": ["Missing Items", "Delayed Accessories"]
            },
            "Studio": {
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Missing Items", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Damaged Unit", "DOA"],
                "Order Mods": ["Change Address", "Order Receipt", "Mispick"],
                "Billing": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Refund Inquiry"]
            },
            "Accessory": {
                "Purchasing": ["Cabinet Info", "Core Standalone Availability", "Kettlebell Availability"],
                "Delivery": ["Core Standalone Delay", "Plates Delivery Delay", "Barbell Delivery Delay", "Apparel Missing Item"],
                "Quality & Damage": ["Collar Damage", "Quick Lock Damage", "Competition Plates Damage", "Barbell Damage", "Workout mat Damage"],
                "Setup & Specs": ["Kettlebell Setup", "Folding Rack Setup", "Folding Rack Lock Issue", "Collar Specs", "HRM Replacement", "HRM Charger Replacement"]
            }
        };

        // --- App Component ---
        function MentorOpsCenter() {
            const [userProfile, setUserProfile] = useState(null);
            const [session, setSession] = useState(null);
            
            // Start Active Tab from URL params for deep linking
            const [activeTab, setActiveTab] = useState(() => {
                if (typeof window !== 'undefined') {
                    const params = new URLSearchParams(window.location.search);
                    return params.get('tab') || 'dashboard';
                }
                return 'dashboard';
            });
            
            const [tasks, setTasks] = useState([]);
            const [registry, setRegistry] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [searchTerm, setSearchTerm] = useState('');
            const [dashboardSearch, setDashboardSearch] = useState('');
            const [dashboardCategory, setDashboardCategory] = useState('all');
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [newTaskType, setNewTaskType] = useState('disputes');
            const [formData, setFormData] = useState({});
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;
            
            // PIP State
            const [isPipModalOpen, setIsPipModalOpen] = useState(false);
            const [pipData, setPipData] = useState({});

            // Warning State
            const [isWarningModalOpen, setIsWarningModalOpen] = useState(false);
            const [warningData, setWarningData] = useState({});

            // Audit Dashboard State (For Dashboard view)
            const [auditDashMentor, setAuditDashMentor] = useState('');
            const [auditDashRange, setAuditDashRange] = useState({ start: '', end: '' });
            
            // New Randomizer State
            const [auditRandomizerRange, setAuditRandomizerRange] = useState({ start: '', end: '' });

            // Admin task type filtering state
            const [adminSelectedTaskType, setAdminSelectedTaskType] = useState('floorwalker');

            // Auto-Resolution Types
            const autoResolvedTypes = ['weekly_quiz', 'mentor_audit', 'pending_subs', 'duplicate_iap', 'surprise_delight'];

            // Dashboard Collapsible State
            const [isPendingCollapsed, setIsPendingCollapsed] = useState(false);
            const [expandedPendingGroups, setExpandedPendingGroups] = useState({});
            
            // Deep Link Handler State
            const [hasHandledDeepLink, setHasHandledDeepLink] = useState(false);

            const togglePendingGroup = (type) => {
                setExpandedPendingGroups(prev => ({ ...prev, [type]: !prev[type] }));
            };

            // Auth State
            const [authView, setAuthView] = useState('login'); 
            const [authLoading, setAuthLoading] = useState(false);
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [newInternalPassword, setNewInternalPassword] = useState('');

            // Config State
            const [globalHipHierarchy, setGlobalHipHierarchy] = useState(initialHIPHierarchy);
            const [globalAssociates, setGlobalAssociates] = useState(initialAssociateList);
            const [globalMentors, setGlobalMentors] = useState(initialMentorList);

            // Analytics State
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [analyticsCategory, setAnalyticsCategory] = useState('disputes');
            const [analyticsField, setAnalyticsField] = useState('status');
            const [analyticsDateRange, setAnalyticsDateRange] = useState({ start: '', end: '' });

            const [customOptions, setCustomOptions] = useState({
                pendingReason: ["Not delivered", "Delivered but not updated.", "Returned or canceled order"],
                disputeReason: ["Subscription claim", "Unauthorized purchase", "Defective product", "Credit not processed", "Fraud", "Subscription Cancelled", "Product Unacceptable"],
                reasonForSupport: ["SOP Guidance", "Process education", "System Navigation"],
                team: ["T1", "Social Media", "Mentor", "Order Support", "Product Support"],
                productType: ["Studio", "Move", "Core", "Accessories", "Membership"],
                disputedProduct: ["Move", "Core", "Membership", "Accessories"],
                surpriseAndDelightReason: ["Delivery ETA", "Wrong color", "Technical issue", "SRLimited access", "Missing discount", "Compatibility", "Lack of content"],
                surpriseAndDelightType: ["Water Bottle", "Sweat Towel", "Yoga Block", "Recovery Roller", "Gift Box", "axis-performance-hat-black", "axis-performance-hat-slate-grey", "tempo-workout-gloves", "motive-training-tee-black", "motive-training-tee-1", "Pinnacle Knit Beanie"],
                validRequest: ["Yes", "No"], validHip: ["Yes", "No"], emailSent: ["Yes", "No"], subscriptionStatus: ["Active", "Cancelled"],
                pendingReasonDetail: ["waiting on Internal", "waiting on Customer"],
                invalidReason: ["Outside Scope", "Incorrect Channel", "Missing Required Information", "No Response from Associate"],
                warningReason: ["Attendance", "Performance", "Behavior", "Policy Violation"]
            });

            const [customInputTarget, setCustomInputTarget] = useState(null);
            const [reportFilters, setReportFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });
            const [generatedReport, setGeneratedReport] = useState(null);
            const [selectedReportColumns, setSelectedReportColumns] = useState(['type', 'agent', 'status', 'date']);

            // Theme effect
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDarkMode]);

            // Authentication Implementation
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchUserProfile(session.user.email);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    setSession(session);
                    if (event === 'PASSWORD_RECOVERY') setAuthView('reset');
                    if (session) fetchUserProfile(session.user.email);
                    else setUserProfile(null);
                });
                return () => subscription.unsubscribe();
            }, []);

            const fetchUserProfile = async (email) => {
                const { data, error } = await supabase.from('users_registry').select('*').eq('email', email).maybeSingle();
                if (data) {
                    setUserProfile(data);
                } else if (email === 'mohamed.abdelmagid@tempo.fit') {
                    const initial = { email, role: 'Admin', allowed_tabs: defaultTabs.concat(['admin', 'audits']) };
                    await supabase.from('users_registry').insert([initial]);
                    setUserProfile(initial);
                } else {
                    setUserProfile({ error: true, message: "Unauthorized account registry." });
                }
            };

            const fetchData = async () => {
                setConnectionStatus('connecting');
                
                // Fetch tasks
                const tasksRes = await supabase.from('tasks').select('*').order('date', { ascending: false });
                if (!tasksRes.error) { 
                    setTasks(tasksRes.data || []); 
                    setConnectionStatus('online'); 
                    discoverCustomOptions(tasksRes.data || []);
                }

                // Fetch registry
                if (userProfile?.role === 'Admin') {
                    const regRes = await supabase.from('users_registry').select('*');
                    if (!regRes.error) setRegistry(regRes.data || []);
                }

                // Fetch app_config
                try {
                    const { data: configData, error: configErr } = await supabase.from('app_config').select('*').eq('id', 1).maybeSingle();
                    if (!configErr && configData) {
                        if (configData.hip_hierarchy) setGlobalHipHierarchy(prev => ({...prev, ...configData.hip_hierarchy}));
                        if (configData.associates) setGlobalAssociates(prev => Array.from(new Set([...prev, ...configData.associates])));
                        if (configData.mentors) setGlobalMentors(prev => Array.from(new Set([...prev, ...configData.mentors])));
                        if (configData.custom_options) setCustomOptions(prev => {
                            const merged = {...prev};
                            Object.keys(configData.custom_options).forEach(key => {
                                merged[key] = Array.from(new Set([...(prev[key] || []), ...(configData.custom_options[key] || [])]));
                            });
                            return merged;
                        });
                    }
                } catch (e) {
                    console.error("Config fetch failed", e);
                }
            };

            const discoverCustomOptions = (allTasks) => {
                setCustomOptions(prev => {
                    const newDiscovery = { ...prev };
                    allTasks.forEach(t => {
                        Object.keys(newDiscovery).forEach(key => {
                            const val = t.details?.[key];
                            if (val && !newDiscovery[key].includes(val)) newDiscovery[key].push(val);
                        });
                    });
                    return newDiscovery;
                });
            };

            useEffect(() => {
                if (userProfile && !userProfile.error) fetchData();
                const channel = supabase.channel('tasks-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, fetchData).subscribe();
                return () => supabase.removeChannel(channel);
            }, [userProfile]);

            // Set up Audit Dashboard Mentor mapping
            useEffect(() => {
                if (userProfile) {
                    const foundMentor = Object.keys(mentorEmailMap).find(name => mentorEmailMap[name] === userProfile.email);
                    if (foundMentor) {
                        setAuditDashMentor(foundMentor);
                    } else if (userProfile.role === 'Admin') {
                        setAuditDashMentor(globalMentors[0] || '');
                    } else {
                        setAuditDashMentor(userProfile.email.split('@')[0]);
                    }
                }
            }, [userProfile, globalMentors]);
            
            // Deep Linking Handler
            useEffect(() => {
                if (!hasHandledDeepLink && tasks.length > 0) {
                    const params = new URLSearchParams(window.location.search);
                    const taskId = params.get('taskId');
                    
                    if (taskId) {
                        const targetTask = tasks.find(t => String(t.id) === String(taskId));
                        if (targetTask) {
                            if (targetTask.type === 'pip') {
                                setPipData({ ...targetTask.details, id: targetTask.id, status: targetTask.status });
                                setIsPipModalOpen(true);
                            } else if (targetTask.type === 'warning') {
                                setWarningData({ ...targetTask.details, id: targetTask.id });
                                setIsWarningModalOpen(true);
                            } else {
                                handleEditTask(targetTask);
                            }
                            
                            // Clean the URL to prevent reopening on accidental page refresh
                            let cleanTab = activeTab;
                            if (targetTask.type === 'warning') cleanTab = 'warnings';
                            else if (targetTask.type === 'pip') cleanTab = 'pip';
                            else if (targetTask.type === 'mentor_audit' && userProfile?.role === 'Admin') cleanTab = 'audits';
                            else if (targetTask.type === 'mentor_audit' && userProfile?.role !== 'Admin') cleanTab = 'dashboard';
                            
                            const newUrl = window.location.href.split('?')[0] + '?tab=' + cleanTab;
                            window.history.replaceState({}, document.title, newUrl);
                            if (cleanTab !== activeTab) setActiveTab(cleanTab);
                        }
                    }
                    setHasHandledDeepLink(true);
                }
            }, [tasks, hasHandledDeepLink, activeTab, userProfile]);

            // Handlers
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthLoading(true);
                let error = null;
                const redirectTo = window.location.origin + window.location.pathname;

                if (authView === 'login') {
                    const res = await supabase.auth.signInWithPassword({ email: authEmail, password: authPassword });
                    error = res.error;
                } else if (authView === 'signup') {
                    const res = await supabase.auth.signUp({ email: authEmail, password: authPassword, options: { emailRedirectTo: redirectTo } });
                    error = res.error;
                    if (!error) alert("Email confirmation sent!");
                } else if (authView === 'forgot') {
                    const res = await supabase.auth.resetPasswordForEmail(authEmail, { redirectTo: redirectTo });
                    error = res.error;
                    if (!error) alert("Recovery link sent!");
                } else if (authView === 'reset') {
                    const res = await supabase.auth.updateUser({ password: authPassword });
                    error = res.error;
                    if (!error) { alert("Updated!"); setAuthView('login'); }
                }
                if (error) alert(error.message);
                setAuthLoading(false);
            };

            const handleGoogleLogin = async () => {
                const redirectTo = window.location.origin + window.location.pathname;
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: redirectTo }
                });
                if (error) alert(error.message);
            };

            const handleUpdatePasswordInternal = async () => {
                if (newInternalPassword.length < 6) return alert("Min 6 chars.");
                const { error } = await supabase.auth.updateUser({ password: newInternalPassword });
                if (!error) { alert("Success!"); setNewInternalPassword(''); setIsSettingsOpen(false); }
                else alert(error.message);
            };

            const handleAddUser = async () => {
                if (!formData.newEmail || !formData.newEmail.includes('@')) return alert("Enter valid email.");
                const initial = { email: formData.newEmail, role: formData.newRole || 'Mentor', allowed_tabs: defaultTabs };
                const { error } = await supabase.from('users_registry').insert([initial]);
                if (!error) { setFormData({ ...formData, newEmail: '' }); fetchData(); }
                else alert(error.message);
            };

            const toggleTabForUser = async (email, tab) => {
                const user = registry.find(u => u.email === email);
                if (!user) return;
                const currentTabs = user.allowed_tabs || [];
                const newTabs = currentTabs.includes(tab) ? currentTabs.filter(t => t !== tab) : [...currentTabs, tab];
                const { error } = await supabase.from('users_registry').update({ allowed_tabs: newTabs }).eq('email', email);
                if (!error) fetchData();
            };

            const handleEditTask = (task) => {
                setNewTaskType(task.type);
                setFormData({ ...(task.details || {}), status: task.status });
                setEditingTaskId(task.id);
                setIsFormOpen(true);
            };

            // PIP Handlers
            const handleSavePip = async (e) => {
                e.preventDefault();
                if(!pipData.mentorName || !pipData.mentorEmail || !pipData.startDate || !pipData.reason) {
                    return alert("Please fill the required fields: Mentor Name, Mentor Email, Start Date, Reason.");
                }

                let agent = session.user.email.split('@')[0];
                let creationDate = new Date().toISOString();
                const isNew = !pipData.id;
                
                if (!isNew) {
                    const originalTask = tasks.find(t => t.id === pipData.id);
                    if (originalTask) {
                        agent = originalTask.agent;
                        creationDate = originalTask.date;
                    }
                }

                const taskData = { 
                    type: 'pip', 
                    title: 'PIP Record', 
                    agent: agent, 
                    status: pipData.status || 'Active', 
                    details: pipData, 
                    date: creationDate 
                };

                const { data, error } = pipData.id 
                    ? await supabase.from('tasks').update(taskData).eq('id', pipData.id).select() 
                    : await supabase.from('tasks').insert([taskData]).select();

                if (!error) { 
                    const savedTask = data ? data[0] : null;

                    // Send email notification for newly created PIPs
                    if (isNew && pipData.mentorEmail && savedTask && GOOGLE_SCRIPT_URL) {
                        const noticeDate = new Date(pipData.startDate);
                        noticeDate.setDate(noticeDate.getDate() + 28);
                        const estimatedEndDate = noticeDate.toLocaleDateString();
                        
                        const baseUrl = window.location.href.split('?')[0];
                        const recordUrl = `${baseUrl}?tab=pip&taskId=${savedTask.id}`;

                        const emailBody = `Hello ${pipData.mentorName},\n\nThis is a formal notification regarding the initiation of a Performance Improvement Plan (PIP).\n\nStart Date: ${new Date(pipData.startDate).toLocaleDateString()}\nEstimated End Date: ${estimatedEndDate}\n\nReason for PIP:\n${pipData.reason}\n\nImprovement Goals (Criteria for Success):\n${pipData.goals || 'N/A'}\n\nPlease review these details securely via the following direct link to your MentorOps portal:\n${recordUrl}\n\nBest regards,\nTempo Management`;
                        
                        const payload = JSON.stringify({
                            to: `${pipData.mentorEmail}, khaledsabban@tempo.fit, salmaramadan@tempo.fit`,
                            subject: `Notice: Performance Improvement Plan (PIP) Initiated - ${pipData.mentorName}`,
                            body: emailBody
                        });

                        const success = navigator.sendBeacon(GOOGLE_SCRIPT_URL, payload);

                        if (!success) {
                            try {
                                await fetch(GOOGLE_SCRIPT_URL, {
                                    method: 'POST', mode: 'no-cors', credentials: 'include',
                                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                    body: payload
                                });
                            } catch (err) {
                                console.error("Email failed:", err);
                            }
                        }
                    }

                    setIsPipModalOpen(false); 
                    setPipData({}); 
                    fetchData(); 
                } else {
                    alert(error.message);
                }
            };

            // Warning Handlers
            const handleSaveWarning = async (e) => {
                e.preventDefault();
                if(!warningData.mentorName || !warningData.mentorEmail || !warningData.warningType || !warningData.warningReason || !warningData.date) {
                    return alert("Please fill all required fields.");
                }

                let agent = session.user.email.split('@')[0];
                let creationDate = new Date().toISOString();
                const isNew = !warningData.id;
                
                if (!isNew) {
                    const originalTask = tasks.find(t => t.id === warningData.id);
                    if (originalTask) {
                        agent = originalTask.agent;
                        creationDate = originalTask.date;
                    }
                }

                // Calculate expiration date (3 months from notice date)
                const noticeDate = new Date(warningData.date);
                noticeDate.setMonth(noticeDate.getMonth() + 3);
                const expirationDate = noticeDate.toISOString().split('T')[0];
                
                const finalWarningData = { ...warningData, expirationDate };

                const taskData = { 
                    type: 'warning', 
                    title: 'Warning Record', 
                    agent: agent, 
                    status: 'Issued', 
                    details: finalWarningData, 
                    date: creationDate 
                };

                const { data, error } = warningData.id 
                    ? await supabase.from('tasks').update(taskData).eq('id', warningData.id).select() 
                    : await supabase.from('tasks').insert([taskData]).select();

                if (!error) { 
                    const savedTask = data ? data[0] : null;

                    // Send email notification for newly created warnings
                    if (isNew && warningData.mentorEmail && savedTask && GOOGLE_SCRIPT_URL) {
                        const baseUrl = window.location.href.split('?')[0];
                        const recordUrl = `${baseUrl}?tab=warnings&taskId=${savedTask.id}`;
                        
                        const emailBody = `Hello ${warningData.mentorName},\n\nThis is a formal notification regarding a ${warningData.warningType} Warning.\n\nReason: ${warningData.warningReason}\nDate of Notice: ${warningData.date}\nExpiration Date: ${expirationDate}\n\nDetails:\n${warningData.notes}\n\nPlease review these details securely via the following direct link to your MentorOps portal:\n${recordUrl}\n\nBest regards,\nTempo Management`;
                        
                        // We construct the "to" field with the mentor and the requested CCs to ensure delivery 
                        const payload = JSON.stringify({
                            to: `${warningData.mentorEmail}, khaledsabban@tempo.fit, salmaramadan@tempo.fit`,
                            subject: `Disciplinary Notice: ${warningData.warningType} Warning - ${warningData.mentorName}`,
                            body: emailBody
                        });

                        const success = navigator.sendBeacon(GOOGLE_SCRIPT_URL, payload);

                        if (!success) {
                            try {
                                await fetch(GOOGLE_SCRIPT_URL, {
                                    method: 'POST', mode: 'no-cors', credentials: 'include',
                                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                    body: payload
                                });
                            } catch (err) {
                                console.error("Email failed:", err);
                            }
                        }
                    }

                    setIsWarningModalOpen(false); 
                    setWarningData({}); 
                    fetchData(); 
                } else {
                    alert(error.message);
                }
            };

            const handleDeleteTask = async (id) => {
                if (confirm("Are you sure you want to permanently delete this record?")) {
                    const { error } = await supabase.from('tasks').delete().eq('id', id);
                    if (!error) {
                        setIsPipModalOpen(false);
                        setIsWarningModalOpen(false);
                        setIsFormOpen(false);
                        fetchData();
                    } else {
                        alert(error.message);
                    }
                }
            };

            // Evaluation Logics
            const handleAuditScore = (attrId, achieved) => {
                const scores = { ...(formData.auditScores || {}), [attrId]: achieved };
                let total = 0;
                auditAttributes.forEach(attr => { if (scores[attr.id] === 'Yes') total += attr.weight; });
                setFormData(prev => ({ ...prev, auditScores: scores, overallAuditScore: total }));
            };

            const handleQuizScore = (mId, s) => {
                const scores = { ...(formData.quizScores || {}), [mId]: parseInt(s) };
                const values = Object.values(scores);
                const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '0.0';
                setFormData(prev => ({ ...prev, quizScores: scores, overallScore: avg }));
            };

            const handleAddTask = async (e) => {
                e.preventDefault();
                const requiredFields = categories[newTaskType].fields;
                const missingFields = [];
                requiredFields.forEach(f => {
                    if (f === 'correctionModule') { quizModules.forEach(m => { if (!(formData.quizScores?.[m.id])) missingFields.push(m.title); }); return; }
                    if (f === 'auditModule') { auditAttributes.forEach(a => { if (!(formData.auditScores?.[a.id])) missingFields.push(a.label); }); return; }
                    if (newTaskType === 'hip_request' && formData.status === 'Pending' && f === 'pendingReasonDetail' && !formData[f]) { missingFields.push("Pending Reason Detail"); return; }
                    if (newTaskType === 'floorwalker' && formData.validRequest === 'No' && f === 'invalidReason' && !formData[f]) { missingFields.push("Invalid Reason Detail"); return; }
                    if (f === 'pendingReasonDetail' || f === 'invalidReason') return; 
                    if (!formData[f] || formData[f] === '') missingFields.push(f.replace(/([A-Z])/g, ' $1'));
                });
                if (missingFields.length > 0) return alert("Required: " + missingFields.join(', '));

                let agent = session.user.email.split('@')[0];
                let creationDate = new Date().toISOString();
                const isNew = !editingTaskId;

                if (!isNew) {
                    const originalTask = tasks.find(t => t.id === editingTaskId);
                    if (originalTask) {
                        agent = originalTask.agent;
                        creationDate = originalTask.date;
                    }
                }

                let finalStatus = formData.status || 'Pending';
                if (autoResolvedTypes.includes(newTaskType)) finalStatus = 'Resolved';
                if (newTaskType === 'disputes' && (formData.resolution === 'Won' || formData.resolution === 'Lost')) finalStatus = 'Resolved';

                let emailDeliveryStatus = 'N/A';
                if (newTaskType === 'weekly_quiz' && formData.associateEmail) {
                    emailDeliveryStatus = 'Queued';
                }

                const taskData = { 
                    type: newTaskType, title: categories[newTaskType].label + ' Log', 
                    agent: agent, status: finalStatus, 
                    details: { ...formData, status: finalStatus, email_delivery_status: emailDeliveryStatus }, 
                    date: creationDate 
                };

                const { data, error } = editingTaskId 
                    ? await supabase.from('tasks').update(taskData).eq('id', editingTaskId).select() 
                    : await supabase.from('tasks').insert([taskData]).select();

                if (!error) { 
                    const savedTask = data ? data[0] : null;

                    // Email logic for Weekly Quiz
                    if (newTaskType === 'weekly_quiz' && formData.associateEmail && savedTask && GOOGLE_SCRIPT_URL) {
                        const breakdown = quizModules.map(m => {
                            const score = formData.quizScores?.[m.id];
                            const comment = formData.quizComments?.[m.id];
                            let entry = `â€¢ ${m.title}: ${score !== undefined ? score : 0}/5`;
                            if (comment) entry += `\n   Note: ${comment}`;
                            return entry;
                        }).join('\n\n');

                        const emailBody = `Hello ${formData.associateName},\n\nHere are the results of your Weekly Quiz submitted on ${formData.date}.\n\nOverall Score: ${formData.overallScore}\n\nDetailed Breakdown:\n-----------------------------------\n${breakdown}\n-----------------------------------\n\nBest regards,\n${session.user.email}`;
                        
                        const payload = JSON.stringify({
                            to: formData.associateEmail,
                            subject: `Weekly Quiz Results - ${formData.date}`,
                            body: emailBody
                        });

                        const success = navigator.sendBeacon(GOOGLE_SCRIPT_URL, payload);

                        if (success) {
                            await supabase.from('tasks').update({ 
                                details: { ...savedTask.details, email_delivery_status: 'Sent' } 
                            }).eq('id', savedTask.id);
                            alert(`Quiz recorded! Email request queued for ${formData.associateEmail}.`);
                        } else {
                            try {
                                await fetch(GOOGLE_SCRIPT_URL, {
                                    method: 'POST', mode: 'no-cors', credentials: 'include',
                                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                    body: payload
                                });
                                await supabase.from('tasks').update({ 
                                    details: { ...savedTask.details, email_delivery_status: 'Sent' } 
                                }).eq('id', savedTask.id);
                                alert(`Quiz recorded! Email triggered via backup method.`);
                            } catch (err) {
                                await supabase.from('tasks').update({ 
                                    details: { ...savedTask.details, email_delivery_status: 'Failed' } 
                                }).eq('id', savedTask.id);
                                console.error("Email failed:", err);
                                alert("Quiz saved, but email trigger failed.");
                            }
                        }
                    }

                    // Email logic for Mentor Audit
                    if (isNew && newTaskType === 'mentor_audit' && formData.mentorEmail && savedTask && GOOGLE_SCRIPT_URL) {
                        const baseUrl = window.location.href.split('?')[0];
                        const recordUrl = `${baseUrl}?tab=dashboard&taskId=${savedTask.id}`; 
                        
                        let emailBody = `Hello ${formData.mentorName},\n\nA new Audit has been submitted regarding your recent support interaction.\n\n`;
                        emailBody += `Overall Score: ${formData.overallAuditScore || 0}%\n`;
                        emailBody += `Reference Ticket: ${formData.auditedTicket || formData.hipLogReference || 'N/A'}\n\n`;
                        emailBody += `Please review your complete audit breakdown and performance metrics in your Tempo MentorOps dashboard via this link:\n${recordUrl}\n\nBest regards,\nTempo Management`;

                        const payload = JSON.stringify({
                            to: formData.mentorEmail, // "alert only the audited mentor"
                            subject: `Notice: Mentor Audit Score Available - ${formData.mentorName}`,
                            body: emailBody
                        });

                        const success = navigator.sendBeacon(GOOGLE_SCRIPT_URL, payload);
                        if (!success) {
                            try {
                                await fetch(GOOGLE_SCRIPT_URL, {
                                    method: 'POST', mode: 'no-cors', credentials: 'include',
                                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                    body: payload
                                });
                            } catch (err) {}
                        }
                    }

                    setIsFormOpen(false); setFormData({}); setEditingTaskId(null); fetchData(); 
                }
                else alert(error.message);
            };

            // Analytics Lifecycle
            useEffect(() => {
                if (activeTab === 'analytics' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    let filteredData = tasks.filter(t => t.type === analyticsCategory);
                    if (analyticsDateRange.start) filteredData = filteredData.filter(t => new Date(t.date) >= new Date(analyticsDateRange.start));
                    if (analyticsDateRange.end) {
                        const end = new Date(analyticsDateRange.end); end.setHours(23,59,59);
                        filteredData = filteredData.filter(t => new Date(t.date) <= end);
                    }
                    const counts = {};
                    filteredData.forEach(t => {
                        let value = ['status', 'agent'].includes(analyticsField) ? t[analyticsField] : t.details?.[analyticsField] || 'N/A';
                        counts[value] = (counts[value] || 0) + 1;
                    });
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                data: Object.values(counts),
                                backgroundColor: isDarkMode ? 'rgba(37, 99, 235, 0.8)' : 'rgba(37, 99, 235, 0.7)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: isDarkMode ? '#334155' : '#f1f5f9' }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } },
                                x: { grid: { display: false }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } }
                            }
                        }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [activeTab, analyticsCategory, analyticsField, analyticsDateRange, tasks, isDarkMode]);

            const saveGlobalConfig = async (newConfig) => {
                const { error } = await supabase.from('app_config').upsert({ id: 1, ...newConfig });
                if (error) alert("Error saving config: " + error.message);
                else alert("Saved to database!");
            };

            const handleInputChange = (field, value) => {
                if (value === 'ADD_NEW_CUSTOM') setCustomInputTarget(field);
                else { setFormData(prev => ({ ...prev, [field]: value })); setCustomInputTarget(null); }
            };

            const handleAddCustomValue = (field, newValue) => {
                if (!newValue.trim()) return;
                setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), newValue] }));
                handleInputChange(field, newValue);
            };

            const toggleReportColumn = (column) => {
                if (selectedReportColumns.includes(column)) {
                    setSelectedReportColumns(selectedReportColumns.filter(c => c !== column));
                } else {
                    setSelectedReportColumns([...selectedReportColumns, column]);
                }
            };

            const downloadCSV = () => {
                if (!generatedReport || generatedReport.length === 0) return;
                const headers = selectedReportColumns.join(',');
                const rows = generatedReport.map(t => {
                    return selectedReportColumns.map(col => {
                        let val = t[col] || t.details?.[col] || '';
                        if (col === 'type') val = categories[t.type]?.label || t.type;
                        return `"${String(val).replace(/"/g, '""')}"`;
                    }).join(',');
                }).join('\n');
                const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "tempo_report.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleGenerateReport = () => {
                let filtered = tasks;
                if (reportFilters.category !== 'all') filtered = filtered.filter(t => t.type === reportFilters.category);
                if (reportFilters.agent !== 'all') filtered = filtered.filter(t => t.agent === reportFilters.agent);
                if (reportFilters.startDate) filtered = filtered.filter(t => new Date(t.date) >= new Date(reportFilters.startDate));
                if (reportFilters.endDate) { const end = new Date(reportFilters.endDate); end.setHours(23,59,59); filtered = filtered.filter(t => new Date(t.date) <= end); }
                setGeneratedReport(filtered);
            };

            const searchedPendingTasks = tasks.filter(t => {
                if (t.status !== 'Pending') return false;
                if (dashboardCategory !== 'all' && t.type !== dashboardCategory) return false;
                const searchStr = (JSON.stringify(t) + " " + JSON.stringify(t.details)).toLowerCase();
                return searchStr.includes(dashboardSearch.toLowerCase());
            });

            const pendingGroups = searchedPendingTasks.reduce((acc, t) => {
                if (!acc[t.type]) acc[t.type] = [];
                acc[t.type].push(t);
                return acc;
            }, {});

            // Handle Dynamic Tabs Visibility
            const getVisibleTabs = () => {
                if (!userProfile) return defaultTabs;
                
                const baseTabs = userProfile.allowed_tabs || defaultTabs;
                const finalTabs = [...baseTabs];
                
                const isAdmin = userProfile.role === 'Admin';
                const hasMyPips = tasks.some(t => t.type === 'pip' && t.details?.mentorEmail === userProfile.email);
                const hasMyWarnings = tasks.some(t => t.type === 'warning' && t.details?.mentorEmail === userProfile.email);
                
                if ((isAdmin || hasMyPips) && !finalTabs.includes('pip')) finalTabs.push('pip');
                if ((isAdmin || hasMyWarnings) && !finalTabs.includes('warnings')) finalTabs.push('warnings');
                if (isAdmin && !finalTabs.includes('audits')) finalTabs.push('audits');
                
                return Array.from(new Set(finalTabs));
            };
            const visibleTabs = getVisibleTabs();

            const getEndDate = (startDate) => {
                if(!startDate) return '';
                const d = new Date(startDate);
                d.setDate(d.getDate() + 28);
                return d.toLocaleDateString();
            };

            // Calculated Audit Data for Dashboard
            const myDashboardAudits = tasks.filter(t => t.type === 'mentor_audit' && t.details?.mentorName === auditDashMentor);
            const myFilteredAudits = myDashboardAudits.filter(t => {
                if (!auditDashRange.start && !auditDashRange.end) return true;
                const d = new Date(t.date);
                const start = auditDashRange.start ? new Date(auditDashRange.start) : new Date('2000-01-01');
                const end = auditDashRange.end ? new Date(auditDashRange.end) : new Date('2100-01-01');
                end.setHours(23, 59, 59);
                return d >= start && d <= end;
            });
            const myAvgAuditScore = myFilteredAudits.length ? (myFilteredAudits.reduce((acc, curr) => acc + (parseInt(curr.details?.overallAuditScore) || 0), 0) / myFilteredAudits.length).toFixed(1) : 0;
            
            // ReadOnly Form state logic for Mentors reviewing Audits
            const isAuditReadOnly = newTaskType === 'mentor_audit' && userProfile?.role !== 'Admin';

            if (!session) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-center">
                        <Card className="p-10 max-w-md w-full shadow-2xl">
                            <h1 className="text-4xl font-black italic tracking-tighter mb-2 dark:text-white uppercase font-bold">TEMPO</h1>
                            <p className="text-slate-500 mb-8 font-medium uppercase text-[10px] tracking-widest">Mentor Operations Center</p>
                            <form onSubmit={handleAuth} className="space-y-4 text-left font-bold">
                                {authView !== 'reset' && (
                                    <input type="email" required className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="Email" value={authEmail} onChange={e => setAuthEmail(e.target.value)} />
                                )}
                                <input type="password" required className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={authPassword} onChange={e => setAuthPassword(e.target.value)} />
                                <button type="submit" disabled={authLoading} className="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase hover:bg-blue-700 shadow-xl transition-all font-bold">Sign In</button>
                            </form>
                            <div className="mt-4">
                                <div className="relative py-4"><div className="absolute inset-0 flex items-center"><span className="w-full border-t dark:border-slate-800"></span></div><div className="relative flex justify-center text-xs uppercase font-bold"><span className="bg-white dark:bg-slate-900 px-2 text-slate-400 font-bold">Or</span></div></div>
                                <button onClick={handleGoogleLogin} className="w-full flex items-center justify-center gap-3 py-3 border border-slate-200 dark:border-slate-800 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold dark:text-white">
                                    <img src="https://www.google.com/favicon.ico" className="h-4 w-4" /> Google Account
                                </button>
                            </div>
                            <div className="mt-6 pt-6 border-t dark:border-slate-800 flex flex-col gap-3 font-bold">
                                {authView === 'login' ? (
                                    <><button onClick={() => setAuthView('signup')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase">First Time? Register</button>
                                    <button onClick={() => setAuthView('forgot')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter">Forgot Password?</button></>
                                ) : <button onClick={() => setAuthView('login')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase">Back</button>}
                            </div>
                        </Card>
                    </div>
                );
            }

            if (userProfile?.error) return <div className="flex flex-col h-screen items-center justify-center font-bold gap-4 p-8 text-center">{userProfile.message} <button onClick={() => supabase.auth.signOut()} className="px-8 py-2 bg-blue-600 text-white rounded">Logout</button></div>;
            if (!userProfile) return <div className="flex h-screen items-center justify-center font-bold">Verifying authorization profile...</div>;

            // Admin Logic: Identify dropdowns belonging to the chosen task type
            const adminDropdowns = (adminValidationCategories[adminSelectedTaskType]?.fields || []).filter(f => ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'validHip', 'validRequest', 'subscriptionStatus', 'emailSent', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail', 'warningReason'].includes(f));

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
                            <div className="flex items-center gap-3"><h1 className="text-xl font-bold tracking-widest uppercase italic dark:text-white">Tempo</h1><Badge color={userProfile.role === 'Admin' ? 'purple' : 'slate'}>{userProfile.role}</Badge></div>
                            <nav className="flex gap-1 overflow-x-auto no-scrollbar">{visibleTabs.map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-xs font-black rounded-lg transition-colors uppercase tracking-widest whitespace-nowrap ${activeTab === tab ? 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>{tab.replace('_', ' ')}</button>))}</nav>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-slate-400 hover:text-blue-500 transition-colors">{isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-slate-200 transition-colors"><SettingsIcon className="h-5 w-5" /></button>
                                <div className={`h-2 w-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500' : 'bg-rose-500 animate-pulse'}`} />
                                <div className="text-right hidden md:block">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter leading-none dark:text-slate-500 font-bold">Identity</p>
                                    <p className="text-xs font-black leading-none dark:text-slate-200">{userProfile.email.split('@')[0]}</p>
                                </div>
                                <button onClick={() => supabase.auth.signOut()} className="p-2 text-slate-400 hover:text-rose-500 transition-colors"><LogOut className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in font-bold">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card className="p-6 border-l-4 border-l-blue-500 shadow-sm"><p className="text-slate-500 dark:text-slate-400 text-[10px] font-black uppercase mb-1">Lifetime Records</p><h3 className="text-4xl font-bold text-black dark:text-white">{tasks.filter(t => t.type !== 'pip' && t.type !== 'warning').length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-rose-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Pending Actions</p><h3 className="text-4xl font-bold text-rose-600">{tasks.filter(t => t.status === 'Pending' && t.type !== 'pip' && t.type !== 'warning').length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-emerald-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Resolved Today</p><h3 className="text-4xl font-bold text-emerald-600">{tasks.filter(t => t.status !== 'Pending' && t.type !== 'pip' && t.type !== 'warning' && new Date(t.date).toDateString() === new Date().toDateString()).length}</h3></Card>
                                </div>

                                {/* Task Buttons Priority above pending actions (Filter out mentor_audit so it strictly stays in the Audits tab for creation) */}
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                                    {Object.entries(categories).filter(([key]) => key !== 'mentor_audit').map(([key, cfg]) => (
                                        <button key={key} onClick={() => { setNewTaskType(key); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="p-4 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-xl text-center hover:shadow-md transition-all group"><div className={`h-10 w-10 mx-auto rounded-lg flex items-center justify-center mb-2 bg-${cfg.color}-100 dark:bg-${cfg.color}-900/30`}>{React.createElement(cfg.icon, { className: `h-5 w-5 text-${cfg.color}-600` })}</div><p className="text-[9px] font-black text-slate-500 uppercase font-bold">{cfg.label}</p><p className="text-lg font-black dark:text-white font-bold">{tasks.filter(t => t.type === key).length}</p></button>
                                    ))}
                                </div>

                                {/* Collapsible Pending Actions Section */}
                                <div className="space-y-4">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => setIsPendingCollapsed(!isPendingCollapsed)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-colors">
                                                {isPendingCollapsed ? <ChevronDown className="h-5 w-5" /> : <ChevronUp className="h-5 w-5" />}
                                            </button>
                                            <h2 className="text-xl font-black uppercase tracking-tight dark:text-slate-200">Pending Actions</h2>
                                        </div>
                                        <div className="flex gap-2 w-full sm:w-auto">
                                            <select className="px-3 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-lg outline-none dark:text-slate-300 font-bold" value={dashboardCategory} onChange={e => setDashboardCategory(e.target.value)}>
                                                <option value="all">All Types</option>
                                                {Object.entries(categories).filter(([k]) => k !== 'mentor_audit').map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                                            </select>
                                            <div className="relative flex-1 sm:w-64">
                                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400" />
                                                <input type="text" placeholder="Deep Search entries..." className="w-full pl-9 pr-4 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-lg outline-none focus:ring-1 focus:ring-blue-500 dark:text-slate-200" value={dashboardSearch} onChange={e => setDashboardSearch(e.target.value)} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {!isPendingCollapsed && (
                                        <div className="space-y-4 font-bold animate-fade-in">
                                            {Object.keys(pendingGroups).length > 0 ? Object.entries(pendingGroups).map(([type, groupTasks]) => (
                                                <div key={type} className="bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-xl overflow-hidden shadow-sm transition-all">
                                                    <button onClick={() => togglePendingGroup(type)} className="w-full flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                                        <div className="flex items-center gap-4">
                                                            <div className={`h-10 w-10 rounded-lg flex items-center justify-center bg-${categories[type]?.color || 'slate'}-100 dark:bg-${categories[type]?.color || 'slate'}-900/30`}>
                                                                {categories[type]?.icon ? React.createElement(categories[type].icon, { className: `h-5 w-5 text-${categories[type].color}-600` }) : <AlertCircle className="h-5 w-5 text-slate-600" />}
                                                            </div>
                                                            <div className="text-left">
                                                                <h3 className="text-sm font-black uppercase dark:text-slate-200">{categories[type]?.label || type}</h3>
                                                                <p className="text-[10px] text-slate-500">{groupTasks.length} pending action{groupTasks.length > 1 ? 's' : ''}</p>
                                                            </div>
                                                        </div>
                                                        {expandedPendingGroups[type] ? <ChevronUp className="h-5 w-5 text-slate-400" /> : <ChevronDown className="h-5 w-5 text-slate-400" />}
                                                    </button>
                                                    
                                                    {expandedPendingGroups[type] && (
                                                        <div className="border-t dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 divide-y dark:divide-slate-800">
                                                            {groupTasks.map(t => (
                                                                <div key={t.id} className="flex flex-col sm:flex-row sm:items-center justify-between p-4 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors gap-4">
                                                                    <div className="flex items-center gap-4 pl-2 sm:pl-4">
                                                                        <div className={`w-2 h-2 rounded-full bg-${categories[t.type]?.color || 'slate'}-500`}></div>
                                                                        <div>
                                                                            <p className="text-xs font-bold dark:text-slate-300">Owner: {t.agent}</p>
                                                                            <p className="text-[10px] text-slate-400">{new Date(t.date).toLocaleDateString()}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-4">
                                                                        {t.status === 'Pending' && t.details?.pendingReasonDetail && <Badge color="amber">{t.details.pendingReasonDetail}</Badge>}
                                                                        <button onClick={() => handleEditTask(t)} className="px-4 py-2 bg-white dark:bg-slate-900 border dark:border-slate-700 text-[10px] font-black uppercase tracking-widest rounded-lg hover:border-blue-500 dark:hover:border-blue-500 hover:text-blue-500 transition-colors shadow-sm">EDIT â†’</button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )) : <div className="p-8 text-center border-2 border-dashed dark:border-slate-800 rounded-2xl text-slate-400 uppercase text-[10px] font-black tracking-widest font-bold">No matching pending tasks</div>}
                                        </div>
                                    )}
                                </div>

                                {/* MENTOR PERFORMANCE DASHBOARD WIDGET */}
                                <div className="mt-12 pt-8 border-t dark:border-slate-800 space-y-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                        <h2 className="text-xl font-black uppercase tracking-tight dark:text-slate-200 flex items-center gap-2">
                                            <UserCheck className="h-6 w-6 text-emerald-500" /> Audit Performance Dashboard
                                        </h2>
                                        <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                                            {userProfile.role === 'Admin' ? (
                                                <select className="px-3 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-lg outline-none dark:text-slate-300 font-bold" value={auditDashMentor} onChange={e => setAuditDashMentor(e.target.value)}>
                                                    <option value="" disabled>Select Mentor</option>
                                                    {globalMentors.map(m => <option key={m} value={m}>{m}</option>)}
                                                </select>
                                            ) : (
                                                <div className="px-3 py-2 text-xs bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 rounded-lg font-bold text-slate-500 dark:text-slate-400">{auditDashMentor || 'My Dashboard'}</div>
                                            )}
                                            <div className="flex items-center gap-1">
                                                <input type="date" className="px-3 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-lg outline-none dark:text-slate-300" value={auditDashRange.start} onChange={e => setAuditDashRange(p => ({...p, start: e.target.value}))} title="Start Date" />
                                                <span className="text-slate-400 text-xs">-</span>
                                                <input type="date" className="px-3 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-lg outline-none dark:text-slate-300" value={auditDashRange.end} onChange={e => setAuditDashRange(p => ({...p, end: e.target.value}))} title="End Date" />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <Card className="p-6 bg-gradient-to-br from-emerald-500 to-emerald-600 dark:from-emerald-600 dark:to-emerald-800 text-white shadow-lg border-none relative overflow-hidden">
                                            <div className="relative z-10">
                                                <p className="text-[10px] font-black uppercase mb-1 opacity-80 tracking-widest">Average Overall Score</p>
                                                <h3 className="text-5xl font-black">{myAvgAuditScore}%</h3>
                                                <p className="text-xs font-medium mt-2 opacity-90">{auditDashMentor}</p>
                                            </div>
                                            <UserCheck className="absolute -bottom-4 -right-4 h-32 w-32 opacity-20" />
                                        </Card>
                                        <Card className="p-6 border-l-4 border-l-emerald-500 flex flex-col justify-center">
                                            <p className="text-slate-500 dark:text-slate-400 text-[10px] font-black uppercase mb-1 tracking-widest">Audits in Selected Range</p>
                                            <h3 className="text-4xl font-bold dark:text-white">{myFilteredAudits.length}</h3>
                                        </Card>
                                    </div>
                                    
                                    <Card className="overflow-hidden">
                                        <div className="p-4 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700">
                                            <h3 className="text-xs font-black uppercase tracking-widest text-slate-500">Filtered Audit Log</h3>
                                        </div>
                                        <table className="w-full text-left text-sm font-bold">
                                            <thead className="bg-slate-50/50 dark:bg-slate-800/50 text-[10px] uppercase tracking-widest text-slate-400">
                                                <tr>
                                                    <th className="px-6 py-4">Date</th>
                                                    <th className="px-6 py-4">Ticket Ref</th>
                                                    <th className="px-6 py-4">Score</th>
                                                    <th className="px-6 py-4 text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y dark:divide-slate-800">
                                                {myFilteredAudits.map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                                        <td className="px-6 py-4 dark:text-slate-300">{new Date(t.date).toLocaleDateString()}</td>
                                                        <td className="px-6 py-4 text-blue-500 font-medium text-xs">{t.details?.auditedTicket || t.details?.hipLogReference || 'N/A'}</td>
                                                        <td className="px-6 py-4"><Badge color={t.details?.overallAuditScore >= 80 ? 'green' : t.details?.overallAuditScore >= 60 ? 'amber' : 'red'}>{t.details?.overallAuditScore || 0}%</Badge></td>
                                                        <td className="px-6 py-4 text-right">
                                                            <button onClick={() => handleEditTask(t)} className="px-3 py-1.5 bg-white dark:bg-slate-900 border dark:border-slate-700 text-[10px] font-black uppercase tracking-widest rounded-lg hover:border-emerald-500 hover:text-emerald-500 transition-colors shadow-sm">View Details</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {myFilteredAudits.length === 0 && (
                                                    <tr>
                                                        <td colSpan="4" className="px-6 py-8 text-center text-slate-400 text-xs uppercase tracking-widest">No audits found in this range.</td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {activeTab === 'audits' && userProfile.role === 'Admin' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <div className="flex justify-between items-center bg-white dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-800">
                                    <div>
                                        <h2 className="text-xl font-black uppercase tracking-widest dark:text-white flex items-center gap-3">
                                            <UserCheck className="h-6 w-6 text-emerald-600" /> 
                                            Mentor Audits Management
                                        </h2>
                                        <p className="text-xs text-slate-500 uppercase mt-2 tracking-tighter">Conduct and review all mentor audits.</p>
                                    </div>
                                    <button onClick={() => { setNewTaskType('mentor_audit'); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="px-5 py-3 bg-emerald-600 hover:bg-emerald-700 transition-colors text-white rounded-xl text-xs font-black uppercase tracking-widest">
                                        + NEW AUDIT
                                    </button>
                                </div>
                                
                                <Card className="overflow-hidden">
                                    <div className="p-4 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 flex justify-between items-center">
                                        <h3 className="text-xs font-black uppercase tracking-widest text-slate-500">Audit Master Log</h3>
                                        <div className="relative">
                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400" />
                                            <input type="text" placeholder="Search audits..." className="pl-9 pr-4 py-2 text-xs bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-lg outline-none focus:ring-1 focus:ring-emerald-500 dark:text-white" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        </div>
                                    </div>
                                    <table className="w-full text-left text-sm font-bold">
                                        <thead className="bg-slate-50/50 dark:bg-slate-800/50 text-[10px] uppercase tracking-widest text-slate-400">
                                            <tr>
                                                <th className="px-6 py-4">Date</th>
                                                <th className="px-6 py-4">Mentor Name</th>
                                                <th className="px-6 py-4">Audited By</th>
                                                <th className="px-6 py-4">Score</th>
                                                <th className="px-6 py-4 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y dark:divide-slate-800">
                                            {tasks.filter(t => t.type === 'mentor_audit' && (t.details?.mentorName?.toLowerCase().includes(searchTerm.toLowerCase()) || t.agent.toLowerCase().includes(searchTerm.toLowerCase()))).map(t => (
                                                <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                                    <td className="px-6 py-4 dark:text-slate-300">{new Date(t.date).toLocaleDateString()}</td>
                                                    <td className="px-6 py-4 font-bold dark:text-slate-200">{t.details?.mentorName}</td>
                                                    <td className="px-6 py-4 text-slate-500 text-xs">{t.agent}</td>
                                                    <td className="px-6 py-4"><Badge color={t.details?.overallAuditScore >= 80 ? 'green' : t.details?.overallAuditScore >= 60 ? 'amber' : 'red'}>{t.details?.overallAuditScore || 0}%</Badge></td>
                                                    <td className="px-6 py-4 text-right">
                                                        <button onClick={() => handleEditTask(t)} className="p-2 text-slate-400 hover:text-emerald-500 transition-colors"><Edit className="h-4 w-4 inline" /></button>
                                                        <button onClick={() => handleDeleteTask(t.id)} className="p-2 text-slate-400 hover:text-rose-500 transition-colors ml-2"><Trash className="h-4 w-4 inline" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-4 animate-fade-in font-bold">
                                <div className="flex justify-between bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 font-bold"><div className="relative flex-1 max-w-md font-bold"><Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" /><input type="text" placeholder="Search logs..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg outline-none font-bold" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div><button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-black uppercase tracking-widest font-bold">+ NEW ENTRY</button></div>
                                <Card className="overflow-hidden">
                                    <table className="w-full text-left text-sm font-bold"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 font-bold"><tr><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Category</th><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Original Agent</th><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Status</th><th className="px-6 py-4 text-right dark:text-slate-300 uppercase font-black text-[10px] font-bold">Actions</th></tr></thead>
                                        <tbody className="divide-y dark:divide-slate-800 font-bold">{tasks.filter(t => t.type !== 'pip' && t.type !== 'warning' && t.type !== 'mentor_audit' && ((categories[t.type]?.label || '').toLowerCase().includes(searchTerm.toLowerCase()) || t.agent.toLowerCase().includes(searchTerm.toLowerCase()))).slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage).map(t => (<tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold"><td className="px-6 py-4 font-bold dark:text-slate-200">{categories[t.type]?.label}</td><td className="px-6 py-4 dark:text-slate-400 font-bold">{t.agent}</td><td className="px-6 py-4 font-bold"><Badge color={t.status === 'Pending' ? 'amber' : (['Resolved', 'Won', 'Activated'].includes(t.status) ? 'green' : 'slate')}>{t.status}</Badge></td><td className="px-6 py-4 text-right font-bold"><button onClick={() => handleEditTask(t)} className="p-2 text-slate-400 hover:text-blue-600 transition-colors font-bold"><Edit className="h-4 w-4" /></button></td></tr>))}</tbody>
                                    </table>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <Card className="p-6 font-bold">
                                    <div className="flex items-center gap-3 mb-6 font-bold"><BarChart3 className="h-6 w-6 text-blue-600" /><h2 className="text-xl font-bold uppercase tracking-widest dark:text-white font-bold">Analytics</h2></div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 font-bold">
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsCategory} onChange={e => setAnalyticsCategory(e.target.value)}>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsField} onChange={e => setAnalyticsField(e.target.value)}><option value="status">Status</option><option value="agent">Agent</option>{categories[analyticsCategory]?.fields.filter(f => !f.includes('Module')).map(f => <option key={f} value={f}>{f.replace(/([A-Z])/g, ' $1')}</option>)}</select>
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsDateRange.start} onChange={e => setAnalyticsDateRange(p => ({...p, start: e.target.value}))} />
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsDateRange.end} onChange={e => setAnalyticsDateRange(p => ({...p, end: e.target.value}))} />
                                    </div>
                                    <div className="h-[400px] flex items-center justify-center p-4 bg-slate-50 dark:bg-slate-800 rounded-xl relative font-bold"><canvas ref={chartRef}></canvas></div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <Card className="p-6 space-y-6 font-bold">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 font-bold">
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.category} onChange={e => setReportFilters(f => ({ ...f, category: e.target.value }))}><option value="all">All Types</option>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.agent} onChange={e => setReportFilters(f => ({ ...f, agent: e.target.value }))}><option value="all">All Mentors</option>{globalMentors.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.startDate} onChange={e => setReportFilters(f => ({ ...f, startDate: e.target.value }))} />
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.endDate} onChange={e => setReportFilters(f => ({ ...f, endDate: e.target.value }))} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 pt-2 border-t dark:border-slate-800 border-slate-100 font-bold uppercase text-[10px] font-bold">
                                        {['agent', 'status', 'date', ...(reportFilters.category !== 'all' ? categories[reportFilters.category].fields : [])].filter(col => !col.includes('Module')).map(col => (
                                            <button key={col} onClick={() => toggleReportColumn(col)} className={`px-3 py-1.5 rounded-full border ${selectedReportColumns.includes(col) ? 'bg-blue-600 border-blue-600 text-white font-bold' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 font-bold'}`}>{col.replace(/([A-Z])/g, ' $1')}</button>
                                        ))}
                                    </div>
                                    <div className="flex justify-end pt-2 font-bold"><button onClick={handleGenerateReport} className="px-6 py-2.5 bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white font-bold rounded-lg shadow-lg uppercase text-xs font-bold">Generate Report</button></div>
                                </Card>

                                {generatedReport && (
                                    <Card className="overflow-hidden animate-fade-in">
                                        <div className="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                                            <h3 className="font-bold text-sm uppercase">Results ({generatedReport.length})</h3>
                                            <button onClick={downloadCSV} className="text-blue-600 text-[10px] uppercase font-black hover:underline flex items-center gap-1">
                                                <Download className="h-3 w-3" /> Download CSV
                                            </button>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-slate-50 dark:bg-slate-800 text-[10px] uppercase font-black text-slate-500">
                                                    <tr>
                                                        {selectedReportColumns.map(col => <th key={col} className="px-6 py-3">{col.replace(/([A-Z])/g, ' $1')}</th>)}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-800 text-xs">
                                                    {generatedReport.map((row, i) => (
                                                        <tr key={i} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                                            {selectedReportColumns.map(col => {
                                                                let val = row[col] || row.details?.[col] || '-';
                                                                if (col === 'type') val = categories[row.type]?.label || row.type;
                                                                if (col === 'date') val = new Date(val).toLocaleDateString();
                                                                return <td key={col} className="px-6 py-4 font-medium dark:text-slate-300">{val}</td>
                                                            })}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>
                                )}
                            </div>
                        )}

                        {activeTab === 'pip' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <div className="flex justify-between items-center bg-white dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-800">
                                    <div>
                                        <h2 className="text-xl font-black uppercase tracking-widest dark:text-white flex items-center gap-3">
                                            <TrendingUp className="h-6 w-6 text-purple-600" /> 
                                            Performance Improvement Plans
                                        </h2>
                                        <p className="text-xs text-slate-500 uppercase mt-2 tracking-tighter">4-Week structured improvement tracking.</p>
                                    </div>
                                    {userProfile.role === 'Admin' && (
                                        <button onClick={() => { setPipData({ status: 'Active', startDate: new Date().toISOString().split('T')[0] }); setIsPipModalOpen(true); }} className="px-5 py-3 bg-purple-600 hover:bg-purple-700 transition-colors text-white rounded-xl text-xs font-black uppercase tracking-widest">
                                            + NEW PIP
                                        </button>
                                    )}
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {tasks.filter(t => t.type === 'pip' && (userProfile.role === 'Admin' || t.details?.mentorEmail === userProfile.email)).map(p => (
                                        <Card key={p.id} onClick={() => { setPipData({ ...p.details, id: p.id, status: p.status }); setIsPipModalOpen(true); }} className="p-6 cursor-pointer hover:border-purple-500 transition-all border-l-4 border-l-purple-500 relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                                <Target className="h-20 w-20 text-purple-600" />
                                            </div>
                                            {userProfile.role === 'Admin' && (
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteTask(p.id); }} className="absolute top-3 right-3 p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded-lg transition-all z-20" title="Delete PIP">
                                                    <Trash className="h-4 w-4" />
                                                </button>
                                            )}
                                            <div className="relative z-10 space-y-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="text-lg font-black dark:text-white leading-none">{p.details?.mentorName || 'Unknown'}</h3>
                                                        <p className="text-[10px] text-slate-400 mt-1">{p.details?.mentorEmail}</p>
                                                    </div>
                                                    <Badge color={p.status === 'Active' ? 'amber' : p.status === 'Completed - Success' ? 'green' : 'red'}>{p.status}</Badge>
                                                </div>
                                                <div className="pt-4 border-t dark:border-slate-800/50 flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                                                    <Calendar className="h-4 w-4" /> 
                                                    <span>{new Date(p.details?.startDate).toLocaleDateString()} &mdash; {getEndDate(p.details?.startDate)}</span>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                    {tasks.filter(t => t.type === 'pip' && (userProfile.role === 'Admin' || t.details?.mentorEmail === userProfile.email)).length === 0 && (
                                        <div className="col-span-full p-12 text-center border-2 border-dashed dark:border-slate-800 rounded-2xl text-slate-400 uppercase text-xs font-black tracking-widest">No PIP records found</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'warnings' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <div className="flex justify-between items-center bg-white dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-800">
                                    <div>
                                        <h2 className="text-xl font-black uppercase tracking-widest dark:text-white flex items-center gap-3">
                                            <AlertTriangle className="h-6 w-6 text-rose-600" /> 
                                            Disciplinary Warnings
                                        </h2>
                                        <p className="text-xs text-slate-500 uppercase mt-2 tracking-tighter">Verbal, Written, and Final warnings for mentors.</p>
                                    </div>
                                    {userProfile.role === 'Admin' && (
                                        <button onClick={() => { setWarningData({ warningType: 'Verbal', date: new Date().toISOString().split('T')[0] }); setIsWarningModalOpen(true); }} className="px-5 py-3 bg-rose-600 hover:bg-rose-700 transition-colors text-white rounded-xl text-xs font-black uppercase tracking-widest">
                                            + NEW WARNING
                                        </button>
                                    )}
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {tasks.filter(t => t.type === 'warning' && (userProfile.role === 'Admin' || t.details?.mentorEmail === userProfile.email)).map(w => (
                                        <Card key={w.id} onClick={() => { setWarningData({ ...w.details, id: w.id }); setIsWarningModalOpen(true); }} className={`p-6 cursor-pointer hover:shadow-lg transition-all border-l-4 ${w.details?.warningType === 'Final' ? 'border-l-rose-600' : w.details?.warningType === 'Written' ? 'border-l-amber-500' : 'border-l-blue-500'} relative overflow-hidden group`}>
                                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                                <AlertTriangle className={`h-20 w-20 ${w.details?.warningType === 'Final' ? 'text-rose-600' : w.details?.warningType === 'Written' ? 'text-amber-500' : 'text-blue-500'}`} />
                                            </div>
                                            {userProfile.role === 'Admin' && (
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteTask(w.id); }} className="absolute top-3 right-3 p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded-lg transition-all z-20" title="Delete Warning">
                                                    <Trash className="h-4 w-4" />
                                                </button>
                                            )}
                                            <div className="relative z-10 space-y-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="text-lg font-black dark:text-white leading-none">{w.details?.mentorName || 'Unknown'}</h3>
                                                        <p className="text-[10px] text-slate-400 mt-1">{w.details?.warningReason}</p>
                                                    </div>
                                                    <Badge color={w.details?.warningType === 'Final' ? 'red' : w.details?.warningType === 'Written' ? 'amber' : 'blue'}>{w.details?.warningType}</Badge>
                                                </div>
                                                <div className="pt-4 border-t dark:border-slate-800/50 flex flex-col gap-2 text-xs text-slate-500 dark:text-slate-400">
                                                    <div className="flex items-center gap-2">
                                                        <Calendar className="h-4 w-4" /> 
                                                        <span>Issued: {new Date(w.details?.date).toLocaleDateString()}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <AlertCircle className="h-4 w-4" /> 
                                                        <span>Expires: {w.details?.expirationDate ? new Date(w.details.expirationDate).toLocaleDateString() : 'N/A'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                    {tasks.filter(t => t.type === 'warning' && (userProfile.role === 'Admin' || t.details?.mentorEmail === userProfile.email)).length === 0 && (
                                        <div className="col-span-full p-12 text-center border-2 border-dashed dark:border-slate-800 rounded-2xl text-slate-400 uppercase text-xs font-black tracking-widest">No Warning records found</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'admin' && userProfile.role === 'Admin' && (
                            <div className="space-y-8 animate-fade-in font-bold">
                                <Card className="p-8 font-bold">
                                    <div className="flex items-center gap-3 mb-8 font-bold"><Shield className="h-6 w-6 text-indigo-600" /><h2 className="text-xl font-black uppercase dark:text-white leading-none font-bold">Admin Console</h2></div>
                                    
                                    {/* Admin Requirement: Delete Specific Entries Control */}
                                    <div className="mb-12 border-b dark:border-slate-800 pb-12 font-bold">
                                        <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">Master Entry Control</h3>
                                        <div className="overflow-x-auto max-h-64 border dark:border-slate-800 rounded-xl font-bold">
                                            <table className="w-full text-left text-[10px] font-black uppercase font-bold">
                                                <thead className="bg-slate-50 dark:bg-slate-800 text-slate-500 sticky top-0 font-bold">
                                                    <tr><th className="px-4 py-2 font-bold">Task</th><th className="px-4 py-2 font-bold">Original Agent</th><th className="px-4 py-2 font-bold">Date</th><th className="px-4 py-2 text-right font-bold">Delete</th></tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-800 font-bold">
                                                    {tasks.map(t => (
                                                        <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold">
                                                            <td className="px-4 py-3 font-bold">{t.type === 'pip' ? 'PIP Record' : t.type === 'warning' ? 'Warning Record' : categories[t.type]?.label || t.type}</td>
                                                            <td className="px-4 py-3 font-bold">{t.agent}</td>
                                                            <td className="px-4 py-3 font-bold">{new Date(t.date).toLocaleDateString()}</td>
                                                            <td className="px-4 py-3 text-right font-bold">
                                                                <button onClick={async () => { if(confirm("Permanently delete entry?")) { await supabase.from('tasks').delete().eq('id', t.id); fetchData(); } }} className="text-rose-500 hover:text-rose-700 transition-colors font-bold"><Trash className="h-4 w-4" /></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* User Authorizations Block */}
                                    <div className="space-y-6 mb-12 font-bold">
                                        <h3 className="text-xs font-black uppercase text-slate-400 font-bold">User Authorizations</h3>
                                        <div className="flex gap-4 bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border dark:border-slate-700 font-bold font-bold">
                                            <input type="email" placeholder="tempo.fit email" className="flex-1 p-3 border dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 bg-white font-bold" onChange={e => setFormData(p => ({...p, newEmail: e.target.value}))} value={formData.newEmail || ''} />
                                            <select className="p-3 border dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded-xl outline-none bg-white font-bold" onChange={e => setFormData(p => ({...p, newRole: e.target.value}))} value={formData.newRole || 'Mentor'}><option value="Mentor">Mentor</option><option value="Admin">Admin</option></select>
                                            <button onClick={handleAddUser} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-xs hover:bg-indigo-700 transition-all font-bold font-bold font-bold">Authorize</button>
                                        </div>
                                        <div className="overflow-x-auto font-bold"><table className="w-full text-left uppercase font-black text-[10px] font-bold"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 text-slate-400 font-bold font-bold"><tr><th className="px-6 py-4 font-bold">User</th><th className="px-6 py-4 font-bold">Role</th><th className="px-6 py-4 text-center font-bold">Permitted Tabs</th><th className="px-6 py-4 font-bold"></th></tr></thead>
                                            <tbody className="divide-y dark:divide-slate-800 font-bold">{registry.map(u => (<tr key={u.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold">
                                                <td className="px-6 py-4 lowercase font-bold dark:text-slate-400 font-bold">{u.email}</td>
                                                <td className="px-6 py-4 font-bold"><Badge color={u.role === 'Admin' ? 'purple' : 'slate'}>{u.role}</Badge></td>
                                                <td className="px-6 py-4 flex flex-wrap gap-2 justify-center font-bold">
                                                    {['dashboard', 'logs', 'analytics', 'reports', 'pip', 'warnings', 'admin', 'audits'].map(t => {
                                                        const isForceEnabled = (t === 'pip' || t === 'warnings' || t === 'audits') && u.role === 'Admin';
                                                        return (
                                                            <label key={t} className="flex items-center gap-1.5 cursor-pointer bg-white dark:bg-slate-800 px-2 py-1 border dark:border-slate-700 rounded shadow-sm font-bold">
                                                                <input type="checkbox" checked={u.allowed_tabs?.includes(t) || isForceEnabled} disabled={isForceEnabled} onChange={() => toggleTabForUser(u.email, t)} />
                                                                <span className={`text-[9px] font-bold ${isForceEnabled ? 'text-slate-300 dark:text-slate-600' : 'dark:text-slate-400'}`}>{t.replace('_', ' ')}</span>
                                                            </label>
                                                        );
                                                    })}
                                                </td>
                                                <td className="px-6 py-4 text-right font-bold font-bold">{u.email !== 'mohamed.abdelmagid@tempo.fit' && <button onClick={async () => { if(confirm("Revoke access?")) { await supabase.from('users_registry').delete().eq('id', u.id); fetchData(); } }} className="text-rose-400 transition-colors font-bold font-bold font-bold"><Trash className="h-4 w-4" /></button>}</td>
                                            </tr>))}</tbody></table></div>
                                    </div>

                                    {/* Requirement: Hierarchical Data Validation (Select Task Type first) */}
                                    <div className="space-y-8 pt-12 border-t dark:border-slate-800 font-bold">
                                        <div className="flex items-center gap-3 font-bold"><DatabaseIcon className="h-5 w-5 text-emerald-600" /><h3 className="text-sm font-black uppercase text-slate-400">Data Validation Center</h3></div>
                                        <div className="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border dark:border-slate-700 space-y-6 font-bold">
                                            <div>
                                                <label className="text-[10px] font-black uppercase mb-2 block text-slate-500 font-bold">Step 1: Select Main Task Type to Manage Lists</label>
                                                <select className="w-full p-3 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none font-bold dark:text-white" value={adminSelectedTaskType} onChange={(e) => setAdminSelectedTaskType(e.target.value)}>
                                                    {Object.entries(adminValidationCategories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                                </select>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 font-bold">
                                                {adminDropdowns.map(field => (
                                                    <div key={field} className="p-4 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-xl space-y-3 shadow-sm font-bold">
                                                        <h4 className="text-[10px] font-black uppercase text-blue-500 font-bold">{field.replace(/([A-Z])/g, ' $1')}</h4>
                                                        <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1 font-bold">
                                                            {(field === 'associateName' || (field === 'associateEmail' && adminSelectedTaskType !== 'weekly_quiz') ? globalAssociates : (field === 'mentorName' ? globalMentors : customOptions[field] || [])).map((item, idx) => (
                                                                <Badge key={`${item}-${idx}`} color="slate"><div className="flex items-center gap-2 font-bold">{item}<button onClick={() => {
                                                                    if (field.includes('associate') && adminSelectedTaskType !== 'weekly_quiz') setGlobalAssociates(globalAssociates.filter(i => i !== item));
                                                                    else if (field === 'mentorName') setGlobalMentors(globalMentors.filter(i => i !== item));
                                                                    else setCustomOptions({...customOptions, [field]: customOptions[field].filter(i => i !== item)});
                                                                }} className="text-rose-500 hover:text-rose-700 font-bold">&times;</button></div></Badge>
                                                            ))}
                                                        </div>
                                                        <div className="flex gap-2 font-bold font-bold">
                                                            <input id={`add-${field}`} className="flex-1 p-2 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-xs font-bold" placeholder="Add Item..." />
                                                            <button onClick={() => {
                                                                    const val = document.getElementById(`add-${field}`).value; if(!val) return;
                                                                    if (field.includes('associate') && adminSelectedTaskType !== 'weekly_quiz') setGlobalAssociates([...globalAssociates, val]);
                                                                    else if (field === 'mentorName') setGlobalMentors([...globalMentors, val]);
                                                                    else setCustomOptions({...customOptions, [field]: [...(customOptions[field] || []), val]});
                                                                    document.getElementById(`add-${field}`).value = '';
                                                                }} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase tracking-tighter">ADD</button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border dark:border-slate-700 space-y-4 font-bold">
                                            <h4 className="text-xs font-black uppercase text-slate-400 font-bold">HIP Hierarchy Extension (RTs)</h4>
                                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 font-bold font-bold">
                                                <select id="admin-hip-prod" className="p-2 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs font-bold dark:text-white font-bold">{Object.keys(globalHipHierarchy).map(k => <option key={k} value={k}>{k}</option>)}</select>
                                                <input id="admin-hip-cat" placeholder="Sub-Category" className="p-2 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs outline-none dark:text-white font-bold" />
                                                <input id="admin-hip-rt" placeholder="Request Type" className="p-2 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs outline-none dark:text-white font-bold" />
                                            </div>
                                            <button onClick={() => {
                                                const p = document.getElementById('admin-hip-prod').value;
                                                const c = document.getElementById('admin-hip-cat').value;
                                                const r = document.getElementById('admin-hip-rt').value;
                                                if(!c || !r) return alert("Fill Sub-Category & RT.");
                                                const updated = {...globalHipHierarchy};
                                                if(!updated[p][c]) updated[p][c] = [];
                                                updated[p][c].push(r);
                                                setGlobalHipHierarchy(updated);
                                            }} className="w-full py-2 bg-emerald-600 text-white rounded-lg font-black uppercase text-[10px] font-bold font-bold">Add Sub-Category / Request Type</button>
                                            
                                            {/* Requirement: Delete any added RT within the hierarchy manager */}
                                            <div className="mt-6 pt-6 border-t dark:border-slate-800 space-y-4 font-bold font-bold">
                                                <h5 className="text-[10px] font-black uppercase text-slate-500 font-bold">Manage Hierarchy RTs</h5>
                                                <div className="max-h-64 overflow-y-auto space-y-4 font-bold font-bold">
                                                    {Object.entries(globalHipHierarchy).map(([prod, cats]) => (
                                                        <div key={prod} className="space-y-2 font-bold"><p className="text-xs font-black uppercase text-blue-500 font-bold">{prod}</p>
                                                            {Object.entries(cats).map(([cat, rts]) => (<div key={`${prod}-${cat}`} className="ml-4 space-y-1 font-bold"><p className="text-[10px] font-bold text-slate-400 font-bold">{cat}</p>
                                                                <div className="flex flex-wrap gap-2 font-bold">{rts.map((rt, idx) => (<Badge key={`${rt}-${idx}`} color="slate"><div className="flex items-center gap-2 font-bold font-bold">{rt}<button onClick={() => { const updated = {...globalHipHierarchy}; updated[prod][cat] = updated[prod][cat].filter(item => item !== rt); setGlobalHipHierarchy(updated); }} className="text-rose-500 font-bold font-bold">&times;</button></div></Badge>))}</div></div>))}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-10 pt-8 border-t dark:border-slate-800 font-bold"><button onClick={() => saveGlobalConfig({ hip_hierarchy: globalHipHierarchy, associates: globalAssociates, mentors: globalMentors, custom_options: customOptions })} className="w-full py-4 bg-emerald-600 text-white font-black rounded-xl uppercase tracking-widest hover:bg-emerald-700 transition-all font-bold font-bold">Commit All Changes to Database</button></div>
                                </Card>
                            </div>
                        )}
                    </main>

                    {/* PIP Modal Details */}
                    {isPipModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onClick={() => setIsPipModalOpen(false)} />
                            <div className="relative w-full max-w-5xl max-h-[90vh] overflow-y-auto bg-slate-50 dark:bg-slate-900 rounded-3xl shadow-2xl flex flex-col animate-fade-in">
                                <div className="p-6 border-b dark:border-slate-800 flex justify-between items-center sticky top-0 bg-slate-50/90 dark:bg-slate-900/90 backdrop-blur z-10">
                                    <div>
                                        <h2 className="text-2xl font-black italic uppercase tracking-tighter dark:text-white flex items-center gap-2">
                                            <Target className="text-purple-600" />
                                            {pipData.id ? 'Performance Improvement Plan' : 'Initiate PIP'}
                                        </h2>
                                    </div>
                                    <button onClick={() => setIsPipModalOpen(false)} className="text-slate-400 hover:text-slate-800 dark:hover:text-white font-black text-xl">&times;</button>
                                </div>
                                
                                <form onSubmit={handleSavePip} className="p-6">
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        
                                        {/* Left Col: Setup */}
                                        <div className="lg:col-span-1 space-y-6">
                                            <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm space-y-4">
                                                <h3 className="text-xs font-black uppercase text-purple-600 tracking-widest border-b dark:border-slate-700 pb-2">Plan Essentials</h3>
                                                
                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Mentor Name</label>
                                                    {userProfile.role === 'Admin' ? (
                                                        <select required className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-purple-500" value={pipData.mentorName || ''} onChange={(e) => {
                                                            const val = e.target.value;
                                                            setPipData(p => ({ ...p, mentorName: val, mentorEmail: mentorEmailMap[val] || '' }));
                                                        }}>
                                                            <option value="">Select Mentor...</option>
                                                            {globalMentors.map(a => <option key={a} value={a}>{a}</option>)}
                                                        </select>
                                                    ) : (
                                                        <div className="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-400">{pipData.mentorName}</div>
                                                    )}
                                                </div>

                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Mentor Email</label>
                                                    <input type="email" required readOnly={userProfile.role !== 'Admin'} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-purple-500" value={pipData.mentorEmail || ''} onChange={e => setPipData(p => ({...p, mentorEmail: e.target.value}))} />
                                                </div>

                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Start Date</label>
                                                    <input type="date" required readOnly={userProfile.role !== 'Admin'} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-purple-500" value={pipData.startDate || ''} onChange={e => setPipData(p => ({...p, startDate: e.target.value}))} />
                                                </div>
                                                
                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Estimated End Date</label>
                                                    <div className="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border dark:border-slate-700 rounded-xl text-sm font-bold text-slate-500 flex items-center gap-2">
                                                        <Calendar className="h-4 w-4" /> {getEndDate(pipData.startDate) || '---'}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Plan Status</label>
                                                    {userProfile.role === 'Admin' ? (
                                                        <select className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-purple-500" value={pipData.status || 'Active'} onChange={e => setPipData(p => ({...p, status: e.target.value}))}>
                                                            <option value="Active">Active</option>
                                                            <option value="Completed - Success">Completed - Success</option>
                                                            <option value="Completed - Failed">Completed - Failed</option>
                                                        </select>
                                                    ) : (
                                                        <Badge color={pipData.status === 'Active' ? 'amber' : pipData.status === 'Completed - Success' ? 'green' : 'red'}>{pipData.status}</Badge>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right Col: Details & 4 Weeks */}
                                        <div className="lg:col-span-2 space-y-6">
                                            <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm space-y-4">
                                                <h3 className="text-xs font-black uppercase text-purple-600 tracking-widest border-b dark:border-slate-700 pb-2">Reason & Goals</h3>
                                                
                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Reason for PIP</label>
                                                    <textarea required readOnly={userProfile.role !== 'Admin'} rows="3" className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium dark:text-white focus:ring-2 focus:ring-purple-500" placeholder="Detail the performance issues..." value={pipData.reason || ''} onChange={e => setPipData(p => ({...p, reason: e.target.value}))} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Improvement Goals (Criteria for Success)</label>
                                                    <textarea readOnly={userProfile.role !== 'Admin'} rows="3" className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium dark:text-white focus:ring-2 focus:ring-purple-500" placeholder="Measurable goals to achieve..." value={pipData.goals || ''} onChange={e => setPipData(p => ({...p, goals: e.target.value}))} />
                                                </div>
                                            </div>

                                            <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm space-y-4">
                                                <h3 className="text-xs font-black uppercase text-purple-600 tracking-widest border-b dark:border-slate-700 pb-2">4-Week Tracking</h3>
                                                
                                                <div className="space-y-4">
                                                    {[1, 2, 3, 4].map(week => (
                                                        <div key={`week-${week}`} className="flex gap-4 items-start">
                                                            <div className="flex-shrink-0 w-16 h-16 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-2xl flex flex-col items-center justify-center font-black">
                                                                <span className="text-[10px] uppercase tracking-tighter">Week</span>
                                                                <span className="text-2xl leading-none">{week}</span>
                                                            </div>
                                                            <div className="flex-1 space-y-2">
                                                                <textarea readOnly={userProfile.role !== 'Admin'} rows="2" placeholder={`Manager's notes for Week ${week} progress...`} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium dark:text-white focus:ring-2 focus:ring-purple-500" value={pipData[`week${week}`] || ''} onChange={e => setPipData(p => ({...p, [`week${week}`]: e.target.value}))} />
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Status:</span>
                                                                    {userProfile.role === 'Admin' ? (
                                                                        <select className="p-1.5 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg outline-none text-xs font-bold dark:text-white" value={pipData[`week${week}Status`] || 'Pending'} onChange={e => setPipData(p => ({...p, [`week${week}Status`]: e.target.value}))}>
                                                                            <option value="Pending">Pending</option>
                                                                            <option value="Passed">Passed</option>
                                                                            <option value="Failed">Failed</option>
                                                                        </select>
                                                                    ) : (
                                                                        <Badge color={pipData[`week${week}Status`] === 'Passed' ? 'green' : pipData[`week${week}Status`] === 'Failed' ? 'red' : 'amber'}>{pipData[`week${week}Status`] || 'Pending'}</Badge>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {userProfile.role === 'Admin' && (
                                                <div className="flex gap-4">
                                                    {pipData.id && (
                                                        <button type="button" onClick={() => handleDeleteTask(pipData.id)} className="px-6 py-4 bg-white dark:bg-slate-900 border-2 border-rose-100 dark:border-rose-900/50 text-rose-500 font-black rounded-2xl shadow-sm hover:bg-rose-50 dark:hover:bg-rose-900/30 transition-all uppercase tracking-widest">
                                                            Delete
                                                        </button>
                                                    )}
                                                    <button type="submit" className="flex-1 py-4 bg-purple-600 text-white font-black rounded-2xl shadow-xl hover:bg-purple-700 transition-all uppercase tracking-widest shadow-purple-200 dark:shadow-none">
                                                        Save PIP Record
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Warning Modal Details */}
                    {isWarningModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onClick={() => setIsWarningModalOpen(false)} />
                            <div className="relative w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-slate-50 dark:bg-slate-900 rounded-3xl shadow-2xl flex flex-col animate-fade-in">
                                <div className="p-6 border-b dark:border-slate-800 flex justify-between items-center sticky top-0 bg-slate-50/90 dark:bg-slate-900/90 backdrop-blur z-10">
                                    <div>
                                        <h2 className="text-2xl font-black italic uppercase tracking-tighter dark:text-white flex items-center gap-2">
                                            <AlertTriangle className="text-rose-600" />
                                            {warningData.id ? 'Warning Record' : 'Issue Disciplinary Warning'}
                                        </h2>
                                    </div>
                                    <button onClick={() => setIsWarningModalOpen(false)} className="text-slate-400 hover:text-slate-800 dark:hover:text-white font-black text-xl">&times;</button>
                                </div>
                                
                                <form onSubmit={handleSaveWarning} className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Mentor Name</label>
                                                {userProfile.role === 'Admin' ? (
                                                    <select required className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-rose-500" value={warningData.mentorName || ''} onChange={(e) => {
                                                        const val = e.target.value;
                                                        setWarningData(p => ({ ...p, mentorName: val, mentorEmail: mentorEmailMap[val] || '' }));
                                                    }}>
                                                        <option value="">Select Mentor...</option>
                                                        {globalMentors.map(a => <option key={a} value={a}>{a}</option>)}
                                                    </select>
                                                ) : (
                                                    <div className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-400">{warningData.mentorName}</div>
                                                )}
                                            </div>

                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Mentor Email</label>
                                                <input type="email" required readOnly={userProfile.role !== 'Admin'} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-rose-500" value={warningData.mentorEmail || ''} onChange={e => setWarningData(p => ({...p, mentorEmail: e.target.value}))} />
                                            </div>

                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Date of Notice</label>
                                                <input type="date" required readOnly={userProfile.role !== 'Admin'} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-rose-500" value={warningData.date || ''} onChange={e => setWarningData(p => ({...p, date: e.target.value}))} />
                                            </div>
                                        </div>

                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Warning Type</label>
                                                {userProfile.role === 'Admin' ? (
                                                    <select required className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-rose-500" value={warningData.warningType || ''} onChange={e => setWarningData(p => ({...p, warningType: e.target.value}))}>
                                                        <option value="Verbal">Verbal Warning</option>
                                                        <option value="Written">Written Warning</option>
                                                        <option value="Final">Final Warning</option>
                                                    </select>
                                                ) : (
                                                    <Badge color={warningData.warningType === 'Final' ? 'red' : warningData.warningType === 'Written' ? 'amber' : 'blue'}>{warningData.warningType} Warning</Badge>
                                                )}
                                            </div>

                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Primary Reason</label>
                                                {userProfile.role === 'Admin' ? (
                                                    <select required className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-bold dark:text-white focus:ring-2 focus:ring-rose-500" value={warningData.warningReason || ''} onChange={e => setWarningData(p => ({...p, warningReason: e.target.value}))}>
                                                        <option value="">Select Reason...</option>
                                                        {(customOptions.warningReason || []).map(r => <option key={r} value={r}>{r}</option>)}
                                                    </select>
                                                ) : (
                                                    <div className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-400">{warningData.warningReason}</div>
                                                )}
                                            </div>
                                            
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Expiration Date (3 Months)</label>
                                                <div className="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-400">
                                                    {warningData.date ? (() => {
                                                        const d = new Date(warningData.date);
                                                        d.setMonth(d.getMonth() + 3);
                                                        return d.toLocaleDateString();
                                                    })() : '---'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 block">Details & Disciplinary Notes</label>
                                        <textarea required readOnly={userProfile.role !== 'Admin'} rows="6" className="w-full p-4 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl outline-none text-sm font-medium dark:text-white focus:ring-2 focus:ring-rose-500" placeholder="Provide full documentation of the warning details..." value={warningData.notes || ''} onChange={e => setWarningData(p => ({...p, notes: e.target.value}))} />
                                    </div>

                                    {userProfile.role === 'Admin' && (
                                        <div className="flex gap-4">
                                            {warningData.id && (
                                                <button type="button" onClick={() => handleDeleteTask(warningData.id)} className="px-6 py-4 bg-white dark:bg-slate-900 border-2 border-rose-100 dark:border-rose-900/50 text-rose-500 font-black rounded-2xl shadow-sm hover:bg-rose-50 dark:hover:bg-rose-900/30 transition-all uppercase tracking-widest">
                                                    Delete
                                                </button>
                                            )}
                                            <button type="submit" className="flex-1 py-4 bg-rose-600 text-white font-black rounded-2xl shadow-xl hover:bg-rose-700 transition-all uppercase tracking-widest shadow-rose-200 dark:shadow-none">
                                                Save Warning Record
                                            </button>
                                        </div>
                                    )}
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Standard Form Modal (Supports Audits read-only logic) */}
                    {isFormOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end font-bold">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm font-bold" onClick={() => setIsFormOpen(false)} />
                            <div className="relative w-full max-w-md bg-white dark:bg-slate-900 h-full shadow-2xl p-8 overflow-y-auto animate-slide-in-right font-bold">
                                <div className="flex justify-between items-center mb-8 font-bold font-bold"><h2 className="text-2xl font-black italic uppercase tracking-tighter dark:text-white font-bold leading-none font-bold">{editingTaskId ? (isAuditReadOnly ? 'VIEW' : 'EDIT') : 'NEW'} {categories[newTaskType].label}</h2><button onClick={() => setIsFormOpen(false)} className="text-slate-400 font-black uppercase text-[10px] hover:text-slate-800 dark:hover:text-white transition-colors font-bold">Close &times;</button></div>
                                <form onSubmit={handleAddTask} className="space-y-6 font-bold">
                                    {!editingTaskId && <div className="font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-2 block font-bold">Category Type</label><select className="w-full p-3 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none font-bold dark:text-white font-bold" value={newTaskType} onChange={e => { setNewTaskType(e.target.value); setFormData(e.target.value === 'floorwalker' ? {status: 'Resolved'} : {}); }}>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select></div>}
                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border dark:border-slate-700 space-y-4 font-bold font-bold">
                                        {categories[newTaskType].fields.map(field => {
                                            const isValidNo = (newTaskType === 'floorwalker' && formData.validRequest === 'No') || (newTaskType === 'hip_request' && formData.validHip === 'No');
                                            if (field === 'pendingReasonDetail' && formData.status !== 'Pending') return null;
                                            if (field === 'invalidReason' && !isValidNo) return null;
                                            
                                            if (field === 'auditModule' || field === 'correctionModule') {
                                                const items = field === 'auditModule' ? auditAttributes : quizModules;
                                                return (<div key={field} className="space-y-6 pt-2 font-bold font-bold"><div className="flex justify-between items-center mb-2 font-bold font-bold"><h3 className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest font-bold font-bold">{field.replace('Module','')} Quality</h3>{field === 'correctionModule' && <Badge color="cyan">AVG: {formData.overallScore || '0.0'}</Badge>}{field === 'auditModule' && <Badge color="green">Score: {formData.overallAuditScore || '0'}%</Badge>}</div>
                                                    {items.map((m, idx) => (<div key={`${m.id}-${idx}`} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm font-bold font-bold"><p className="font-bold text-sm mb-1 dark:text-slate-200 font-bold">{m.title || m.label}</p><p className="text-[10px] text-slate-400 mb-4 font-bold">{m.desc}</p><div className="flex justify-center gap-2 mb-4 font-bold font-bold">{field === 'auditModule' ? ['Yes', 'No'].map(s => (<button key={s} type="button" onClick={() => !isAuditReadOnly && handleAuditScore(m.id, s)} className={`px-4 py-1.5 rounded-lg border-2 text-[10px] font-black transition-all font-bold ${formData.auditScores?.[m.id] === s ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white dark:bg-slate-800 dark:border-slate-700 text-slate-400'} ${isAuditReadOnly ? 'cursor-not-allowed opacity-80' : ''}`}>{s.toUpperCase()}</button>)) : [1, 2, 3, 4, 5].map(s => (<button key={s} type="button" onClick={() => !isAuditReadOnly && handleQuizScore(m.id, s)} className={`w-8 h-8 rounded-full border-2 text-xs font-bold transition-all font-bold ${formData.quizScores?.[m.id] === s ? 'bg-cyan-500 border-cyan-500 text-white' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-400'} ${isAuditReadOnly ? 'cursor-not-allowed opacity-80' : ''}`}>{s}</button>))}</div><input type="text" placeholder="Detail..." className="w-full p-2 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 text-[10px] outline-none dark:text-white font-bold font-bold" readOnly={isAuditReadOnly} onChange={e => setFormData(p => ({...p, quizComments: {...(p.quizComments || {}), [m.id]: e.target.value}}))} value={formData.quizComments?.[m.id] || ''} /></div>))}</div>);
                                            }
                                            if (field === 'hipLogReference' && newTaskType === 'mentor_audit') return (
                                                <div key={field} className="pt-2 font-bold font-bold">
                                                    <label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase block mb-1.5 font-bold font-bold">Audit Target Randomizer</label>
                                                    {!isAuditReadOnly && (
                                                        <div className="flex items-center gap-2 mb-3 font-bold font-bold">
                                                            <input type="date" className="flex-1 p-2 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs outline-none focus:ring-1 focus:ring-emerald-500 dark:text-slate-300 font-bold" value={auditRandomizerRange.start} onChange={e => setAuditRandomizerRange(p => ({...p, start: e.target.value}))} title="Start Date" />
                                                            <span className="text-slate-400 text-[10px] font-black uppercase font-bold">To</span>
                                                            <input type="date" className="flex-1 p-2 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs outline-none focus:ring-1 focus:ring-emerald-500 dark:text-slate-300 font-bold" value={auditRandomizerRange.end} onChange={e => setAuditRandomizerRange(p => ({...p, end: e.target.value}))} title="End Date" />
                                                        </div>
                                                    )}
                                                    <div className="flex gap-2 font-bold font-bold font-bold">
                                                        <div className="flex-1 p-3 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-xl text-sm font-medium dark:text-slate-300 flex flex-wrap items-center gap-4 font-bold">
                                                            {formData.auditedSlack && (
                                                                <a href={formData.auditedSlack.startsWith('http') ? formData.auditedSlack : `https://${formData.auditedSlack}`} target="_blank" className="flex items-center gap-1.5 text-teal-600 dark:text-teal-400 hover:underline font-bold">
                                                                    <MessageCircle className="h-4 w-4" /> Slack
                                                                </a>
                                                            )}
                                                            {formData.auditedTicket && (
                                                                <a href={formData.auditedTicket.startsWith('http') ? formData.auditedTicket : `https://${formData.auditedTicket}`} target="_blank" className="flex items-center gap-1.5 text-blue-600 dark:text-blue-400 hover:underline font-bold">
                                                                    <FileText className="h-4 w-4" /> Ticket
                                                                </a>
                                                            )}
                                                            {(!formData.auditedSlack && !formData.auditedTicket) && <span className="text-slate-400 text-xs italic font-bold">No log selected</span>}
                                                        </div>
                                                        {!isAuditReadOnly && (
                                                            <button type="button" onClick={() => { 
                                                                let hL = tasks.filter(t => t.type === 'hip_request'); 
                                                                if (formData.mentorName) {
                                                                    const expectedAgent = (mentorEmailMap[formData.mentorName] || '').split('@')[0];
                                                                    if (expectedAgent) hL = hL.filter(t => t.agent.toLowerCase() === expectedAgent.toLowerCase());
                                                                }
                                                                if (auditRandomizerRange.start) hL = hL.filter(t => new Date(t.date) >= new Date(auditRandomizerRange.start));
                                                                if (auditRandomizerRange.end) {
                                                                    const endD = new Date(auditRandomizerRange.end);
                                                                    endD.setHours(23, 59, 59);
                                                                    hL = hL.filter(t => new Date(t.date) <= endD);
                                                                }
                                                                if (!hL.length) return alert("No HIP logs found for the selected criteria."); 
                                                                const r = hL[Math.floor(Math.random() * hL.length)]; 
                                                                const foundMentorName = Object.keys(mentorEmailMap).find(k => mentorEmailMap[k].split('@')[0].toLowerCase() === r.agent.toLowerCase()) || r.agent;
                                                                setFormData(p => ({ 
                                                                    ...p, 
                                                                    hipLogReference: r.id, 
                                                                    auditedTicket: r.details.ticketLink, 
                                                                    auditedSlack: r.details.slackLink,
                                                                    mentorName: foundMentorName,
                                                                    mentorEmail: mentorEmailMap[foundMentorName] || ''
                                                                })); 
                                                            }} className="p-3 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 hover:bg-emerald-200 dark:hover:bg-emerald-800/50 transition-colors rounded-xl flex items-center justify-center min-w-[3rem]" title="Pick Random Target">
                                                                <Dice className="h-5 w-5 font-bold" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                            if (field === 'mentorEmail' && newTaskType === 'mentor_audit') return (<div key={field} className="font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1.5 block font-bold font-bold">Mentor Email</label><input type="email" className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white font-bold font-bold" value={formData[field] || ''} readOnly={isAuditReadOnly || userProfile?.role !== 'Admin'} onChange={e => handleInputChange(field, e.target.value)} /></div>);
                                            if (field === 'associateEmail' && newTaskType === 'weekly_quiz') return (<div key={field} className="font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1.5 block font-bold font-bold">Associate Email</label><input type="email" className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white font-bold font-bold" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} /></div>);
                                            
                                            const isDropdown = ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'validHip', 'validRequest', 'subscriptionStatus', 'emailSent', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail'].includes(field);
                                            return (<div key={field} className="font-bold font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1.5 block font-bold font-bold font-bold">{field.replace(/([A-Z])/g, ' $1')}</label>
                                                {isDropdown ? (
                                                    <div className="font-bold">
                                                        {(field === 'status' && autoResolvedTypes.includes(newTaskType)) ? (
                                                            <div className="p-3 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-xl text-emerald-600 text-sm font-bold text-emerald-600 uppercase text-center italic tracking-tighter font-bold">Enforced Resolved</div>
                                                        ) : (
                                                            <select disabled={isAuditReadOnly} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white font-bold font-bold" value={formData[field] || ''} onChange={e => { 
                                                                    if(field === 'hipProduct') setFormData(p=>({...p, hipProduct:e.target.value, hipCategory:'', hipRequestType:''})); 
                                                                    else if(field === 'hipCategory') setFormData(p=>({...p, hipCategory:e.target.value, hipRequestType:''})); 
                                                                    else if(field === 'associateName' && newTaskType === 'weekly_quiz') {
                                                                        const val = e.target.value;
                                                                        const email = associateEmailMap[val] || '';
                                                                        setFormData(p => ({ ...p, [field]: val, associateEmail: email }));
                                                                    }
                                                                    else if(field === 'mentorName' && newTaskType === 'mentor_audit') {
                                                                        const val = e.target.value;
                                                                        const email = mentorEmailMap[val] || '';
                                                                        setFormData(p => ({ ...p, [field]: val, mentorEmail: email }));
                                                                    }
                                                                    else handleInputChange(field, e.target.value);
                                                                }}><option value="" className="font-bold">Select...</option>
                                                                {field === 'associateName' && globalAssociates.map((a, idx) => <option key={`${a}-${idx}`} value={a} className="font-bold">{a}</option>)}
                                                                {field === 'associateEmail' && globalAssociates.map((a, idx) => <option key={`${a}-${idx}`} value={a} className="font-bold">{a}</option>)}
                                                                {field === 'mentorName' && globalMentors.map((a, idx) => <option key={`${a}-${idx}`} value={a} className="font-bold">{a}</option>)}
                                                                {field === 'status' && ['Pending', 'Resolved'].map((o, idx) => <option key={`${o}-${idx}`} value={o} className="font-bold">{o}</option>)}
                                                                {field === 'resolution' && (newTaskType === 'pending_subs' ? ['Activated', 'Cancelled'] : newTaskType === 'disputes' ? ['Pending', 'Lost', 'Won'] : ['Pending', 'Resolved']).map((o, idx) => <option key={`${o}-${idx}`} value={o} className="font-bold">{o}</option>)}
                                                                {field === 'hipProduct' && Object.keys(globalHipHierarchy).map((k, idx) => <option key={`${k}-${idx}`} value={k} className="font-bold">{k}</option>)}
                                                                {field === 'hipCategory' && formData.hipProduct && Object.keys(globalHipHierarchy[formData.hipProduct] || {}).map((c, idx) => <option key={`${c}-${idx}`} value={c} className="font-bold">{c}</option>)}
                                                                {field === 'hipRequestType' && formData.hipCategory && globalHipHierarchy[formData.hipProduct][formData.hipCategory].map((o, idx) => <option key={`${o}-${idx}`} value={o} className="font-bold">{o}</option>)}
                                                                {field !== 'resolution' && !field.startsWith('hip') && !['associateName', 'associateEmail', 'mentorName', 'pendingReasonDetail', 'status'].includes(field) && (customOptions[field] || []).map((o, idx) => <option key={`${o}-${idx}`} value={o} className="font-bold">{o}</option>)}
                                                                {field === 'pendingReasonDetail' && customOptions.pendingReasonDetail.map((o, idx) => <option key={`${o}-${idx}`} value={o} className="font-bold">{o}</option>)}
                                                                {!isAuditReadOnly && <option value="ADD_NEW_CUSTOM" className="text-blue-600 italic font-black font-bold uppercase text-[10px] font-bold">+ Add New Item...</option>}
                                                            </select>
                                                        )}
                                                        {customInputTarget === field && (<div className="mt-2 flex gap-2 animate-fade-in font-bold"><input type="text" id={`custom-${field}`} className="flex-1 p-2 border rounded-lg outline-none bg-white dark:bg-slate-900 dark:text-white font-bold" /><button type="button" onClick={() => handleAddCustomValue(field, document.getElementById(`custom-${field}`).value)} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase tracking-tighter font-bold">Add</button></div>)}
                                                    </div>
                                                ) : (<input readOnly={isAuditReadOnly} type={field.toLowerCase().includes('date') ? 'date' : 'text'} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white font-bold font-bold" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} />)}</div>);
                                        })}
                                    </div>
                                    {!isAuditReadOnly && <button type="submit" className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest shadow-blue-100 font-bold font-bold">Commit Record Entry</button>}
                                </form>
                            </div>
                        </div>
                    )}

                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 text-slate-900 dark:text-white font-bold">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm font-bold" onClick={() => setIsSettingsOpen(false)} />
                            <Card className="relative w-full max-w-md p-8 animate-fade-in shadow-2xl font-bold font-bold">
                                <div className="flex justify-between items-center mb-6 font-bold font-bold"><h2 className="text-xl font-black uppercase tracking-tight dark:text-white font-bold font-bold">Security Center</h2><button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 font-bold text-xl font-bold font-bold font-bold">&times;</button></div>
                                <div className="space-y-6 font-bold font-bold">
                                    <div className="font-bold font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase mb-2 block font-bold font-bold">Change Password</label><input type="password" minLength="6" className="w-full p-3 border dark:border-slate-700 dark:bg-slate-800 rounded-xl outline-none font-bold dark:text-white font-bold font-bold" placeholder="New password" value={newInternalPassword} onChange={e => setNewInternalPassword(e.target.value)} /><p className="mt-2 text-[9px] text-slate-400 uppercase font-bold font-bold">Min 6 characters</p></div>
                                    <button onClick={handleUpdatePasswordInternal} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-xs font-bold font-bold font-bold">Update Password Now</button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MentorOpsCenter />);
    </script>
</body>
</html>
