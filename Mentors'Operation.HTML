<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo MentorOps | Integrated System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tempo: {
                            blue: '#2563EB',
                            dark: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        canvas {
            max-width: 100% !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://mifbpckstfwphkwtqksa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZmJwY2tzdGZ3cGhrd3Rxa3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzcyMDksImV4cCI6MjA4NjUxMzIwOX0.PDZwE9hII9kPOjrBeJAI8T28oetruK-ogFtKOICMlOQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Core UI Components ---
        function Card({ children, className = "" }) {
            return (
                <div className={`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm ${className}`}>
                    {children}
                </div>
            );
        }

        function Badge({ children, color = "slate" }) {
            const colors = { 
                slate: "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300", 
                red: "bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400", 
                blue: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400", 
                green: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", 
                amber: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400", 
                teal: "bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400", 
                cyan: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400", 
                purple: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400", 
                emerald: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
                indigo: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400"
            };
            const selectedColor = colors[color] || colors.slate;
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${selectedColor}`}>
                    {children}
                </span>
            );
        }

        // --- Icon Components (Restored Full Set) ---
        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const LayoutDashboard = (props) => <Icon {...props} path={<React.Fragment><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></React.Fragment>} />;
        const AlertCircle = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>} />;
        const CreditCard = (props) => <Icon {...props} path={<React.Fragment><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></React.Fragment>} />;
        const Footprints = (props) => <Icon {...props} path={<React.Fragment><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.25-.79 4.33-2 6"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.25.79 4.33 2 6"/><path d="M4 20h4"/><path d="M16 8h4"/></React.Fragment>} />;
        const MessageCircle = (props) => <Icon {...props} path={<React.Fragment><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></React.Fragment>} />;
        const ClipboardList = (props) => <Icon {...props} path={<React.Fragment><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M9 17h6"/><path d="M9 12h6"/><path d="M11 2v4"/><path d="M3 5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5"/></React.Fragment>} />;
        const FileText = (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></React.Fragment>} />;
        const Gift = (props) => <Icon {...props} path={<React.Fragment><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></React.Fragment>} />;
        const UserCheck = (props) => <Icon {...props} path={<React.Fragment><path d="m16 11 2 2 4-4"/><path d="M12 20h9"/><path d="M12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8"/><path d="M4 20a8 8 0 0 1 8-8"/></React.Fragment>} />;
        const BarChart3 = (props) => <Icon {...props} path={<React.Fragment><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></React.Fragment>} />;
        const Search = (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>} />;
        const Edit = (props) => <Icon {...props} path={<React.Fragment><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></React.Fragment>} />;
        const Trash = (props) => <Icon {...props} path={<React.Fragment><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/></React.Fragment>} />;
        const Shield = (props) => <Icon {...props} path={<React.Fragment><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></React.Fragment>} />;
        const SettingsIcon = (props) => <Icon {...props} path={<React.Fragment><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/><circle cx="12" cy="12" r="3"/></React.Fragment>} />;
        const LogOut = (props) => <Icon {...props} path={<React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>} />;
        const Sun = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></React.Fragment>} />;
        const Moon = (props) => <Icon {...props} path={<React.Fragment><path d="M12 3a9 9 0 1 0 9 9 7 7 0 0 1-9-9z"/></React.Fragment>} />;

        // --- Data Definitions ---
        const defaultTabs = ['dashboard', 'logs', 'analytics', 'reports'];
        const initialAssociateList = ["Rayan", "Alyssa", "Khaled", "Hana", "Liam"];
        const initialMentorList = ["Sarah", "Omar", "Mina", "Nora", "David"];

        const quizModules = [
            { id: 'greeting', title: 'Greeting', max: 5 },
            { id: 'validation', title: 'Validation', max: 5 },
            { id: 'ownership', title: 'Ownership', max: 5 },
            { id: 'resolution', title: 'Resolution', max: 5 },
            { id: 'closure', title: 'Closure', max: 5 },
        ];

        const auditAttributes = [
            { id: 'correctTagging', title: 'Correct Tagging', desc: 'Proper tags applied to ticket.', weight: 10 },
            { id: 'notesQuality', title: 'Notes Quality', desc: 'Clear and complete case notes.', weight: 15 },
            { id: 'policyCompliance', title: 'Policy Compliance', desc: 'Aligned with SOP and policy.', weight: 25 },
            { id: 'empathy', title: 'Empathy', desc: 'Tone and empathy demonstrated.', weight: 10 },
            { id: 'accuracy', title: 'Accuracy', desc: 'Correct diagnosis and action.', weight: 20 },
            { id: 'timeliness', title: 'Timeliness', desc: 'Handled in reasonable time.', weight: 10 },
            { id: 'fcr', title: 'FCR', desc: 'First Contact Resolution considered.', weight: 10 },
        ];

        const correctionModules = [
            { id: 'acknowledge', title: 'Acknowledged Customer', desc: 'Agent acknowledged customer concern.' },
            { id: 'investigation', title: 'Investigation', desc: 'Performed proper troubleshooting.' },
            { id: 'resolutionPath', title: 'Resolution Path', desc: 'Provided correct resolution steps.' },
            { id: 'documented', title: 'Documentation', desc: 'Updated case with accurate notes.' },
            { id: 'customerConcern', title: 'Identify customer Concern', desc: 'Comprehend concerns effectively.' },
            { id: 'fcr', title: 'FCR', desc: 'Was the associate able to anticipate all questions?' }
        ];

        const categories = {
            disputes: { label: 'Disputes', icon: AlertCircle, color: 'red', fields: ['customerName', 'customerEmail', 'disputeAmount', 'disputeDate', 'disputeReason', 'disputedProduct', 'disputeLink', 'resolution'] },
            pending_subs: { label: 'Pending Subs', icon: CreditCard, color: 'blue', fields: ['customerName', 'customerEmail', 'pendingReason', 'resolution'] },
            floorwalker: { label: 'FloorWalker', icon: Footprints, color: 'amber', fields: ['associateName', 'validRequest', 'invalidReason', 'ticketLink', 'reasonForSupport', 'slackLink', 'comment', 'status'] },
            hip_request: { label: 'HIP Request', icon: MessageCircle, color: 'teal', fields: ['associateName', 'ticketLink', 'slackLink', 'validHip', 'invalidReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail'] },
            weekly_quiz: { label: 'Weekly Quiz', icon: ClipboardList, color: 'cyan', fields: ['associateName', 'associateEmail', 'date', 'correctionModule'] },
            duplicate_iap: { label: 'Duplicate IAP', icon: FileText, color: 'indigo', fields: ['customerEmail', 'emailSent', 'subscriptionStatus'] },
            surprise_delight: { label: 'Surprise & Delight', icon: Gift, color: 'purple', fields: ['associateName', 'team', 'customerName', 'customerEmail', 'productType', 'ticketUrl', 'surpriseAndDelightReason', 'surpriseAndDelightType', 'amount', 'date', 'notes'] },
            mentor_audit: { label: 'Mentor Audit', icon: UserCheck, color: 'emerald', fields: ['mentorName', 'hipLogReference', 'auditModule'] },
        };

        const initialHIPHierarchy = {
            "Move": {
                "Order Modifications": ["Change Color", "Change Address", "Upgrade", "Downgrade", "Core Modification", "Order Receipt", "Mispick"],
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Missing Items", "Damaged Unit", "DOA"],
                "Billing & Membership": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute"],
                "Payments & Offers": ["HSA/FSA", "Invoice Request", "Bundled Inquiry", "Bundled Code Applied", "Personal Training"],
                "Account Management": ["Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login", "Current Promotions"],
                "Content": ["Challenges", "Workout History", "Feedback", "Training Plan Inquiry", "Baseline Issue"],
                "Prospective": ["Purchasing Info", "Membership Requirements", "HSA/FSA Inquiry", "Referral Program", "Holiday Promotion", "Current Offers"]
            },
            "Core": {
                "Product Support": ["Android Support", "Connection Unstable", "Hardware Connection Issue", "Start Class Error", "Incomplete Class"],
                "Hardware Support": ["Physical Damage", "Standalone Availability", "Standalone Delivery Delay"],
                "Shipping": ["Missing Items", "Delayed Accessories"]
            },
            "Studio": {
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Missing Items", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Damaged Unit", "DOA"],
                "Order Mods": ["Change Address", "Order Receipt", "Mispick"],
                "Billing": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Refund Inquiry"]
            },
            "Accessory": {
                "Purchasing": ["Cabinet Info", "Core Standalone Availability", "Kettlebell Availability"],
                "Delivery": ["Core Standalone Delay", "Plates Delivery Delay", "Barbell Delivery Delay", "Apparel Missing Item"],
                "Quality & Damage": ["Collar Damage", "Quick Lock Damage", "Competition Plates Damage", "Barbell Damage", "Workout mat Damage"],
                "Setup & Specs": ["Kettlebell Setup", "Folding Rack Setup", "Folding Rack Lock Issue", "Collar Specs", "HRM Replacement", "HRM Charger Replacement"]
            }
        };

        // --- App Component ---
        function MentorOpsCenter() {
            const [userProfile, setUserProfile] = useState(null);
            const [session, setSession] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [registry, setRegistry] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [searchTerm, setSearchTerm] = useState('');
            const [dashboardSearch, setDashboardSearch] = useState('');
            const [dashboardCategory, setDashboardCategory] = useState('all');
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [newTaskType, setNewTaskType] = useState('disputes');
            const [formData, setFormData] = useState({});
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;
            
            // Admin task type filtering state
            const [adminSelectedTaskType, setAdminSelectedTaskType] = useState('floorwalker');

            // Dashboard Collapsible State
            const [isPendingCollapsed, setIsPendingCollapsed] = useState(false);

            // Auth State
            const [authView, setAuthView] = useState('login'); 
            const [authLoading, setAuthLoading] = useState(false);
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [newInternalPassword, setNewInternalPassword] = useState('');

            // Config State
            const [globalHipHierarchy, setGlobalHipHierarchy] = useState(initialHIPHierarchy);
            const [globalAssociates, setGlobalAssociates] = useState(initialAssociateList);
            const [globalMentors, setGlobalMentors] = useState(initialMentorList);

            // Analytics State
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [analyticsCategory, setAnalyticsCategory] = useState('disputes');
            const [analyticsField, setAnalyticsField] = useState('status');
            const [analyticsDateRange, setAnalyticsDateRange] = useState({ start: '', end: '' });

            const [customOptions, setCustomOptions] = useState({
                pendingReason: ["Not delivered", "Delivered but not updated.", "Returned or canceled order"],
                disputeReason: ["Subscription claim", "Unauthorized purchase", "Defective product", "Credit not processed", "Fraud", "Subscription Cancelled", "Product Unacceptable"],
                reasonForSupport: ["SOP Guidance", "Process education", "System Navigation"],
                team: ["T1", "Social Media", "Mentor", "Order Support", "Product Support"],
                productType: ["Studio", "Move", "Core", "Accessories", "Membership"],
                disputedProduct: ["Move", "Core", "Membership", "Accessories"],
                surpriseAndDelightReason: ["Delivery ETA", "Wrong color", "Technical issue", "SRLimited access", "Missing discount", "Compatibility", "Lack of content"],
                surpriseAndDelightType: ["Water Bottle", "Sweat Towel", "Yoga Block", "Recovery Roller", "Gift Box", "axis-performance-hat-black", "axis-performance-hat-slate-grey", "tempo-workout-gloves", "motive-training-tee-black", "motive-training-tee-1", "Pinnacle Knit Beanie"],
                validRequest: ["Yes", "No"], validHip: ["Yes", "No"], emailSent: ["Yes", "No"], subscriptionStatus: ["Active", "Cancelled"],
                pendingReasonDetail: ["waiting on Internal", "waiting on Customer"],
                invalidReason: ["Outside Scope", "Incorrect Channel", "Missing Required Information", "No Response from Associate"]
            });

            const [customInputTarget, setCustomInputTarget] = useState(null);
            const [reportFilters, setReportFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });
            const [generatedReport, setGeneratedReport] = useState(null);
            const [selectedReportColumns, setSelectedReportColumns] = useState(['type', 'agent', 'status', 'date']);

            const toggleReportColumn = (column) => {
                setSelectedReportColumns(prev => prev.includes(column) ? prev.filter(c => c !== column) : [...prev, column]);
            };

            const getReportCellValue = (task, column) => {
                if (column === 'type') return categories[task.type]?.label || task.type;
                if (['agent', 'status', 'date'].includes(column)) {
                    if (column === 'date') return new Date(task.date).toLocaleString();
                    return task[column] || '';
                }
                return task.details?.[column] || '';
            };

            // Theme effect
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDarkMode]);

            // Authentication Implementation
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchUserProfile(session.user.email);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    setSession(session);
                    if (event === 'PASSWORD_RECOVERY') setAuthView('reset');
                    if (session) fetchUserProfile(session.user.email);
                    else setUserProfile(null);
                });
                return () => subscription.unsubscribe();
            }, []);

            const fetchUserProfile = async (email) => {
                const { data, error } = await supabase.from('users_registry').select('*').eq('email', email).maybeSingle();
                if (data) {
                    setUserProfile(data);
                } else if (email === 'mohamed.abdelmagid@tempo.fit') {
                    const initial = { email, role: 'Admin', allowed_tabs: defaultTabs.concat(['admin']) };
                    await supabase.from('users_registry').insert([initial]);
                    setUserProfile(initial);
                } else {
                    setUserProfile({ error: true, message: "Unauthorized account registry." });
                }
            };

            const fetchData = async () => {
                setConnectionStatus('connecting');
                
                // Fetch tasks
                const tasksRes = await supabase.from('tasks').select('*').order('date', { ascending: false });
                if (!tasksRes.error) { 
                    setTasks(tasksRes.data || []); 
                    setConnectionStatus('online'); 
                    discoverCustomOptions(tasksRes.data || []);
                }

                // Fetch registry
                if (userProfile?.role === 'Admin') {
                    const regRes = await supabase.from('users_registry').select('*');
                    if (!regRes.error) setRegistry(regRes.data || []);
                }

                // Fetch app_config for dynamic lists & hierarchies (Merging with "Old" dropdowns)
                try {
                    const { data: configData, error: configErr } = await supabase.from('app_config').select('*').eq('id', 1).maybeSingle();
                    if (!configErr && configData) {
                        // Merge logic to ensure hardcoded "old" values are never lost
                        if (configData.hip_hierarchy) setGlobalHipHierarchy(prev => ({...prev, ...configData.hip_hierarchy}));
                        if (configData.associates) setGlobalAssociates(prev => Array.from(new Set([...prev, ...configData.associates])));
                        if (configData.mentors) setGlobalMentors(prev => Array.from(new Set([...prev, ...configData.mentors])));
                        if (configData.custom_options) setCustomOptions(prev => {
                            const merged = {...prev};
                            Object.keys(configData.custom_options).forEach(key => {
                                merged[key] = Array.from(new Set([...(prev[key] || []), ...(configData.custom_options[key] || [])]));
                            });
                            return merged;
                        });
                    }
                } catch (e) {
                    console.error("Config fetch failed", e);
                }
            };

            const discoverCustomOptions = (allTasks) => {
                setCustomOptions(prev => {
                    const newDiscovery = { ...prev };
                    allTasks.forEach(t => {
                        Object.keys(newDiscovery).forEach(key => {
                            const val = t.details?.[key];
                            if (val && !newDiscovery[key].includes(val)) newDiscovery[key].push(val);
                        });
                    });
                    return newDiscovery;
                });
            };

            useEffect(() => {
                if (userProfile && !userProfile.error) fetchData();
                const channel = supabase.channel('tasks-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, fetchData).subscribe();
                return () => supabase.removeChannel(channel);
            }, [userProfile]);

            // Handlers
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthLoading(true);
                let error = null;
                const redirectTo = window.location.origin + window.location.pathname;

                if (authView === 'login') {
                    const res = await supabase.auth.signInWithPassword({ email: authEmail, password: authPassword });
                    error = res.error;
                } else if (authView === 'signup') {
                    const res = await supabase.auth.signUp({ email: authEmail, password: authPassword, options: { emailRedirectTo: redirectTo } });
                    error = res.error;
                    if (!error) alert("Email confirmation sent!");
                } else if (authView === 'forgot') {
                    const res = await supabase.auth.resetPasswordForEmail(authEmail, { redirectTo: redirectTo });
                    error = res.error;
                    if (!error) alert("Recovery email sent!");
                } else if (authView === 'reset') {
                    const res = await supabase.auth.updateUser({ password: authPassword });
                    error = res.error;
                    if (!error) { alert("Updated!"); setAuthView('login'); }
                }
                if (error) alert(error.message);
                setAuthLoading(false);
            };

            const handleGoogleLogin = async () => {
                const redirectTo = window.location.origin + window.location.pathname;
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: redirectTo }
                });
                if (error) alert(error.message);
            };

            const handleUpdatePasswordInternal = async () => {
                if (newInternalPassword.length < 6) return alert("Min 6 chars.");
                const { error } = await supabase.auth.updateUser({ password: newInternalPassword });
                if (!error) { alert("Success!"); setNewInternalPassword(''); setIsSettingsOpen(false); }
                else alert(error.message);
            };

            const handleAddUser = async () => {
                if (!formData.newEmail || !formData.newEmail.includes('@')) return alert("Enter valid email.");
                const initial = { email: formData.newEmail, role: formData.newRole || 'Mentor', allowed_tabs: defaultTabs };
                const { error } = await supabase.from('users_registry').insert([initial]);
                if (!error) { setFormData({ ...formData, newEmail: '' }); fetchData(); }
                else alert(error.message);
            };

            const toggleTabForUser = async (email, tab) => {
                const user = registry.find(u => u.email === email);
                if (!user) return;
                const currentTabs = user.allowed_tabs || [];
                const newTabs = currentTabs.includes(tab) ? currentTabs.filter(t => t !== tab) : [...currentTabs, tab];
                const { error } = await supabase.from('users_registry').update({ allowed_tabs: newTabs }).eq('email', email);
                if (!error) fetchData();
            };

            const handleEditTask = (task) => {
                setNewTaskType(task.type);
                setFormData({ ...(task.details || {}), status: task.status });
                setEditingTaskId(task.id);
                setIsFormOpen(true);
            };

            // Evaluation Logics
            const handleAuditScore = (attrId, achieved) => {
                const scores = { ...(formData.auditScores || {}), [attrId]: achieved };
                let total = 0;
                auditAttributes.forEach(attr => { if (scores[attr.id] === 'Yes') total += attr.weight; });
                setFormData(prev => ({ ...prev, auditScores: scores, overallAuditScore: total }));
            };

            const handleQuizScore = (mId, s) => {
                const scores = { ...(formData.quizScores || {}), [mId]: parseInt(s) };
                const values = Object.values(scores);
                const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '0.0';
                setFormData(prev => ({ ...prev, quizScores: scores, overallScore: avg }));
            };

            const handleAddTask = async (e) => {
                e.preventDefault();
                const requiredFields = categories[newTaskType].fields;
                const missingFields = [];
                requiredFields.forEach(f => {
                    if (f === 'correctionModule') { quizModules.forEach(m => { if (!(formData.quizScores?.[m.id])) missingFields.push(m.title); }); return; }
                    if (f === 'auditModule') { auditAttributes.forEach(a => { if (!(formData.auditScores?.[a.id])) missingFields.push(a.label); }); return; }
                    if (newTaskType === 'hip_request' && formData.status === 'Pending' && f === 'pendingReasonDetail' && !formData[f]) { missingFields.push("Pending Reason Detail"); return; }
                    if (newTaskType === 'floorwalker' && formData.validRequest === 'No' && f === 'invalidReason' && !formData[f]) { missingFields.push("Invalid Reason Detail"); return; }
                    if (f === 'pendingReasonDetail' || f === 'invalidReason') return; 
                    if (!formData[f] || formData[f] === '') missingFields.push(f.replace(/([A-Z])/g, ' $1'));
                });
                if (missingFields.length > 0) return alert("Required: " + missingFields.join(', '));

                // Documentation under original owner logic
                let agent = session.user.email.split('@')[0];
                let creationDate = new Date().toISOString();
                if (editingTaskId) {
                    const originalTask = tasks.find(t => t.id === editingTaskId);
                    if (originalTask) {
                        agent = originalTask.agent;
                        creationDate = originalTask.date;
                    }
                }

                // Status enforcement logic
                let finalStatus = formData.status || 'Pending';
                if (['weekly_quiz', 'mentor_audit', 'pending_subs'].includes(newTaskType)) finalStatus = 'Resolved';
                if (newTaskType === 'disputes' && (formData.resolution === 'Won' || formData.resolution === 'Lost')) finalStatus = 'Resolved';

                const taskData = { 
                    type: newTaskType, title: categories[newTaskType].label + ' Log', 
                    agent: agent, status: finalStatus, 
                    details: { ...formData, status: finalStatus }, 
                    date: creationDate 
                };

                const { error } = editingTaskId ? await supabase.from('tasks').update(taskData).eq('id', editingTaskId) : await supabase.from('tasks').insert([taskData]);
                if (!error) { setIsFormOpen(false); setFormData({}); setEditingTaskId(null); fetchData(); }
                else alert(error.message);
            };

            // Analytics Lifecycle
            useEffect(() => {
                if (activeTab === 'analytics' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    let filteredData = tasks.filter(t => t.type === analyticsCategory);
                    if (analyticsDateRange.start) filteredData = filteredData.filter(t => new Date(t.date) >= new Date(analyticsDateRange.start));
                    if (analyticsDateRange.end) {
                        const end = new Date(analyticsDateRange.end); end.setHours(23,59,59);
                        filteredData = filteredData.filter(t => new Date(t.date) <= end);
                    }
                    const counts = {};
                    filteredData.forEach(t => {
                        let value = ['status', 'agent'].includes(analyticsField) ? t[analyticsField] : t.details?.[analyticsField] || 'N/A';
                        counts[value] = (counts[value] || 0) + 1;
                    });
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                data: Object.values(counts),
                                backgroundColor: isDarkMode ? 'rgba(37, 99, 235, 0.8)' : 'rgba(37, 99, 235, 0.7)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: isDarkMode ? '#334155' : '#f1f5f9' }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } },
                                x: { grid: { display: false }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } }
                            }
                        }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [activeTab, analyticsCategory, analyticsField, analyticsDateRange, tasks, isDarkMode]);

            const saveGlobalConfig = async (newConfig) => {
                const { error } = await supabase.from('app_config').upsert({ id: 1, ...newConfig });
                if (error) alert("Error saving config: " + error.message);
                else alert("Saved to database!");
            };

            const handleInputChange = (field, value) => {
                if (value === 'ADD_NEW_CUSTOM') setCustomInputTarget(field);
                else { setFormData(prev => ({ ...prev, [field]: value })); setCustomInputTarget(null); }
            };

            const handleAddCustomValue = (field, newValue) => {
                if (!newValue.trim()) return;
                setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), newValue] }));
                handleInputChange(field, newValue);
            };

            const handleGenerateReport = () => {
                let filtered = tasks;
                if (reportFilters.category !== 'all') filtered = filtered.filter(t => t.type === reportFilters.category);
                if (reportFilters.agent !== 'all') filtered = filtered.filter(t => t.agent === reportFilters.agent);
                if (reportFilters.startDate) filtered = filtered.filter(t => new Date(t.date) >= new Date(reportFilters.startDate));
                if (reportFilters.endDate) { const end = new Date(reportFilters.endDate); end.setHours(23,59,59); filtered = filtered.filter(t => new Date(t.date) <= end); }
                setGeneratedReport(filtered);
            };

            const handleExportReport = () => {
                if (!generatedReport || generatedReport.length === 0) return alert('No report data to export. Click Generate Export first.');
                if (selectedReportColumns.length === 0) return alert('Select at least one column.');

                const header = selectedReportColumns.map(col => col.replace(/([A-Z])/g, ' $1'));
                const rows = generatedReport.map(task => selectedReportColumns.map(col => {
                    const value = getReportCellValue(task, col);
                    const sanitized = String(value).replace(/"/g, '""');
                    return `"${sanitized}"`;
                }).join(','));

                const csv = [header.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                link.href = url;
                link.download = `mentor-ops-report-${timestamp}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const searchedPendingTasks = tasks.filter(t => {
                if (t.status !== 'Pending') return false;
                if (dashboardCategory !== 'all' && t.type !== dashboardCategory) return false;
                const searchStr = (JSON.stringify(t) + " " + JSON.stringify(t.details)).toLowerCase();
                return searchStr.includes(dashboardSearch.toLowerCase());
            });

            const visibleTabs = userProfile ? (userProfile.allowed_tabs || defaultTabs) : defaultTabs;

            if (!session) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-center">
                        <Card className="p-10 max-w-md w-full shadow-2xl">
                            <h1 className="text-4xl font-black italic tracking-tighter mb-2 dark:text-white uppercase font-bold">TEMPO</h1>
                            <p className="text-slate-500 mb-8 font-medium uppercase text-[10px] tracking-widest">Mentor Operations Center</p>
                            <form onSubmit={handleAuth} className="space-y-4 text-left font-bold">
                                {authView !== 'reset' && (
                                    <input type="email" required className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="Email" value={authEmail} onChange={e => setAuthEmail(e.target.value)} />
                                )}
                                <input type="password" required className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="••••••••" value={authPassword} onChange={e => setAuthPassword(e.target.value)} />
                                <button type="submit" disabled={authLoading} className="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase hover:bg-blue-700 shadow-xl transition-all font-bold">Sign In</button>
                            </form>
                            <div className="mt-4">
                                <div className="relative py-4"><div className="absolute inset-0 flex items-center"><span className="w-full border-t dark:border-slate-800"></span></div><div className="relative flex justify-center text-xs uppercase font-bold"><span className="bg-white dark:bg-slate-900 px-2 text-slate-400 font-bold">Or</span></div></div>
                                <button onClick={handleGoogleLogin} className="w-full flex items-center justify-center gap-3 py-3 border border-slate-200 dark:border-slate-800 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold dark:text-white">
                                    <img src="https://www.google.com/favicon.ico" className="h-4 w-4" /> Google Account
                                </button>
                            </div>
                            <div className="mt-6 pt-6 border-t dark:border-slate-800 flex flex-col gap-3 font-bold">
                                {authView === 'login' ? (
                                    <>
                                        <button onClick={() => setAuthView('signup')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter">Create account</button>
                                        <button onClick={() => setAuthView('forgot')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter">Forgot Password?</button>
                                    </>
                                ) : authView === 'signup' ? (
                                    <button onClick={() => setAuthView('login')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter">Back to login</button>
                                ) : authView === 'forgot' ? (
                                    <button onClick={() => setAuthView('login')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter">Back</button>
                                ) : <button onClick={() => setAuthView('login')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase">Back</button>}
                            </div>
                        </Card>
                    </div>
                );
            }

            if (userProfile?.error) return <div className="flex flex-col h-screen items-center justify-center font-bold gap-4 p-8 text-center">{userProfile.message} <button onClick={() => supabase.auth.signOut()} className="px-8 py-2 bg-blue-600 text-white rounded">Logout</button></div>;
            if (!userProfile) return <div className="flex h-screen items-center justify-center font-bold">Verifying authorization profile...</div>;

            // Admin Logic: Identify dropdowns belonging to the chosen task type
            const adminDropdowns = (categories[adminSelectedTaskType]?.fields || []).filter(f => ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'validHip', 'validRequest', 'emailSent', 'subscriptionStatus', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail'].includes(f));

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
                            <div className="flex items-center gap-3"><h1 className="text-xl font-bold tracking-widest uppercase italic dark:text-white">Tempo</h1><Badge color={userProfile.role === 'Admin' ? 'purple' : 'slate'}>{userProfile.role}</Badge></div>
                            <nav className="flex gap-1">{visibleTabs.map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-xs font-black rounded-lg transition-colors uppercase tracking-widest ${activeTab === tab ? 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>{tab.replace('_', ' ')}</button>))}</nav>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-slate-400 hover:text-blue-500 transition-colors">{isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-slate-200 transition-colors"><SettingsIcon className="h-5 w-5" /></button>
                                <div className={`h-2 w-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500' : 'bg-rose-500 animate-pulse'}`} />
                                <div className="text-right hidden md:block">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter leading-none dark:text-slate-500 font-bold">Identity</p>
                                    <p className="text-xs font-black leading-none dark:text-slate-200">{userProfile.email.split('@')[0]}</p>
                                </div>
                                <button onClick={() => supabase.auth.signOut()} className="p-2 text-slate-400 hover:text-rose-500 transition-colors"><LogOut className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in font-bold">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card className="p-6 bg-slate-900 text-white shadow-xl dark:border-blue-500/20"><p className="text-slate-400 text-[10px] font-black uppercase mb-1">Lifetime Records</p><h3 className="text-4xl font-bold">{tasks.length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-rose-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Pending Actions</p><h3 className="text-4xl font-bold text-rose-600">{tasks.filter(t => t.status === 'Pending').length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-emerald-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Resolved Today</p><h3 className="text-4xl font-bold text-emerald-600">{tasks.filter(t => t.status !== 'Pending' && new Date(t.date).toDateString() === new Date().toDateString()).length}</h3></Card>
                                </div>

                                {/* Task Buttons Priority above pending actions */}
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">{Object.entries(categories).map(([key, cfg]) => (<button key={key} onClick={() => { setNewTaskType(key); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="p-4 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-xl text-center hover:shadow-md transition-all group"><div className={`h-10 w-10 mx-auto rounded-lg flex items-center justify-center mb-2 bg-${cfg.color}-100 dark:bg-${cfg.color}-900/30`}>{React.createElement(cfg.icon, { className: `h-5 w-5 text-${cfg.color}-600` })}</div><p className="text-[9px] font-black text-slate-500 uppercase font-bold">{cfg.label}</p><p className="text-lg font-black dark:text-white font-bold">{tasks.filter(t => t.type === key).length}</p></button>))}</div>

                                {/* Collapsible Pending Actions Section */}
                                <Card className="overflow-hidden">
                                    <button onClick={() => setIsPendingCollapsed(!isPendingCollapsed)} className="w-full flex justify-between items-center px-6 py-4 border-b dark:border-slate-800 bg-slate-50 dark:bg-slate-800/40">
                                        <h3 className="text-sm font-black uppercase tracking-wider dark:text-slate-300">Pending Actions</h3>
                                        <span className="text-xs font-black text-slate-500">{isPendingCollapsed ? 'Expand' : 'Collapse'}</span>
                                    </button>
                                    {!isPendingCollapsed && (
                                        <>
                                            <div className="p-4 border-b dark:border-slate-800 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" /><input type="text" placeholder="Search pending by any details..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg outline-none font-bold" value={dashboardSearch} onChange={e => setDashboardSearch(e.target.value)} /></div>
                                                <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={dashboardCategory} onChange={e => setDashboardCategory(e.target.value)}><option value="all">All Types</option>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                            </div>
                                            <table className="w-full text-left text-sm font-bold">
                                                <thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700">
                                                    <tr><th className="px-6 py-3 uppercase text-[10px] font-black dark:text-slate-300">Category</th><th className="px-6 py-3 uppercase text-[10px] font-black dark:text-slate-300">Agent</th><th className="px-6 py-3 uppercase text-[10px] font-black dark:text-slate-300">Date</th><th className="px-6 py-3 text-right uppercase text-[10px] font-black dark:text-slate-300">Actions</th></tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-800">
                                                    {searchedPendingTasks.map(t => (
                                                        <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                                            <td className="px-6 py-3 dark:text-slate-200">{categories[t.type]?.label || t.type}</td>
                                                            <td className="px-6 py-3 dark:text-slate-400">{t.agent}</td>
                                                            <td className="px-6 py-3 dark:text-slate-400">{new Date(t.date).toLocaleString()}</td>
                                                            <td className="px-6 py-3 text-right">
                                                                <button onClick={() => handleEditTask(t)} className="p-2 text-slate-400 hover:text-blue-600 transition-colors"><Edit className="h-4 w-4" /></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {!searchedPendingTasks.length && (
                                                        <tr><td colSpan={4} className="px-6 py-8 text-center text-slate-400 text-xs uppercase font-black">No pending actions matched your filters.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </>
                                    )}
                                </Card>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-4 animate-fade-in font-bold">
                                <div className="flex justify-between bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 font-bold"><div className="relative flex-1 max-w-md font-bold"><Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" /><input type="text" placeholder="Search logs..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg outline-none font-bold" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div><button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-black uppercase tracking-widest font-bold">+ NEW ENTRY</button></div>
                                <Card className="overflow-hidden">
                                    <table className="w-full text-left text-sm font-bold"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 font-bold"><tr><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Category</th><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Original Agent</th><th className="px-6 py-4 dark:text-slate-300 uppercase font-black text-[10px] font-bold">Status</th><th className="px-6 py-4 text-right dark:text-slate-300 uppercase font-black text-[10px] font-bold">Actions</th></tr></thead>
                                        <tbody className="divide-y dark:divide-slate-800 font-bold">{tasks.filter(t => (categories[t.type]?.label || '').toLowerCase().includes(searchTerm.toLowerCase()) || t.agent.toLowerCase().includes(searchTerm.toLowerCase())).slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage).map(t => (<tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold"><td className="px-6 py-4 font-bold dark:text-slate-200">{categories[t.type]?.label}</td><td className="px-6 py-4 dark:text-slate-400 font-bold">{t.agent}</td><td className="px-6 py-4 font-bold"><Badge color={t.status === 'Pending' ? 'amber' : (['Resolved', 'Won', 'Activated'].includes(t.status) ? 'green' : 'slate')}>{t.status}</Badge></td><td className="px-6 py-4 text-right font-bold"><button onClick={() => handleEditTask(t)} className="p-2 text-slate-400 hover:text-blue-600 transition-colors font-bold"><Edit className="h-4 w-4" /></button></td></tr>))}</tbody>
                                    </table>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <Card className="p-6 font-bold">
                                    <div className="flex items-center gap-3 mb-6 font-bold"><BarChart3 className="h-6 w-6 text-blue-600" /><h2 className="text-xl font-bold uppercase tracking-widest dark:text-white font-bold">Analytics</h2></div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 font-bold">
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsCategory} onChange={e => setAnalyticsCategory(e.target.value)}>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsField} onChange={e => setAnalyticsField(e.target.value)}><option value="status">Status</option><option value="agent">Agent</option>{categories[analyticsCategory]?.fields.filter(f => !f.includes('Module')).map(f => <option key={f} value={f}>{f.replace(/([A-Z])/g, ' $1')}</option>)}</select>
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsDateRange.start} onChange={e => setAnalyticsDateRange(p => ({...p, start: e.target.value}))} />
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={analyticsDateRange.end} onChange={e => setAnalyticsDateRange(p => ({...p, end: e.target.value}))} />
                                    </div>
                                    <div className="h-[400px] flex items-center justify-center p-4 bg-slate-50 dark:bg-slate-800 rounded-xl relative font-bold"><canvas ref={chartRef}></canvas></div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className="space-y-6 animate-fade-in font-bold">
                                <Card className="p-6 space-y-6 font-bold">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 font-bold">
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.category} onChange={e => setReportFilters(f => ({ ...f, category: e.target.value }))}><option value="all">All Types</option>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.agent} onChange={e => setReportFilters(f => ({ ...f, agent: e.target.value }))}><option value="all">All Mentors</option>{globalMentors.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.startDate} onChange={e => setReportFilters(f => ({ ...f, startDate: e.target.value }))} />
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200 font-bold" value={reportFilters.endDate} onChange={e => setReportFilters(f => ({ ...f, endDate: e.target.value }))} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 pt-2 border-t dark:border-slate-800 border-slate-100 font-bold uppercase text-[10px] font-bold">
                                        {['type', 'agent', 'status', 'date', ...(reportFilters.category !== 'all' ? categories[reportFilters.category].fields : [])].filter(col => !col.includes('Module')).map(col => (
                                            <button key={col} onClick={() => toggleReportColumn(col)} className={`px-3 py-1.5 rounded-full border ${selectedReportColumns.includes(col) ? 'bg-blue-600 border-blue-600 text-white font-bold' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 font-bold'}`}>{col.replace(/([A-Z])/g, ' $1')}</button>
                                        ))}
                                    </div>
                                    <div className="flex justify-end gap-3 pt-2 font-bold">
                                        <button onClick={handleGenerateReport} className="px-6 py-2.5 bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white font-bold rounded-lg shadow-lg uppercase text-xs font-bold">Generate Export</button>
                                        <button onClick={handleExportReport} className="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-lg uppercase text-xs font-bold">Download CSV</button>
                                    </div>
                                    {generatedReport && (
                                        <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Generated records: {generatedReport.length}
                                        </p>
                                    )}
                                </Card>
                            </div>
                        )}

                        {activeTab === 'admin' && userProfile.role === 'Admin' && (
                            <div className="space-y-8 animate-fade-in font-bold">
                                <Card className="p-8 font-bold">
                                    <div className="flex items-center gap-3 mb-8 font-bold"><Shield className="h-6 w-6 text-indigo-600" /><h2 className="text-xl font-black uppercase dark:text-white leading-none font-bold">Admin Console</h2></div>
                                    
                                    {/* Admin Requirement: Delete Specific Entries Control */}
                                    <div className="mb-12 border-b dark:border-slate-800 pb-12 font-bold">
                                        <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">Master Entry Control</h3>
                                        <div className="overflow-x-auto max-h-64 border dark:border-slate-800 rounded-xl font-bold">
                                            <table className="w-full text-left text-[10px] font-black uppercase font-bold">
                                                <thead className="bg-slate-50 dark:bg-slate-800 text-slate-500 sticky top-0 font-bold">
                                                    <tr><th className="px-4 py-2 font-bold">Task</th><th className="px-4 py-2 font-bold">Original Agent</th><th className="px-4 py-2 font-bold">Date</th><th className="px-4 py-2 text-right font-bold">Delete</th></tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-800 font-bold">
                                                    {tasks.map(t => (
                                                        <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold">
                                                            <td className="px-4 py-3 font-bold">{categories[t.type]?.label || t.type}</td>
                                                            <td className="px-4 py-3 font-bold">{t.agent}</td>
                                                            <td className="px-4 py-3 font-bold">{new Date(t.date).toLocaleDateString()}</td>
                                                            <td className="px-4 py-3 text-right font-bold">
                                                                <button onClick={async () => { if(confirm("Permanently delete entry?")) { await supabase.from('tasks').delete().eq('id', t.id); fetchData(); } }} className="text-rose-500 hover:text-rose-700 transition-colors font-bold"><Trash className="h-4 w-4" /></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 font-bold">
                                        <div className="space-y-8 font-bold">
                                            <div className="font-bold">
                                                <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">User Registry</h3>
                                                <div className="space-y-3 max-h-[400px] overflow-auto pr-2 font-bold">
                                                    {registry.map(user => (
                                                        <div key={user.email} className="p-4 border dark:border-slate-800 rounded-xl font-bold">
                                                            <div className="flex justify-between items-center mb-2 font-bold">
                                                                <span className="text-xs font-black dark:text-white font-bold">{user.email}</span>
                                                                <Badge color={user.role === 'Admin' ? 'purple' : 'slate'}>{user.role}</Badge>
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 font-bold">
                                                                {['dashboard', 'logs', 'analytics', 'reports', 'admin'].map(t => (
                                                                    <button key={t} onClick={() => toggleTabForUser(user.email, t)} className={`px-2 py-1 rounded text-[9px] uppercase font-black ${user.allowed_tabs?.includes(t) ? 'bg-blue-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>{t}</button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-2 font-bold">
                                                    <input type="email" placeholder="new@tempo.fit" className="p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 text-sm font-bold" value={formData.newEmail || ''} onChange={e => setFormData({ ...formData, newEmail: e.target.value })} />
                                                    <select className="p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 text-sm font-bold" value={formData.newRole || 'Mentor'} onChange={e => setFormData({ ...formData, newRole: e.target.value })}><option>Mentor</option><option>Admin</option></select>
                                                    <button onClick={handleAddUser} className="bg-blue-600 text-white rounded-lg text-xs font-black uppercase tracking-wider">Add User</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-8 font-bold">
                                            <div className="font-bold">
                                                <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">Dropdown Configurator</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 font-bold">
                                                    <select className="p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 text-sm font-bold" value={adminSelectedTaskType} onChange={e => setAdminSelectedTaskType(e.target.value)}>
                                                        {Object.keys(categories).map(k => <option key={k} value={k}>{categories[k].label}</option>)}
                                                    </select>
                                                    <button onClick={() => saveGlobalConfig({ custom_options: customOptions, associates: globalAssociates, mentors: globalMentors, hip_hierarchy: globalHipHierarchy })} className="bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 rounded-lg text-xs font-black uppercase tracking-wider">Save Config</button>
                                                </div>
                                                <div className="space-y-3 max-h-[420px] overflow-auto pr-2 font-bold">
                                                    {adminDropdowns.map(field => (
                                                        <div key={field} className="p-3 border dark:border-slate-800 rounded-lg font-bold">
                                                            <div className="flex justify-between items-center mb-2 font-bold">
                                                                <h4 className="text-xs font-black uppercase text-slate-500">{field.replace(/([A-Z])/g, ' $1')}</h4>
                                                                <span className="text-[9px] text-slate-400 uppercase font-black">{(customOptions[field] || []).length} items</span>
                                                            </div>
                                                            <div className="flex flex-wrap gap-1 font-bold">
                                                                {(customOptions[field] || []).map((opt, idx) => (
                                                                    <span key={`${opt}-${idx}`} className="px-2 py-1 text-[9px] rounded bg-slate-100 dark:bg-slate-800 text-slate-500 font-black uppercase">{opt}</span>
                                                                ))}
                                                            </div>
                                                            <div className="mt-2 flex gap-2 font-bold">
                                                                <input id={`admin-${field}`} placeholder="Add option" className="flex-1 p-2 border rounded-lg text-xs dark:bg-slate-800 dark:border-slate-700 font-bold" />
                                                                <button onClick={() => {
                                                                    const el = document.getElementById(`admin-${field}`);
                                                                    if (!el.value.trim()) return;
                                                                    setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), el.value.trim()] }));
                                                                    el.value = '';
                                                                }} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase">Add</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="font-bold">
                                                <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">Associates & Mentors</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 font-bold">
                                                    <div className="p-3 border dark:border-slate-800 rounded-lg font-bold">
                                                        <h4 className="text-[10px] uppercase font-black text-slate-500 mb-2">Associates</h4>
                                                        <div className="flex flex-wrap gap-1 mb-2">{globalAssociates.map((a, idx) => <span key={`${a}-${idx}`} className="px-2 py-1 text-[9px] rounded bg-slate-100 dark:bg-slate-800 text-slate-500 font-black uppercase">{a}</span>)}</div>
                                                        <div className="flex gap-2"><input id="add-associate" className="flex-1 p-2 border rounded-lg text-xs dark:bg-slate-800 dark:border-slate-700 font-bold" /><button onClick={() => { const el = document.getElementById('add-associate'); if (!el.value.trim()) return; setGlobalAssociates(prev => [...new Set([...prev, el.value.trim()])]); el.value=''; }} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase">Add</button></div>
                                                    </div>
                                                    <div className="p-3 border dark:border-slate-800 rounded-lg font-bold">
                                                        <h4 className="text-[10px] uppercase font-black text-slate-500 mb-2">Mentors</h4>
                                                        <div className="flex flex-wrap gap-1 mb-2">{globalMentors.map((a, idx) => <span key={`${a}-${idx}`} className="px-2 py-1 text-[9px] rounded bg-slate-100 dark:bg-slate-800 text-slate-500 font-black uppercase">{a}</span>)}</div>
                                                        <div className="flex gap-2"><input id="add-mentor" className="flex-1 p-2 border rounded-lg text-xs dark:bg-slate-800 dark:border-slate-700 font-bold" /><button onClick={() => { const el = document.getElementById('add-mentor'); if (!el.value.trim()) return; setGlobalMentors(prev => [...new Set([...prev, el.value.trim()])]); el.value=''; }} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase">Add</button></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="font-bold">
                                                <h3 className="text-sm font-black uppercase text-slate-400 mb-4 font-bold">HIP Hierarchy</h3>
                                                <div className="p-3 border dark:border-slate-800 rounded-lg max-h-[240px] overflow-auto text-[10px] uppercase font-black tracking-wide">
                                                    {Object.entries(globalHipHierarchy).map(([product, cats]) => (
                                                        <div key={product} className="mb-3">
                                                            <p className="text-blue-600">{product}</p>
                                                            <ul className="pl-3 text-slate-500">
                                                                {Object.keys(cats).map(cat => <li key={cat}>• {cat}</li>)}
                                                            </ul>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        )}
                    </main>

                    <button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="fixed bottom-6 right-6 h-14 w-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-xl grid place-items-center text-2xl font-black z-30">+</button>

                    {isFormOpen && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onClick={() => { setIsFormOpen(false); setEditingTaskId(null); }} />
                            <div className="absolute right-0 top-0 h-full w-full max-w-2xl bg-white dark:bg-slate-900 shadow-2xl animate-slide-in-right overflow-auto">
                                <div className="sticky top-0 bg-white dark:bg-slate-900 border-b dark:border-slate-800 p-6 flex justify-between items-center z-10">
                                    <h2 className="text-lg font-black uppercase tracking-wider dark:text-white">{editingTaskId ? 'Edit Entry' : 'New Entry'} · {categories[newTaskType]?.label}</h2>
                                    <button onClick={() => { setIsFormOpen(false); setEditingTaskId(null); }} className="text-slate-400 hover:text-rose-500 text-2xl leading-none">&times;</button>
                                </div>
                                <form onSubmit={handleAddTask} className="p-6 space-y-6">
                                    {!editingTaskId && (
                                        <div>
                                            <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block">Type</label>
                                            <select className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium dark:text-white font-bold" value={newTaskType} onChange={e => { setNewTaskType(e.target.value); setFormData({}); }}>
                                                {Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}
                                            </select>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {categories[newTaskType].fields.map(field => {
                                            if (field === 'auditModule') return (
                                                <div key={field} className="md:col-span-2">
                                                    <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block">Audit Attributes</label>
                                                    <Card className="p-4 space-y-3">
                                                        {auditAttributes.map(attr => (
                                                            <div key={attr.id} className="flex items-center justify-between text-sm">
                                                                <div>
                                                                    <p className="font-black text-slate-700 dark:text-slate-200">{attr.title}</p>
                                                                    <p className="text-[10px] uppercase text-slate-400">{attr.desc} · {attr.weight} pts</p>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button type="button" onClick={() => handleAuditScore(attr.id, 'Yes')} className={`px-3 py-1 rounded text-[10px] font-black uppercase ${formData.auditScores?.[attr.id] === 'Yes' ? 'bg-emerald-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>Yes</button>
                                                                    <button type="button" onClick={() => handleAuditScore(attr.id, 'No')} className={`px-3 py-1 rounded text-[10px] font-black uppercase ${formData.auditScores?.[attr.id] === 'No' ? 'bg-rose-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>No</button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </Card>
                                                    <p className="text-[10px] uppercase font-black text-slate-500 mt-2">Overall Score: {formData.overallAuditScore || 0}%</p>
                                                </div>
                                            );

                                            if (field === 'correctionModule') return (
                                                <div key={field} className="md:col-span-2">
                                                    <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block">Correction Modules</label>
                                                    <Card className="p-4 space-y-3">
                                                        {quizModules.map(mod => (
                                                            <div key={mod.id} className="grid grid-cols-12 gap-2 items-center">
                                                                <div className="col-span-7">
                                                                    <p className="font-black text-sm text-slate-700 dark:text-slate-200">{mod.title}</p>
                                                                    <p className="text-[10px] uppercase text-slate-400">Max {mod.max}</p>
                                                                </div>
                                                                <input type="number" min="0" max={mod.max} className="col-span-5 p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 text-sm font-bold" value={formData.quizScores?.[mod.id] || ''} onChange={e => handleQuizScore(mod.id, e.target.value)} />
                                                            </div>
                                                        ))}
                                                    </Card>
                                                    <p className="text-[10px] uppercase font-black text-slate-500 mt-2">Overall Score: {formData.overallScore || '0.0'}</p>
                                                </div>
                                            );

                                            const isSelectField = ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'validHip', 'validRequest', 'emailSent', 'subscriptionStatus', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason', 'hipProduct', 'hipCategory', 'hipRequestType', 'status', 'pendingReasonDetail'].includes(field);

                                            return (
                                                <div key={field} className={field === 'notes' || field === 'comment' ? 'md:col-span-2' : ''}>
                                                    <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block">{field.replace(/([A-Z])/g, ' $1')}</label>
                                                    {isSelectField ? (
                                                        <div>
                                                            <select className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium dark:text-white font-bold" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)}>
                                                                <option value="">Select...</option>
                                                                {field === 'associateName' && globalAssociates.map((a, idx) => <option key={`${a}-${idx}`} value={a} font-bold>{a}</option>)}
                                                                {field === 'associateEmail' && globalAssociates.map((a, idx) => <option key={`${a}-${idx}`} value={`${a.toLowerCase()}@tempo.fit`} font-bold>{`${a.toLowerCase()}@tempo.fit`}</option>)}
                                                                {field === 'mentorName' && globalMentors.map((a, idx) => <option key={`${a}-${idx}`} value={a} font-bold>{a}</option>)}
                                                                {field === 'status' && ['Pending', 'Resolved'].map((o, idx) => <option key={`${o}-${idx}`} value={o} font-bold>{o}</option>)}
                                                                {field === 'resolution' && (newTaskType === 'pending_subs' ? ['Activated', 'Cancelled'] : newTaskType === 'disputes' ? ['Pending', 'Lost', 'Won'] : ['Pending', 'Resolved']).map((o, idx) => <option key={`${o}-${idx}`} value={o} font-bold>{o}</option>)}
                                                                {field === 'hipProduct' && Object.keys(globalHipHierarchy).map((k, idx) => <option key={`${k}-${idx}`} value={k} font-bold>{k}</option>)}
                                                                {field === 'hipCategory' && formData.hipProduct && Object.keys(globalHipHierarchy[formData.hipProduct] || {}).map((c, idx) => <option key={`${c}-${idx}`} value={c} font-bold>{c}</option>)}
                                                                {field === 'hipRequestType' && formData.hipCategory && globalHipHierarchy[formData.hipProduct][formData.hipCategory].map((o, idx) => <option key={`${o}-${idx}`} value={o} font-bold>{o}</option>)}
                                                                {field !== 'resolution' && !field.startsWith('hip') && !['associateName', 'associateEmail', 'mentorName', 'pendingReasonDetail', 'status'].includes(field) && (customOptions[field] || []).map((o, idx) => <option key={`${o}-${idx}`} value={o} font-bold>{o}</option>)}
                                                                {field === 'pendingReasonDetail' && customOptions.pendingReasonDetail.map((o, idx) => <option key={`${o}-${idx}`} value={o} font-bold>{o}</option>)}
                                                                <option value="ADD_NEW_CUSTOM" className="text-blue-600 italic font-black font-bold uppercase text-[10px] font-bold">+ Add New Item...</option>
                                                            </select>
                                                            {customInputTarget === field && (<div className="mt-2 flex gap-2 animate-fade-in font-bold"><input type="text" id={`custom-${field}`} className="flex-1 p-2 border rounded-lg outline-none bg-white dark:bg-slate-900 dark:text-white font-bold" /><button type="button" onClick={() => handleAddCustomValue(field, document.getElementById(`custom-${field}`).value)} className="px-3 bg-blue-600 text-white rounded-lg text-[10px] font-black uppercase tracking-tighter font-bold">Add</button></div>)}
                                                        </div>
                                                    ) : (<input type={field.toLowerCase().includes('date') ? 'date' : 'text'} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white font-bold font-bold" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} />)}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <button type="submit" className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest shadow-blue-100 font-bold font-bold">Commit Record Entry</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 text-slate-900 dark:text-white font-bold">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm font-bold" onClick={() => setIsSettingsOpen(false)} />
                            <Card className="relative w-full max-w-md p-8 animate-fade-in shadow-2xl font-bold font-bold">
                                <div className="flex justify-between items-center mb-6 font-bold font-bold"><h2 className="text-xl font-black uppercase tracking-tight dark:text-white font-bold font-bold">Security Center</h2><button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 font-bold text-xl font-bold font-bold font-bold">&times;</button></div>
                                <div className="space-y-6 font-bold font-bold">
                                    <div className="font-bold font-bold"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase mb-2 block font-bold font-bold">Change Password</label><input type="password" minLength="6" className="w-full p-3 border dark:border-slate-700 dark:bg-slate-800 rounded-xl outline-none font-bold dark:text-white font-bold font-bold" placeholder="New password" value={newInternalPassword} onChange={e => setNewInternalPassword(e.target.value)} /><p className="mt-2 text-[9px] text-slate-400 uppercase font-bold font-bold">Min 6 characters</p></div>
                                    <button onClick={handleUpdatePasswordInternal} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-xs font-bold font-bold font-bold">Update Password Now</button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MentorOpsCenter />);
    </script>
</body>
</html>
