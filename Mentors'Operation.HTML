<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo MentorOps | Integrated System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tempo: {
                            blue: '#2563EB',
                            dark: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        canvas {
            max-width: 100% !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://mifbpckstfwphkwtqksa.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZmJwY2tzdGZ3cGhrd3Rxa3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzcyMDksImV4cCI6MjA4NjUxMzIwOX0.PDZwE9hII9kPOjrBeJAI8T28oetruK-ogFtKOICMlOQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Core UI Components ---
        function Card({ children, className = "" }) {
            return (
                <div className={`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm ${className}`}>
                    {children}
                </div>
            );
        }

        function Badge({ children, color = "slate" }) {
            const colors = { 
                slate: "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300", 
                red: "bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400", 
                blue: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400", 
                green: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", 
                amber: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400", 
                teal: "bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400", 
                cyan: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400", 
                purple: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400", 
                emerald: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
                indigo: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400"
            };
            const selectedColor = colors[color] || colors.slate;
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${selectedColor}`}>
                    {children}
                </span>
            );
        }

        // --- Icon Components ---
        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const LayoutDashboard = (props) => <Icon {...props} path={<React.Fragment><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></React.Fragment>} />;
        const AlertCircle = (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>} />;
        const CreditCard = (props) => <Icon {...props} path={<React.Fragment><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></React.Fragment>} />;
        const Footprints = (props) => <Icon {...props} path={<React.Fragment><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.25-.79 4.33-2 6"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.25.79 4.33 2 6"/><path d="M16 17h4"/><path d="M4 13h4"/></React.Fragment>} />;
        const Gift = (props) => <Icon {...props} path={<React.Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></React.Fragment>} />;
        const UserCheck = (props) => <Icon {...props} path={<React.Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></React.Fragment>} />;
        const FileText = (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></React.Fragment>} />;
        const Search = (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>} />;
        const Edit = (props) => <Icon {...props} path={<React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></React.Fragment>} />;
        const Dice = (props) => <Icon {...props} path={<React.Fragment><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></React.Fragment>} />;
        const Plus = (props) => <Icon {...props} path={<React.Fragment><path d="M5 12h14"/><path d="M12 5v14"/></React.Fragment>} />;
        const BarChart3 = (props) => <Icon {...props} path={<React.Fragment><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></React.Fragment>} />;
        const MessageCircle = (props) => <Icon {...props} path={<React.Fragment><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></React.Fragment>} />;
        const LogOut = (props) => <Icon {...props} path={<React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></React.Fragment>} />;
        const Shield = (props) => <Icon {...props} path={<React.Fragment><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></React.Fragment>} />;
        const Trash = (props) => <Icon {...props} path={<React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></React.Fragment>} />;
        const Download = (props) => <Icon {...props} path={<React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></React.Fragment>} />;
        const ClipboardList = (props) => <Icon {...props} path={<React.Fragment><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></React.Fragment>} />;
        const Moon = (props) => <Icon {...props} path={<><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></>} />;
        const Sun = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />;
        const SettingsIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />;

        // --- Constants & Data ---
        const associateList = [ "Ariath Piol", "Job James", "Lina Hesham", "Mohab Magdy", "Marwa Ahmed", "Ramadan Philip", "Aida Clement", "Hassan Khallaf", "Nada Ashraf", "Ruben Joseph", "Esraa Tarek Eroq", "Ahmed Abdelghany", "Nour Ayman", "Ashraf Essam", "Hala Ayman", "Rania Mohamed", "Salma Ahmed", "Marwan Hassan", "Osama M. Adam", "Marwan Zakaria", "Shahd Emad", "Ahmed Nasser abdelhakim" ];
        const mentorList = [ "Noha Radwan", "Rashad Mohamed", "Emad Mohamed", "Mohamed Mounir" ];
        const defaultTabs = ['dashboard', 'logs', 'analytics', 'reports'];
        
        const auditAttributes = [
            { id: 'responsiveness', label: 'Responsiveness', weight: 10, desc: 'Mentor responsiveness metrics.' },
            { id: 'professionalism', label: 'Professionalism', weight: 10, desc: 'Mentor conduct.' },
            { id: 'clarity', label: 'Clarity', weight: 20, desc: 'Assess ability to explain clearly.' },
            { id: 'workflow', label: 'Workflow', weight: 20, desc: 'Reviews correct workflow usage.' },
            { id: 'documentation', label: 'Documentation', weight: 10, desc: 'Consistency of mentor notes.' },
            { id: 'resolution', label: 'Resolution', weight: 30, desc: 'Efficient issue resolution.' }
        ];

        const quizModules = [
            { id: 'productExpert', title: 'Product Expert', desc: 'Associate expertise demo.' },
            { id: 'processAwareness', title: 'Process Awareness', desc: 'Comprehending process vs procedures.' },
            { id: 'communication', title: 'Communication', desc: 'Reflect effectiveness in communication.' },
            { id: 'customerConcern', title: 'Identify customer Concern', desc: 'Comprehend concerns effectively.' },
            { id: 'fcr', title: 'FCR', desc: 'Was the associate able to anticipate all questions?' }
        ];

        const categories = {
            disputes: { label: 'Disputes', icon: AlertCircle, color: 'red', fields: ['customerName', 'customerEmail', 'disputeAmount', 'disputeDate', 'disputeReason', 'disputedProduct', 'disputeLink', 'resolution'] },
            pending_subs: { label: 'Pending Subs', icon: CreditCard, color: 'blue', fields: ['customerName', 'customerEmail', 'pendingReason', 'resolution'] },
            floorwalker: { label: 'FloorWalker', icon: Footprints, color: 'amber', fields: ['associateName', 'ticketLink', 'reasonForSupport', 'validRequest', 'invalidReason', 'slackLink', 'comment'] },
            hip_request: { label: 'HIP Request', icon: MessageCircle, color: 'teal', fields: ['associateName', 'ticketLink', 'slackLink', 'validHip', 'invalidReason', 'hipProduct', 'hipCategory', 'hipRequestType'] },
            weekly_quiz: { label: 'Weekly Quiz', icon: ClipboardList, color: 'cyan', fields: ['associateName', 'associateEmail', 'date', 'correctionModule'] },
            duplicate_iap: { label: 'Duplicate IAP', icon: FileText, color: 'indigo', fields: ['customerEmail', 'emailSent', 'subscriptionStatus'] },
            surprise_delight: { label: 'Surprise & Delight', icon: Gift, color: 'purple', fields: ['associateName', 'team', 'customerName', 'customerEmail', 'productType', 'ticketUrl', 'surpriseAndDelightReason', 'surpriseAndDelightType', 'amount', 'date', 'notes'] },
            mentor_audit: { label: 'Mentor Audit', icon: UserCheck, color: 'emerald', fields: ['mentorName', 'hipLogReference', 'auditModule'] },
        };

        const HIP_HIERARCHY = {
            "Move": {
                "Order Modifications": ["Change Color", "Change Address", "Upgrade", "Downgrade", "Core Modification", "Order Receipt", "Mispick"],
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Missing Items", "Damaged Unit", "DOA"],
                "Billing & Membership": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute"],
                "Payments & Offers": ["HSA/FSA", "Invoice Request", "Bundled Inquiry", "Bundled Code Applied", "Personal Training"],
                "Account Management": ["Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login", "Current Promotions"],
                "Content": ["Challenges", "Workout History", "Feedback", "Training Plan Inquiry", "Baseline Issue"],
                "Prospective": ["Purchasing Info", "Membership Requirements", "HSA/FSA Inquiry", "Referral Program", "Holiday Promotion", "Current Offers"]
            },
            "Core": {
                "Product Support": ["Android Support", "Connection Unstable", "Hardware Connection Issue", "Start Class Error", "Incomplete Class"],
                "Hardware Support": ["Physical Damage", "Standalone Availability", "Standalone Delivery Delay"],
                "Shipping": ["Missing Items", "Delayed Accessories"]
            },
            "Studio": {
                "Shipping": ["Delivery ETA", "Delivery Details", "Delivery Hold", "Failed Delivery", "Delayed Delivery", "Missing Items", "Delayed Accessories"],
                "Returns & Claims": ["Return Request", "Damaged Unit", "DOA"],
                "Order Mods": ["Change Address", "Order Receipt", "Mispick"],
                "Billing": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Refund Inquiry"]
            },
            "Accessory": {
                "Purchasing": ["Cabinet Info", "Core Standalone Availability", "Kettlebell Availability"],
                "Delivery": ["Core Standalone Delay", "Plates Delivery Delay", "Barbell Delivery Delay", "Apparel Missing Item"],
                "Quality & Damage": ["Collar Damage", "Quick Lock Damage", "Competition Plates Damage", "Barbell Damage", "Workout Mat Damage"],
                "Setup & Specs": ["Kettlebell Setup", "Folding Rack Setup", "Folding Rack Lock Issue", "Collar Specs", "HRM Replacement", "HRM Charger Replacement"]
            },
            "Membership": {
                "Account Management": ["Cancel (Immediate/Scheduled/Request/Prevented)", "Reactivate", "Pause Injury", "Refund (Inquiry/Applied)", "Billing Update", "Charges Dispute", "Contact Info Update", "Access Setup", "Change Ownership", "Add/Remove Family", "Password Reset", "Referral Inquiry", "Single Login"]
            }
        };

        // --- App implementation ---
        function MentorOpsCenter() {
            const [userProfile, setUserProfile] = useState(null);
            const [session, setSession] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [registry, setRegistry] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [newTaskType, setNewTaskType] = useState('disputes');
            const [formData, setFormData] = useState({});
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;
            
            // Auth State
            const [authView, setAuthView] = useState('login'); 
            const [authLoading, setAuthLoading] = useState(false);
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [newInternalPassword, setNewInternalPassword] = useState('');

            // Analytics State
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [analyticsCategory, setAnalyticsCategory] = useState('disputes');
            const [analyticsField, setAnalyticsField] = useState('status');
            const [analyticsDateRange, setAnalyticsDateRange] = useState({ start: '', end: '' });

            const [customOptions, setCustomOptions] = useState({
                pendingReason: ["Not delivered", "Delivered but not updated.", "Returned or canceled order"],
                disputeReason: ["Subscription claim", "Unauthorized purchase", "Defective product", "Credit not processed", "Fraud", "Subscription Cancelled", "Product Unacceptable"],
                reasonForSupport: ["SOP Guidance", "Process education", "System Navigation"],
                requestType: ["Membership", "Billing", "Account Access", "Technical Support", "Order Support"],
                invalidReason: ["Already documented in SOP", "Training issue", "Incomplete info", "Duplicate request", "Not an Ops matter"],
                team: ["T1", "Social Media", "Mentor", "Order Support", "Product Support"],
                productType: ["Studio", "Move", "Core", "Accessories", "Membership"],
                disputedProduct: ["Move", "Core", "Membership", "Accessories"],
                surpriseAndDelightReason: ["Delivery ETA", "Wrong color", "Technical issue", "SRLimited access", "Missing discount", "Compatibility", "Lack of content"],
                surpriseAndDelightType: ["Water Bottle", "Sweat Towel", "Yoga Block", "Recovery Roller", "Gift Box", "axis-performance-hat-black", "axis-performance-hat-slate-grey", "tempo-workout-gloves", "motive-training-tee-black", "motive-training-tee-1", "Pinnacle Knit Beanie"],
                validRequest: ["Yes", "No"], validHip: ["Yes", "No"], emailSent: ["Yes", "No"], subscriptionStatus: ["Active", "Cancelled"],
                hipProduct: Object.keys(HIP_HIERARCHY)
            });

            const [customInputTarget, setCustomInputTarget] = useState(null);
            const [reportFilters, setReportFilters] = useState({ category: 'all', agent: 'all', startDate: '', endDate: '' });
            const [generatedReport, setGeneratedReport] = useState(null);
            const [selectedReportColumns, setSelectedReportColumns] = useState(['type', 'agent', 'status', 'date']);

            // Theme effect
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDarkMode]);

            // Auth Implementation
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchUserProfile(session.user.email);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    setSession(session);
                    if (event === 'PASSWORD_RECOVERY') setAuthView('reset');
                    if (session) fetchUserProfile(session.user.email);
                    else setUserProfile(null);
                });
                return () => subscription.unsubscribe();
            }, []);

            const fetchUserProfile = async (email) => {
                const { data, error } = await supabase.from('users_registry').select('*').eq('email', email).single();
                if (data) {
                    setUserProfile(data);
                } else if (email === 'mohamed.abdelmagid@tempo.fit') {
                    const initial = { email, role: 'Admin', allowed_tabs: defaultTabs.concat(['admin']) };
                    await supabase.from('users_registry').insert([initial]);
                    setUserProfile(initial);
                } else {
                    setUserProfile({ error: true, message: "Unauthorized email registry." });
                }
            };

            const fetchData = async () => {
                setConnectionStatus('connecting');
                const tasksRes = await supabase.from('tasks').select('*').order('date', { ascending: false });
                if (!tasksRes.error) { 
                    setTasks(tasksRes.data || []); 
                    setConnectionStatus('online'); 
                    discoverCustomOptions(tasksRes.data || []);
                }
                if (userProfile?.role === 'Admin') {
                    const regRes = await supabase.from('users_registry').select('*');
                    if (!regRes.error) setRegistry(regRes.data || []);
                }
            };

            const discoverCustomOptions = (allTasks) => {
                setCustomOptions(prev => {
                    const newDiscovery = { ...prev };
                    allTasks.forEach(t => {
                        Object.keys(newDiscovery).forEach(key => {
                            const val = t.details?.[key];
                            if (val && !newDiscovery[key].includes(val)) newDiscovery[key].push(val);
                        });
                    });
                    return newDiscovery;
                });
            };

            useEffect(() => {
                if (userProfile && !userProfile.error) fetchData();
                const channel = supabase.channel('tasks-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, fetchData).subscribe();
                return () => supabase.removeChannel(channel);
            }, [userProfile]);

            // Handlers
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthLoading(true);
                let error = null;
                const redirectTo = window.location.origin + window.location.pathname;

                if (authView === 'login') {
                    const res = await supabase.auth.signInWithPassword({ email: authEmail, password: authPassword });
                    error = res.error;
                } else if (authView === 'signup') {
                    const res = await supabase.auth.signUp({ email: authEmail, password: authPassword, options: { emailRedirectTo: redirectTo } });
                    error = res.error;
                    if (!error) alert("Verification email sent!");
                } else if (authView === 'forgot') {
                    const res = await supabase.auth.resetPasswordForEmail(authEmail, { redirectTo: redirectTo });
                    error = res.error;
                    if (!error) alert("Reset link sent!");
                } else if (authView === 'reset') {
                    const res = await supabase.auth.updateUser({ password: authPassword });
                    error = res.error;
                    if (!error) { alert("Updated!"); setAuthView('login'); }
                }
                if (error) alert(error.message);
                setAuthLoading(false);
            };

            const handleGoogleLogin = async () => {
                const redirectTo = window.location.origin + window.location.pathname;
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: redirectTo, queryParams: { prompt: 'select_account' } }
                });
                if (error) alert(error.message);
            };

            const handleUpdatePasswordInternal = async () => {
                if (newInternalPassword.length < 6) return alert("Min 6 chars.");
                const { error } = await supabase.auth.updateUser({ password: newInternalPassword });
                if (!error) { alert("Success!"); setNewInternalPassword(''); setIsSettingsOpen(false); }
                else alert(error.message);
            };

            const handleAddUser = async () => {
                if (!formData.newEmail || !formData.newEmail.includes('@')) return alert("Enter valid email.");
                const initial = { email: formData.newEmail, role: formData.newRole || 'Mentor', allowed_tabs: defaultTabs };
                const { error } = await supabase.from('users_registry').insert([initial]);
                if (!error) { setFormData({ ...formData, newEmail: '' }); fetchData(); }
                else alert(error.message);
            };

            const toggleTabForUser = async (email, tab) => {
                const user = registry.find(u => u.email === email);
                if (!user) return;
                const currentTabs = user.allowed_tabs || [];
                const newTabs = currentTabs.includes(tab) ? currentTabs.filter(t => t !== tab) : [...currentTabs, tab];
                const { error } = await supabase.from('users_registry').update({ allowed_tabs: newTabs }).eq('email', email);
                if (!error) fetchData();
            };

            // Analytics lifecycle
            useEffect(() => {
                if (activeTab === 'analytics' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    let filteredData = tasks.filter(t => t.type === analyticsCategory);
                    if (analyticsDateRange.start) filteredData = filteredData.filter(t => new Date(t.date) >= new Date(analyticsDateRange.start));
                    if (analyticsDateRange.end) {
                        const end = new Date(analyticsDateRange.end); end.setHours(23,59,59);
                        filteredData = filteredData.filter(t => new Date(t.date) <= end);
                    }
                    const counts = {};
                    filteredData.forEach(t => {
                        let value = ['status', 'agent'].includes(analyticsField) ? t[analyticsField] : t.details?.[analyticsField] || 'N/A';
                        counts[value] = (counts[value] || 0) + 1;
                    });
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                data: Object.values(counts),
                                backgroundColor: isDarkMode ? 'rgba(37, 99, 235, 0.8)' : 'rgba(37, 99, 235, 0.7)',
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: isDarkMode ? '#334155' : '#f1f5f9' }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } },
                                x: { grid: { display: false }, ticks: { color: isDarkMode ? '#94a3b8' : '#64748b' } }
                            }
                        }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [activeTab, analyticsCategory, analyticsField, analyticsDateRange, tasks, isDarkMode]);

            // Evaluation Handlers
            const handleAuditScore = (attrId, achieved) => {
                const scores = { ...(formData.auditScores || {}), [attrId]: achieved };
                let total = 0;
                auditAttributes.forEach(attr => { if (scores[attr.id] === 'Yes') total += attr.weight; });
                setFormData(prev => ({ ...prev, auditScores: scores, overallAuditScore: total }));
            };

            const handleQuizScore = (mId, s) => {
                const scores = { ...(formData.quizScores || {}), [mId]: parseInt(s) };
                const values = Object.values(scores);
                const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '0.0';
                setFormData(prev => ({ ...prev, quizScores: scores, overallScore: avg }));
            };

            const handleAddTask = async (e) => {
                e.preventDefault();
                const requiredFields = categories[newTaskType].fields;
                const missingFields = [];
                requiredFields.forEach(f => {
                    if (f === 'correctionModule') { quizModules.forEach(m => { if (!(formData.quizScores?.[m.id])) missingFields.push(m.title); }); return; }
                    if (f === 'auditModule') { auditAttributes.forEach(a => { if (!(formData.auditScores?.[a.id])) missingFields.push(a.label); }); return; }
                    if (!['invalidReason'].includes(f) && (!formData[f] || formData[f] === '')) missingFields.push(f.replace(/([A-Z])/g, ' $1'));
                });
                if (missingFields.length > 0) return alert("Fill required: " + missingFields.join(', '));
                const taskData = { 
                    type: newTaskType, title: categories[newTaskType].label + ' Log', 
                    agent: session.user.email.split('@')[0], status: formData.status || 'Pending', 
                    details: formData, date: new Date().toISOString() 
                };
                const { error } = editingTaskId ? await supabase.from('tasks').update(taskData).eq('id', editingTaskId) : await supabase.from('tasks').insert([taskData]);
                if (!error) { setIsFormOpen(false); setFormData({}); setEditingTaskId(null); fetchData(); }
            };

            const pickRandomHIP = () => {
                const hipLogs = tasks.filter(t => t.type === 'hip_request');
                if (!hipLogs.length) return alert("No logs.");
                const r = hipLogs[Math.floor(Math.random() * hipLogs.length)];
                setFormData(p => ({ ...p, hipLogReference: r.id, auditedTicket: r.details.ticketLink, mentorName: r.agent }));
            };

            const handleInputChange = (field, value) => {
                if (value === 'ADD_NEW_CUSTOM') setCustomInputTarget(field);
                else { setFormData(prev => ({ ...prev, [field]: value })); setCustomInputTarget(null); }
            };

            const handleAddCustomValue = (field, newValue) => {
                if (!newValue.trim()) return;
                setCustomOptions(prev => ({ ...prev, [field]: [...(prev[field] || []), newValue] }));
                handleInputChange(field, newValue);
            };

            const handleEditTask = (task) => {
                setNewTaskType(task.type);
                setFormData({ ...(task.details || {}), status: task.status });
                setEditingTaskId(task.id);
                setIsFormOpen(true);
            };

            const handleGenerateReport = () => {
                let filtered = tasks;
                if (reportFilters.category !== 'all') filtered = filtered.filter(t => t.type === reportFilters.category);
                if (reportFilters.agent !== 'all') filtered = filtered.filter(t => t.agent === reportFilters.agent);
                if (reportFilters.startDate) filtered = filtered.filter(t => new Date(t.date) >= new Date(reportFilters.startDate));
                if (reportFilters.endDate) { const end = new Date(reportFilters.endDate); end.setHours(23,59,59); filtered = filtered.filter(t => new Date(t.date) <= end); }
                setGeneratedReport(filtered);
            };

            const downloadCSV = () => {
                if (!generatedReport) return;
                const csv = [selectedReportColumns.map(c => c.toUpperCase()).join(','), ...generatedReport.map(t => {
                    return selectedReportColumns.map(c => {
                        const val = ['id','type','agent','status','date'].includes(c) ? (c === 'date' ? new Date(t[c]).toLocaleDateString() : t[c]) : (t.details?.[c] || 'N/A');
                        return `"${val.toString().replace(/"/g, '""')}"`;
                    }).join(',');
                })].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'export.csv'; a.click();
            };

            const toggleReportColumn = (col) => {
                setSelectedReportColumns(prev => prev.includes(col) ? prev.filter(c => c !== col) : [...prev, col]);
            };

            if (!session) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-center">
                        <Card className="p-10 max-w-md w-full shadow-2xl">
                            <h1 className="text-4xl font-black italic tracking-tighter mb-2 dark:text-white">TEMPO</h1>
                            <p className="text-slate-500 mb-8 font-medium uppercase text-[10px] tracking-widest">Mentor Operations Center</p>
                            <form onSubmit={handleAuth} className="space-y-4 text-left">
                                {authView !== 'reset' && (
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block">Email</label>
                                        <input type="email" required className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="user@tempo.fit" value={authEmail} onChange={e => setAuthEmail(e.target.value)} />
                                    </div>
                                )}
                                {authView !== 'forgot' && (
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block">{authView === 'reset' ? 'New Password' : 'Password'}</label>
                                        <input type="password" required minLength="6" className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="••••••••" value={authPassword} onChange={e => setAuthPassword(e.target.value)} />
                                    </div>
                                )}
                                <button type="submit" disabled={authLoading} className="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase tracking-widest hover:bg-blue-700 shadow-xl transition-all disabled:opacity-50">
                                    {authLoading ? '...' : (authView === 'login' ? 'Sign In' : authView === 'signup' ? 'Register' : authView === 'forgot' ? 'Send Link' : 'Update')}
                                </button>
                            </form>
                            {authView === 'login' && (
                                <div className="mt-4">
                                    <div className="relative py-4"><div className="absolute inset-0 flex items-center"><span className="w-full border-t dark:border-slate-800"></span></div><div className="relative flex justify-center text-xs uppercase font-bold"><span className="bg-white dark:bg-slate-900 px-2 text-slate-400">Or</span></div></div>
                                    <button onClick={handleGoogleLogin} className="w-full flex items-center justify-center gap-3 py-3 border border-slate-200 dark:border-slate-800 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold dark:text-white">
                                        <img src="https://www.google.com/favicon.ico" className="h-4 w-4" /> Google Account
                                    </button>
                                </div>
                            )}
                            <div className="mt-6 pt-6 border-t dark:border-slate-800 flex flex-col gap-3">
                                {authView === 'login' ? (
                                    <><button onClick={() => setAuthView('signup')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase transition-colors">First Time? Register</button>
                                    <button onClick={() => setAuthView('forgot')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-tighter transition-colors">Forgot Password?</button></>
                                ) : <button onClick={() => setAuthView('login')} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase transition-colors">Back</button>}
                            </div>
                        </Card>
                    </div>
                );
            }

            if (userProfile?.error) return <div className="flex flex-col h-screen items-center justify-center font-bold gap-4 p-8 text-center">{userProfile.message} <button onClick={() => supabase.auth.signOut()} className="px-8 py-2 bg-blue-600 text-white rounded">Logout</button></div>;
            if (!userProfile) return <div className="flex h-screen items-center justify-center font-bold">Verifying authorization profile...</div>;

            const visibleTabs = userProfile.allowed_tabs || defaultTabs;

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
                            <div className="flex items-center gap-3"><h1 className="text-xl font-bold tracking-widest uppercase italic dark:text-white">Tempo</h1><Badge color={userProfile.role === 'Admin' ? 'purple' : 'slate'}>{userProfile.role}</Badge></div>
                            <nav className="flex gap-1">{visibleTabs.map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-xs font-black rounded-lg transition-colors uppercase tracking-widest ${activeTab === tab ? 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>{tab}</button>))}</nav>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-slate-400 hover:text-blue-500 transition-colors">{isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-slate-200 transition-colors"><SettingsIcon className="h-5 w-5" /></button>
                                <div className={`h-2 w-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500' : 'bg-rose-500 animate-pulse'}`} />
                                <div className="text-right hidden md:block">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter leading-none dark:text-slate-500">Identity</p>
                                    <p className="text-xs font-black leading-none dark:text-slate-200">{userProfile.email.split('@')[0]}</p>
                                </div>
                                <button onClick={() => supabase.auth.signOut()} className="p-2 text-slate-400 hover:text-rose-500 transition-colors"><LogOut className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card className="p-6 bg-slate-900 text-white shadow-xl dark:border-blue-500/20"><p className="text-slate-400 text-[10px] font-black uppercase mb-1">Total Logs</p><h3 className="text-4xl font-bold">{tasks.length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-rose-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Pending Follow-ups</p><h3 className="text-4xl font-bold text-rose-600">{tasks.filter(t => t.status === 'Pending').length}</h3></Card>
                                    <Card className="p-6 border-l-4 border-l-emerald-500"><p className="text-slate-400 dark:text-slate-500 text-[10px] font-black uppercase mb-1">Resolved Today</p><h3 className="text-4xl font-bold text-emerald-600">{tasks.filter(t => t.status !== 'Pending' && new Date(t.date).toDateString() === new Date().toDateString()).length}</h3></Card>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">{Object.entries(categories).map(([key, cfg]) => (<button key={key} onClick={() => { setNewTaskType(key); setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="p-4 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-xl text-center hover:shadow-md transition-all group"><div className={`h-10 w-10 mx-auto rounded-lg flex items-center justify-center mb-2 bg-${cfg.color}-100 dark:bg-${cfg.color}-900/30`}>{React.createElement(cfg.icon, { className: `h-5 w-5 text-${cfg.color}-600` })}</div><p className="text-[9px] font-black text-slate-500 uppercase">{cfg.label}</p><p className="text-lg font-black dark:text-white">{tasks.filter(t => t.type === key).length}</p></button>))}</div>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex justify-between bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800"><div className="relative flex-1 max-w-md"><Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" /><input type="text" placeholder="Search..." className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div><button onClick={() => { setEditingTaskId(null); setFormData({}); setIsFormOpen(true); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-black uppercase tracking-widest">+ NEW ENTRY</button></div>
                                <Card className="overflow-hidden">
                                    <table className="w-full text-left text-sm"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700"><tr><th className="px-6 py-4 dark:text-slate-300">Category</th><th className="px-6 py-4 dark:text-slate-300">Agent</th><th className="px-6 py-4 dark:text-slate-300">Status</th><th className="px-6 py-4 text-right dark:text-slate-300">Actions</th></tr></thead>
                                        <tbody className="divide-y dark:divide-slate-800">{tasks.filter(t => (categories[t.type]?.label || '').toLowerCase().includes(searchTerm.toLowerCase()) || t.agent.toLowerCase().includes(searchTerm.toLowerCase())).slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage).map(t => (<tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50"><td className="px-6 py-4 font-bold dark:text-slate-200">{categories[t.type]?.label}</td><td className="px-6 py-4 dark:text-slate-400">{t.agent}</td><td className="px-6 py-4"><Badge color={t.status === 'Pending' ? 'amber' : (['Resolved', 'Won', 'Activated'].includes(t.status) ? 'green' : 'slate')}>{t.status}</Badge></td><td className="px-6 py-4 text-right"><button onClick={() => handleEditTask(t)} className="p-2 text-slate-400 hover:text-blue-600 transition-colors"><Edit className="h-4 w-4" /></button></td></tr>))}</tbody>
                                    </table>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6 animate-fade-in">
                                <Card className="p-6">
                                    <div className="flex items-center gap-3 mb-6"><BarChart3 className="h-6 w-6 text-blue-600" /><h2 className="text-xl font-bold uppercase tracking-widest dark:text-white">Analytics</h2></div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200" value={analyticsCategory} onChange={e => setAnalyticsCategory(e.target.value)}>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200" value={analyticsField} onChange={e => setAnalyticsField(e.target.value)}><option value="status">Status</option><option value="agent">Agent</option>{categories[analyticsCategory]?.fields.filter(f => !f.includes('Module')).map(f => <option key={f} value={f}>{f.replace(/([A-Z])/g, ' $1')}</option>)}</select>
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200" value={analyticsDateRange.start} onChange={e => setAnalyticsDateRange(p => ({...p, start: e.target.value}))} />
                                        <input type="date" className="p-2.5 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm outline-none dark:text-slate-200" value={analyticsDateRange.end} onChange={e => setAnalyticsDateRange(p => ({...p, end: e.target.value}))} />
                                    </div>
                                    <div className="h-[400px] flex items-center justify-center p-4 bg-slate-50 dark:bg-slate-800 rounded-xl relative"><canvas ref={chartRef}></canvas></div>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div className="space-y-6 animate-fade-in">
                                <Card className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200" value={reportFilters.category} onChange={e => setReportFilters(f => ({ ...f, category: e.target.value }))}><option value="all">All Types</option>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select>
                                        <select className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200" value={reportFilters.agent} onChange={e => setReportFilters(f => ({ ...f, agent: e.target.value }))}><option value="all">All Mentors</option>{mentorList.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200" value={reportFilters.startDate} onChange={e => setReportFilters(f => ({ ...f, startDate: e.target.value }))} />
                                        <input type="date" className="w-full p-2.5 border dark:border-slate-700 dark:bg-slate-800 rounded-lg text-sm outline-none dark:text-slate-200" value={reportFilters.endDate} onChange={e => setReportFilters(f => ({ ...f, endDate: e.target.value }))} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 pt-2 border-t dark:border-slate-800 border-slate-100">{['agent', 'status', 'date', ...(reportFilters.category !== 'all' ? categories[reportFilters.category].fields : [])].filter(col => !col.includes('Module')).map(col => (<button key={col} onClick={() => toggleReportColumn(col)} className={`px-3 py-1.5 rounded-full text-[10px] font-bold border ${selectedReportColumns.includes(col) ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 uppercase'}`}>{col.replace(/([A-Z])/g, ' $1')}</button>))}</div>
                                    <div className="flex justify-end pt-2"><button onClick={handleGenerateReport} className="px-6 py-2.5 bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white font-bold rounded-lg shadow-lg uppercase text-xs">Generate CSV Export</button></div>
                                </Card>
                                {generatedReport && (
                                    <div className="space-y-4 animate-fade-in"><div className="flex justify-between items-center"><h3 className="font-bold dark:text-slate-200">Results ({generatedReport.length})</h3><button onClick={downloadCSV} className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg text-sm font-bold dark:text-slate-200"><Download className="h-4 w-4" /> Download CSV</button></div>
                                        <Card className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700"><tr>{selectedReportColumns.map(c => <th key={c} className="px-6 py-3 uppercase text-[10px] font-black dark:text-slate-400">{c.replace(/([A-Z])/g, ' $1')}</th>)}</tr></thead>
                                            <tbody className="divide-y dark:divide-slate-800">{generatedReport.map(r => (<tr key={r.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">{selectedReportColumns.map(c => <td key={c} className="px-6 py-4 truncate max-w-xs text-xs dark:text-slate-300">{['id','type','agent','status','date'].includes(c) ? (c === 'date' ? new Date(r[c]).toLocaleDateString() : r[c]) : (r.details?.[c] || 'N/A')}</td>)}</tr>))}</tbody>
                                        </table></Card></div>
                                )}
                            </div>
                        )}

                        {activeTab === 'admin' && userProfile.role === 'Admin' && (
                            <div className="space-y-8 animate-fade-in">
                                <Card className="p-8"><div className="flex items-center gap-3 mb-6"><Shield className="h-6 w-6 text-indigo-600" /><h2 className="text-xl font-black uppercase tracking-tight dark:text-white">Admin Control Panel</h2></div>
                                    <div className="flex gap-4 mb-10 bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-dashed dark:border-slate-700">
                                        <input type="email" placeholder="tempo.fit email" className="flex-1 p-3 border dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 bg-white font-bold" onChange={e => setFormData(p => ({...p, newEmail: e.target.value}))} value={formData.newEmail || ''} />
                                        <select className="p-3 border dark:border-slate-700 dark:bg-slate-900 dark:text-white rounded-xl outline-none bg-white font-bold" onChange={e => setFormData(p => ({...p, newRole: e.target.value}))} value={formData.newRole || 'Mentor'}><option value="Mentor">Mentor</option><option value="Admin">Admin</option></select>
                                        <button onClick={handleAddUser} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-xs hover:bg-indigo-700 transition-all shadow-xl">Authorize Email</button>
                                    </div>
                                    <div className="overflow-x-auto text-xs font-black uppercase"><table className="w-full text-left"><thead className="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 text-slate-400"><tr><th className="px-6 py-4">User</th><th className="px-6 py-4">Role</th><th className="px-6 py-4 text-center">Tabs</th><th className="px-6 py-4"></th></tr></thead>
                                            <tbody className="divide-y dark:divide-slate-800">{registry.map(u => (<tr key={u.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 text-center">
                                                    <td className="px-6 py-4 lowercase font-bold text-slate-600 dark:text-slate-400">{u.email}</td>
                                                    <td className="px-6 py-4"><Badge color={u.role === 'Admin' ? 'purple' : 'slate'}>{u.role}</Badge></td>
                                                    <td className="px-6 py-4 flex gap-2 justify-center">
                                                        {['dashboard', 'logs', 'analytics', 'reports'].map(t => (
                                                            <label key={t} className="flex items-center gap-1.5 cursor-pointer bg-white dark:bg-slate-800 px-2 py-1 border dark:border-slate-700 rounded shadow-sm hover:border-blue-400 transition-all">
                                                                <input type="checkbox" checked={u.allowed_tabs?.includes(t)} onChange={() => toggleTabForUser(u.email, t)} />
                                                                <span className="text-[9px] dark:text-slate-400">{t}</span>
                                                            </label>
                                                        ))}
                                                    </td>
                                                    <td className="px-6 py-4 text-right">{u.email !== 'mohamed.abdelmagid@tempo.fit' && <button onClick={async () => { if(confirm("Revoke access?")) { await supabase.from('users_registry').delete().eq('id', u.id); fetchData(); } }} className="text-rose-400 transition-colors"><Trash className="h-4 w-4" /></button>}</td>
                                                </tr>))}</tbody></table></div></Card>
                            </div>
                        )}
                    </main>

                    {/* Form Modal */}
                    {isFormOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setIsFormOpen(false)} />
                            <div className="relative w-full max-w-md bg-white dark:bg-slate-900 h-full shadow-2xl p-8 overflow-y-auto animate-slide-in-right">
                                <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-black italic uppercase tracking-tighter dark:text-white leading-tight">{editingTaskId ? 'EDIT' : 'NEW'} {categories[newTaskType].label}</h2><button onClick={() => setIsFormOpen(false)} className="text-slate-400 font-black uppercase text-[10px] hover:text-slate-800 dark:hover:text-white transition-colors">Close</button></div>
                                <form onSubmit={handleAddTask} className="space-y-6">
                                    {!editingTaskId && <div><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-2 block">Category Type</label><select className="w-full p-3 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none font-bold dark:text-white" value={newTaskType} onChange={e => { setNewTaskType(e.target.value); setFormData({}); }}>{Object.entries(categories).map(([k, c]) => <option key={k} value={k}>{c.label}</option>)}</select></div>}
                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border dark:border-slate-700 space-y-4">
                                        {categories[newTaskType].fields.map(field => {
                                            const isValidNo = (newTaskType === 'floorwalker' && formData.validRequest === 'No') || (newTaskType === 'hip_request' && formData.validHip === 'No');
                                            if (field === 'invalidReason' && !isValidNo) return null;
                                            if (field === 'auditModule' || field === 'correctionModule') {
                                                const items = field === 'auditModule' ? auditAttributes : quizModules;
                                                return (<div key={field} className="space-y-6 pt-2">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <h3 className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">{field.replace('Module','')} Evaluation</h3>
                                                            {field === 'correctionModule' && <Badge color="cyan">AVG: {formData.overallScore || '0.0'}</Badge>}
                                                            {field === 'auditModule' && <Badge color="green">Result: {formData.overallAuditScore || '0'}%</Badge>}
                                                        </div>
                                                        {items.map(m => (<div key={m.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm"><p className="font-bold text-sm mb-1 dark:text-slate-200">{m.title || m.label}</p><p className="text-[10px] text-slate-400 mb-4">{m.desc}</p>
                                                                <div className="flex justify-center gap-2 mb-4">
                                                                    {field === 'auditModule' ? ['Yes', 'No'].map(s => (<button key={s} type="button" onClick={() => handleAuditScore(m.id, s)} className={`px-4 py-1.5 rounded-lg border-2 text-[10px] font-black transition-all ${formData.auditScores?.[m.id] === s ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white dark:bg-slate-800 dark:border-slate-700 text-slate-400'}`}>{s.toUpperCase()}</button>)) : [1, 2, 3, 4, 5].map(s => (<button key={s} type="button" onClick={() => handleQuizScore(m.id, s)} className={`w-8 h-8 rounded-full border-2 text-xs font-bold transition-all ${formData.quizScores?.[m.id] === s ? 'bg-cyan-500 border-cyan-500 text-white shadow-lg shadow-cyan-100' : 'bg-white dark:bg-slate-800 dark:border-slate-700 text-slate-400'}`}>{s}</button>))}
                                                                </div><input type="text" placeholder="Detail feedback..." className="w-full p-2 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 text-[10px] outline-none dark:text-white" onChange={e => setFormData(p => ({...p, quizComments: {...(p.quizComments || {}), [m.id]: e.target.value}}))} value={formData.quizComments?.[m.id] || ''} /></div>))}</div>);
                                            }
                                            if (field === 'hipLogReference' && newTaskType === 'mentor_audit') return (<div key={field} className="pt-2"><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase block mb-1.5">Audit Target</label><div className="flex gap-2"><div className="flex-1 p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl text-sm font-medium dark:text-slate-300">{formData.auditedTicket || 'No Log Selected'}</div><button type="button" onClick={pickRandomHIP} className="p-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-xl hover:bg-blue-200 transition-colors"><Dice className="h-5 w-5" /></button></div></div>);
                                            
                                            const isDropdown = ['associateName', 'associateEmail', 'mentorName', 'team', 'productType', 'surpriseAndDelightType', 'resolution', 'pendingReason', 'disputeReason', 'reasonForSupport', 'requestType', 'validHip', 'validRequest', 'subscriptionStatus', 'emailSent', 'disputedProduct', 'invalidReason', 'surpriseAndDelightReason', 'hipProduct', 'hipCategory', 'hipRequestType'].includes(field);
                                            return (<div key={field}><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1.5 block">{field.replace(/([A-Z])/g, ' $1')}</label>
                                                    {isDropdown ? (<div className="space-y-2"><select className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white" value={formData[field] || ''} onChange={e => { if(field === 'hipProduct') setFormData(p=>({...p, hipProduct:e.target.value, hipCategory:'', hipRequestType:''})); else if(field === 'hipCategory') setFormData(p=>({...p, hipCategory:e.target.value, hipRequestType:''})); else handleInputChange(field, e.target.value);}}><option value="">Select...</option>
                                                                {(field === 'associateName' || field === 'associateEmail') && associateList.map(a => <option key={a} value={a}>{a}</option>)}
                                                                {field === 'mentorName' && mentorList.map(a => <option key={a} value={a}>{a}</option>)}
                                                                {field === 'resolution' && (newTaskType === 'pending_subs' ? ['Activated', 'Cancelled'] : newTaskType === 'disputes' ? ['Pending', 'Lost', 'Won'] : ['Pending', 'Resolved']).map(o => <option key={o} value={o}>{o}</option>)}
                                                                {field === 'hipProduct' && Object.keys(HIP_HIERARCHY).map(k => <option key={k} value={k}>{k}</option>)}
                                                                {field === 'hipCategory' && formData.hipProduct && Object.keys(HIP_HIERARCHY[formData.hipProduct] || {}).map(c => <option key={c} value={c}>{c}</option>)}
                                                                {field === 'hipRequestType' && formData.hipCategory && HIP_HIERARCHY[formData.hipProduct][formData.hipCategory].map(o => <option key={o} value={o}>{o}</option>)}
                                                                {field !== 'resolution' && !field.startsWith('hip') && customOptions[field]?.map(o => <option key={o} value={o}>{o}</option>)}
                                                                <option value="ADD_NEW_CUSTOM" className="text-blue-600 font-bold">+ Add New Item...</option>
                                                            </select>
                                                            {customInputTarget === field && (<div className="flex gap-2 animate-fade-in"><input type="text" id={`custom-${field}`} placeholder={`New value...`} className="flex-1 p-2 text-xs border rounded-lg outline-none bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white" /><button type="button" onClick={() => handleAddCustomValue(field, document.getElementById(`custom-${field}`).value)} className="px-4 py-2 bg-blue-600 text-white text-[10px] font-bold rounded-lg uppercase">Add</button></div>)}</div>) 
                                                    : (<input type={field.toLowerCase().includes('date') ? 'date' : 'text'} className="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500 dark:text-white" value={formData[field] || ''} onChange={e => handleInputChange(field, e.target.value)} />)}</div>);
                                        })}
                                    </div>
                                    <button type="submit" className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest shadow-blue-100">Commit Record Entry</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Security Center Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 text-slate-900 dark:text-white">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setIsSettingsOpen(false)} />
                            <Card className="relative w-full max-w-md p-8 animate-fade-in shadow-2xl">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black uppercase tracking-tight dark:text-white">Security Center</h2><button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 font-bold text-xl">&times;</button></div>
                                <div className="space-y-6">
                                    <div><label className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase mb-2 block">Change Password</label><input type="password" minLength="6" className="w-full p-3 border dark:border-slate-700 dark:bg-slate-800 rounded-xl outline-none font-bold dark:text-white" placeholder="New password" value={newInternalPassword} onChange={e => setNewInternalPassword(e.target.value)} /><p className="mt-2 text-[9px] text-slate-400 uppercase">Min 6 characters</p></div>
                                    <button onClick={handleUpdatePasswordInternal} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-xs shadow-lg shadow-blue-100 transition-all hover:bg-blue-700">Update Password Now</button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MentorOpsCenter />);
    </script>
</body>
</html>
